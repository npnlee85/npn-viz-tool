/*
 * Regs-Dot-Gov-Directives
 * Version: 0.1.0 - 2015-03-13
 */
angular.module("npn-viz-tool.vis-calendar",["npn-viz-tool.vis","npn-viz-tool.filter","npn-viz-tool.filters","ui.bootstrap"]).controller("CalendarVisCtrl",["$scope","$modalInstance","$http","$timeout","$filter","FilterService","ChartService",function(a,b,c,d,e,f,g){function h(){return angular.extend({},a.selection.toPlot,{color:a.selection.color})}function i(a){var b=-1*(u.rangeBand()/2+8);a.selectAll("text").attr("x",0).attr("dy",b)}function j(a){return l&&a<l.length&&l[a].LABEL?l[a].LABEL:""}function k(){if(l){t.scale(r),m.selectAll("g .x.axis").call(t),u.rangeBands([q.height,0],.5,.5),u.domain(d3.range(0,l.length)),v.scale(u),m.selectAll("g .y.axis").call(v).call(i),console.log("y.rangeBand()",u.rangeBand());var b=r.domain()[0],c=b.getTime(),d=u.rangeBand()/2;console.log("dayOne",b),console.log("x.domain",r.domain()),console.log("y.domain",u.domain());var e=m.selectAll(".in-phase").data(l);e.exit().remove(),e.enter().append("line").attr("class","in-phase"),e.attr("data-legend",function(a){return a.legend}).attr("data-legend-color",function(b){return a.colorScale(b.color)}).attr("x1",function(a){return r(a.FIRST_DOY?new Date(c+a.FIRST_DOY*g.ONE_DAY_MILLIS):b)}).attr("y1",function(a,b){return u(b)+d}).attr("x2",function(a){return r(a.LAST_DOY?new Date(c+a.LAST_DOY*g.ONE_DAY_MILLIS):b)}).attr("y2",function(a,b){return u(b)+d}).attr("stroke",function(b){return a.colorScale(b.color)}).attr("stroke-width",u.rangeBand())}}var l,m,n=f.getFilter().getDateArg(),o=n.arg.start_date,p=(new Date(o,0),n.arg.end_date),q=g.getSizeInfo({top:30,right:30,bottom:30,left:30}),r=d3.time.scale().range([0,q.width]).domain([new Date(o,0,1),new Date(o,12,31)]).nice(0),s=d3.time.format("%B"),t=d3.svg.axis().scale(r).ticks(d3.time.months).orient("bottom").tickFormat(function(a){return s(a)}),u=d3.scale.ordinal().rangeBands([q.height,0]).domain(d3.range(0,6)),v=d3.svg.axis().scale(u).orient("right").tickSize(q.width).tickFormat(function(a){return a}).tickFormat(j);a.modal=b,a.colorScale=d3.scale.category20(),a.colors=new Array(20),a.selection={color:0},a.plottable=[],angular.forEach(f.getFilter().getSpeciesArgs(),function(b){angular.forEach(b.phenophases,function(c){a.plottable.push(angular.extend({},b.arg,c))})}),a.toPlot=[],1>=p-o?a.selection.start_year=o:(a.availableYears=d3.range(o,p),console.log("availableYears")),a.$watch("selection.start_year",function(){a.selection.start_year&&(r.domain([new Date(a.selection.start_year,0,1),new Date(a.selection.start_year,12,13)]),a.selection.end_year=p>a.selection.start_year?a.selection.start_year+1:p)}),a.canAddToPlot=function(){if(!a.selection.toPlot)return!1;if(0===a.toPlot.length)return!0;var b,c=h();for(b=0;b<a.toPlot.length;b++)if(angular.equals(a.toPlot[b],c))return!1;for(b=0;b<a.toPlot.length;b++)if(c.color===a.toPlot[b].color)return!1;return!0},d(function(){m=d3.select(".chart").attr("width",q.width+q.margin.left+q.margin.right).attr("height",q.height+q.margin.top+q.margin.bottom).append("g").attr("transform","translate("+q.margin.left+","+q.margin.top+")"),m.append("g").attr("class","x axis").attr("transform","translate(0,"+q.height+")").call(t),m.append("g").attr("class","y axis").call(v).call(i)},500),a.addToPlot=function(){a.selection.toPlot&&(a.toPlot.push(h()),a.selection.color++,l=void 0)},a.removeFromPlot=function(b){a.toPlot.splice(b,1),l=void 0},a.visualize=function(){if(l)return k();console.log("visualize",a.selection.axis,a.toPlot);var b=(f.getFilter().getDateArg(),{request_src:"npn-vis-cealendar",start_date:a.selection.start_year+"-01-01",end_date:a.selection.end_year+"-12-31"}),d=0,h={};angular.forEach(a.toPlot,function(a){h[a.species_id+"."+a.phenophase_id]=a.color,b["species_id["+d+"]"]=a.species_id,b["phenophase_id["+d++ +"]"]=a.phenophase_id}),c.get("/npn_portal/observations/getSummarizedData.json",{params:b}).success(function(b){b=b.filter(g.filterSuspectSummaryData);var c=d3.range(a.selection.start_year,a.selection.end_year+1),d=[],f=[];console.log("years",c),1===a.toPlot.length?d.push(b):angular.forEach(a.toPlot,function(a){d.push(b.filter(function(b){return a.species_id==b.species_id&&a.phenophase_id==b.phenophase_id}))}),console.log("sets",d),angular.forEach(d,function(b,d){var g=a.toPlot[d];angular.forEach(c,function(a){var c=b.filter(function(b){return a===b.first_yes_year&&a===b.last_yes_year});console.log("year_set",c),f.push(angular.extend({LABEL:e("speciesTitle")(g)+"/"+g.phenophase_name+" ("+a+")",FIRST_DOY:d3.min(c,function(a){return a.first_yes_doy}),LAST_DOY:d3.max(c,function(a){return a.last_yes_doy})},g))})}),l=f.reverse(),console.log("calendar data",l),k()})}}]),angular.module("npn-viz-tool.filter",["npn-viz-tool.settings","isteven-multi-select"]).factory("FilterArg",[function(){var a=function(a){this.arg=a};return a.prototype.getArg=function(){return this.arg},a.prototype.$filter=function(){return!0},a}]).factory("DateFilterArg",["FilterArg",function(a){var b=function(b){b&&(b.start_date&&"number"!=typeof b.start_date&&(b.start_date=parseInt(b.start_date)),b.end_date&&"number"!=typeof b.end_date&&(b.end_date=parseInt(b.end_date))),a.apply(this,arguments)};return b.prototype.getId=function(){return"date"},b.prototype.getStartDate=function(){return this.arg.start_date+"-01-01"},b.prototype.getEndDate=function(){return this.arg.end_date+"-12-31"},b.prototype.toString=function(){return this.arg.start_date+"-"+this.arg.end_date},b.fromString=function(a){var c=a.indexOf("-");return new b({start_date:a.substring(0,c),end_date:a.substring(c+1)})},b}]).factory("SpeciesFilterArg",["$http","$rootScope","FilterArg",function(a,b,c){var d=function(d,e){c.apply(this,arguments),this.counts={station:"?",observation:"?"},e&&"*"!=e&&(this.phenophaseSelections=e.split(","));var f=this;a.get("/npn_portal/phenophases/getPhenophasesForSpecies.json",{params:{return_all:!0,species_id:f.arg.species_id}}).success(function(a){var c={};f.phenophases=a[0].phenophases.filter(function(a){return c[a.phenophase_id]?!1:(c[a.phenophase_id]=a,a.selected=!f.phenophaseSelections||-1!=f.phenophaseSelections.indexOf(a.phenophase_id),!0)}),f.phenophasesMap={},angular.forEach(f.phenophases,function(a){f.phenophasesMap[a.phenophase_id]=a}),b.$broadcast("species-filter-ready",{filter:f})})};return d.prototype.getId=function(){return parseInt(this.arg.species_id)},d.prototype.resetCounts=function(a){this.counts.station=this.counts.observation=a,angular.forEach(this.phenophases,function(a){a.count=0})},d.prototype.$filter=function(a){var b=this,c=0;a.species_id!=b.arg.species_id&&console.warn("$filter called on wrong species",b.arg,a);var d=a.phenophases.filter(function(a){return b.phenophasesMap[a.phenophase_id].count++,b.phenophasesMap[a.phenophase_id].selected&&c++,b.phenophasesMap[a.phenophase_id].selected});return d.length>0&&b.counts.station++,b.counts.observation+=c,c},d.prototype.toString=function(){var a=this.arg.species_id+":",b=this.phenophases.filter(function(a){return a.selected});return b.length===this.phenophases.length?a+="*":b.forEach(function(b,c){a+=(c>0?",":"")+b.phenophase_id}),a},d.fromString=function(b){var c=b.indexOf(":"),e=b.substring(0,c),f=b.substring(c+1);return a.get("/npn_portal/species/getSpeciesById.json",{params:{species_id:e}}).then(function(a){return a.data.species_id=e,new d(a.data,f)})},d}]).factory("GeoFilterArg",["FilterArg",function(a){function b(a,c){var d,e,f,g=c.getType();if("Polygon"==g)return d=new google.maps.Polygon({paths:c.getArray()[0].getArray()}),google.maps.geometry.poly.containsLocation(a,d)||google.maps.geometry.poly.isLocationOnEdge(a,d);if("MultiPolygon"===g||"GeometryCollection"==g)for(e=c.getArray(),f=0;f<e.length;f++)if(b(a,e[f]))return!0;return!1}var c=function(b,c){a.apply(this,arguments),this.sourceId=c};return c.prototype.getId=function(){return this.arg.getProperty("NAME")},c.prototype.getSourceId=function(){return this.sourceId},c.prototype.$filter=function(a){return b(new google.maps.LatLng(parseFloat(a.latitude),parseFloat(a.longitude)),this.arg.getGeometry())},c.prototype.toString=function(){return this.sourceId+":"+this.arg.getProperty("NAME")},c}]).factory("NpnFilter",["DateFilterArg","SpeciesFilterArg","GeoFilterArg",function(a,b,c){function d(a){var b,c=[];for(b in a)c.push(a[b]);return c}var e=function(){this.reset()};return e.prototype.hasDate=function(){return!!this.date},e.prototype.hasCriteria=function(){return this.date?!0:Object.keys(this.species).length>0},e.prototype.hasSufficientCriteria=function(){return this.date&&Object.keys(this.species).length>0},e.prototype.getUpdateCount=function(){return this.updateCount},e.prototype.getDateArg=function(){return this.date},e.prototype.getSpeciesArg=function(a){return this.species[a]},e.prototype.getSpeciesArgs=function(){return d(this.species)},e.prototype.getCriteria=function(){var a=d(this.species);return this.date&&a.append(this.date),a},e.prototype.getGeoArgs=function(){return d(this.geo)},e.prototype.add=function(d){return this.updateCount++,d instanceof a?this.date=d:d instanceof b?this.species[d.getId()]=d:d instanceof c&&(this.geo[d.getId()]=d),!(d instanceof c)},e.prototype.remove=function(d){return this.updateCount++,d instanceof a?(this.date=void 0,this.species={}):d instanceof b?delete this.species[d.getId()]:d instanceof c&&delete this.geo[d.getId()],!(d instanceof c)},e.prototype.reset=function(){this.updateCount=0,this.date=void 0,this.species={},this.geo={}},e}]).factory("FilterService",["$q","$http","$rootScope","$timeout","uiGmapGoogleMapApi","NpnFilter",function(a,b,c,d,e,f){function g(){if(p.hasCriteria()){var a={},b=p.getDateArg();return b&&(a.start_date=b.getStartDate(),a.end_date=b.getEndDate()),p.getSpeciesArgs().forEach(function(b,c){a["species_id["+c+"]"]=b.getId()}),a}}function h(a){var b=Date.now();c.$broadcast("filter-phase2-start",{count:a.length});var d=0,e=p.getGeoArgs(),f=a.filter(function(a){a.markerOpts.icon.fillColor=r.fillColor;var b,c,f,g,h=0,i={};if(e.length>0){var j=!1;for(b=0;b<e.length&&!(j=e[b].$filter(a));b++);if(!j)return!1}for(c in a.species)f=p.getSpeciesArg(c),i[c]=0,f?(g=f.$filter(a.species[c]))&&(d+=g,i[c]++,h++,1===h&&(a.markerOpts.icon.fillColor=f.color)):console.warn("species found in results but not in filter",a.species[c]);i.n=0;for(c in i)"n"!=c&&i[c]>0&&i.n++;return a.markerOpts.icon.strokeColor=i.n>1?"#00ff00":r.strokeColor,a.$markerKey=a.station_id+"."+a.markerOpts.icon.fillColor+"."+a.markerOpts.icon.strokeColor,h>0}).map(function(a){return{$markerKey:a.$markerKey,latitude:a.latitude,longitude:a.longitude,markerOpts:a.markerOpts,station_id:a.station_id,station_name:a.station_name}});return c.$broadcast("filter-phase2-end",{station:f.length,observation:d}),console.log("phase2 time:",Date.now()-b),s=f}function i(){var d=a.defer(),e=g();if(!q&&e&&m!=p.getUpdateCount()){m=p.getUpdateCount();var f=Date.now();console.log("execute",m,e),c.$broadcast("filter-phase1-start",{}),b.get("/npn_portal/observations/getAllObservationsForSpecies.json",{params:e}).success(function(a){var b,e,g,i,j=Date.now();for(a.stations={},b=0;b<a.station_list.length;b++)a.station_list[b].markerOpts={title:a.station_list[b].station_name,icon:angular.extend({},r)},a.stations[a.station_list[b].station_id]=a.station_list[b];for(b=0;b<a.observation_list.length;b++)for(e=0;e<a.observation_list[b].stations.length;e++)if(i=a.stations[a.observation_list[b].stations[e].station_id])for(i.species||(i.species={}),g=0;g<a.observation_list[b].stations[e].species_ids.length;g++){var k=a.observation_list[b].stations[e].species_ids[g];i.species[k.species_id]?i.species[k.species_id].phenophases=i.species[k.species_id].phenophases.concat(k.phenophases):i.species[k.species_id]=k}else console.warn("Unable to find station with id",a.observation_list[b].stations[e].station_id);c.$broadcast("filter-phase1-end",{count:a.station_list.length}),console.log("phase1.2 time:",Date.now()-j),console.log("phase1 time:",Date.now()-f),console.log("results-pre",a),d.resolve(h(n=a.station_list))})}else d.resolve(s);return d.promise}function j(){q||c.$broadcast("filter-update",{})}function k(){s=[],c.$broadcast("filter-reset",{})}function l(){p.getSpeciesArgs().forEach(function(a,b){a.color=o(b)})}var m,n,o=d3.scale.category20(),p=new f,q=!1,r={fillColor:"#00ff00",fillOpacity:.95,scale:8,strokeColor:"#204d74",strokeWeight:1},s=[];return e.then(function(a){r.path=a.SymbolPath.CIRCLE}),c.$on("filter-rerun-phase2",function(){q||d(function(){if(n){var a=h(n);c.$broadcast("filter-marker-updates",{markers:a})}},500)}),{execute:i,pause:function(){console.log("PAUSE"),q=!0},resume:function(){console.log("RESUME"),q=!1,j()},getFilter:function(){return p},hasFilterChanged:function(){return m!==p.getUpdateCount()},isFilterEmpty:function(){return!p.hasCriteria()},hasDate:function(){return p.hasDate()},hasSufficientCriteria:function(){return p.hasSufficientCriteria()},addToFilter:function(a){p.add(a)&&(l(),j())},removeFromFilter:function(a){p.remove(a)&&(p.hasCriteria()?j():k())},resetFilter:function(){p.reset(),k()}}}]).directive("npnFilterResults",["$rootScope","$http","$timeout","FilterService","SettingsService",function(a,b,c,d,e){return{restrict:"E",template:'<ui-gmap-markers models="results.markers" idKey="\'$markerKey\'" coords="\'self\'" icon="\'icon\'" options="\'markerOpts\'" doCluster="doCluster"></ui-gmap-markers>',scope:{},controller:function(a){function b(){!d.isFilterEmpty()&&d.hasFilterChanged()&&c(function(){a.results.markers=[],c(function(){d.execute().then(function(b){console.log("markers",b),a.results.markers=b})},500)},500)}var f=!1;a.results={markers:[]},a.doCluster=e.getSettingValue("clusterMarkers"),a.$on("setting-update-clusterMarkers",function(b,c){a.doCluster=c.value}),a.$on("tool-open",function(a,b){f="filter"===b.tool.id}),a.$on("tool-close",function(a,c){"filter"===c.tool.id&&(f=!1,b())}),a.$on("filter-update",function(){f||b()}),a.$on("filter-reset",function(){a.results.markers=[]}),a.$on("filter-marker-updates",function(b,c){console.log("update data",c),a.results.markers=c.markers})}}}]).directive("filterTags",["FilterService",function(a){return{restrict:"E",templateUrl:"js/filter/filterTags.html",scope:{},controller:function(b){b.getFilter=a.getFilter}}}]).filter("speciesBadge",function(){return function(a,b){return"observation-count"===b?a.observation:"station-count"===b?a.station:"station-observation-count"===b?a.station+"/"+a.observation:a}}).filter("speciesTitle",["SettingsService",function(a){return function(b,c){var d=c||a.getSettingValue("tagSpeciesTitle");if("common-name"===d){if(b.common_name){var e=b.common_name.toLowerCase();return e.substring(0,1).toUpperCase()+e.substring(1)}return b.common_name}return"genus-species"===d?b.genus+" "+b.species:b}}]).directive("speciesFilterTag",["$rootScope","FilterService","SettingsService","SpeciesFilterArg",function(a,b,c){return{restrict:"E",require:"^filterTags",templateUrl:"js/filter/speciesFilterTag.html",scope:{arg:"="},controller:function(d){d.titleFormat=c.getSettingValue("tagSpeciesTitle"),d.$on("setting-update-tagSpeciesTitle",function(a,b){d.titleFormat=b.value}),d.badgeFormat=c.getSettingValue("tagBadgeFormat"),d.$on("setting-update-tagBadgeFormat",function(a,b){d.badgeFormat=b.value}),d.$on("filter-phase2-start",function(){d.arg.resetCounts(0)}),d.$on("filter-phase1-start",function(){d.arg.resetCounts("?")}),d.removeFromFilter=b.removeFromFilter,d.status={isopen:!1};var e;d.$watch("status.isopen",function(){if(d.status.isopen)e=d.arg.phenophases.map(function(a){return a.selected});else if(e)for(var b=0;b<e.length;b++)if(e[b]!=d.arg.phenophases[b].selected){a.$broadcast("filter-rerun-phase2",{});break}}),d.selectAll=function(a){angular.forEach(d.arg.phenophases,function(b){b.selected=a})}}}}]).directive("dateFilterTag",["FilterService","SettingsService",function(a,b){return{restrict:"E",require:"^filterTags",templateUrl:"js/filter/dateFilterTag.html",scope:{arg:"="},controller:function(c){c.badgeFormat=b.getSettingValue("tagBadgeFormat"),c.$on("setting-update-tagBadgeFormat",function(a,b){c.badgeFormat=b.value}),c.removeFromFilter=a.removeFromFilter,c.counts={station:"?",observation:"?"},c.$on("filter-phase1-start",function(){c.counts.station=c.counts.observation="?"}),c.$on("filter-phase2-start",function(){c.counts.station=c.counts.observation=0}),c.$on("filter-phase2-end",function(a,b){c.counts=b})}}}]).directive("filterControl",["$http","$filter","FilterService","DateFilterArg","SpeciesFilterArg",function(a,b,c,d,e){return{restrict:"E",templateUrl:"js/filter/filterControl.html",controller:["$scope",function(b){function f(){b.serverResults=void 0,b.selected.speciesToAdd=b.selected.addSpecies=void 0;var a={},c=0;angular.forEach([].concat(b.speciesInput.animals).concat(b.speciesInput.plants),function(b){a["group_ids["+c++ +"]"]=b.species_type_id}),c=0,angular.forEach(b.speciesInput.networks,function(b){a["network_id["+c++ +"]"]=b.network_id}),j=a,b.findSpeciesParamsEmpty=0===Object.keys(a).length}b.addDateRangeToFilter=function(){c.addToFilter(new d(b.selected.date))},b.filterHasDate=c.hasDate,b.filterHasSufficientCriteria=c.hasSufficientCriteria;for(var g=(new Date).getYear()+1900,h=[],i=2008;g>=i;i++)h.push(i);b.thisYear=g,b.validYears=h,b.selected={addSpecies:void 0,date:{start_date:g-1,end_date:g}},b.addSpeciesToFilter=function(a){c.addToFilter(new e(a)),b.selected.speciesToAdd=b.selected.addSpecies=void 0},b.speciesInput={animals:[],plants:[],networks:[]},b.findSpeciesParamsEmpty=!0;var j;b.$watch("speciesInput.animals",f),b.$watch("speciesInput.plants",f),b.$watch("speciesInput.networks",f),b.$watch("selected.addSpecies",function(){b.selected.speciesToAdd=angular.isObject(b.selected.addSpecies)?b.selected.addSpecies:void 0}),b.findSpecies=function(){return b.serverResults||(b.serverResults=a.get("/npn_portal/species/getSpeciesFilter.json",{params:j}).then(function(a){var c=[];return angular.forEach(a.data,function(a){a.number_observations=parseInt(a.number_observations),a.$display=a.common_name+" ("+a.number_observations+")",c.push(a)}),b.serverResults=c.sort(function(a,b){return a.number_observations<b.number_observations?1:a.number_observations>b.number_observations?-1:0})})),b.serverResults},a.get("/npn_portal/networks/getPartnerNetworks.json").success(function(a){angular.forEach(a,function(a){a.network_name=a.network_name.trim()}),b.partners=a}),a.get("/npn_portal/species/getPlantTypes.json").success(function(a){b.plantTypes=a}),a.get("/npn_portal/species/getAnimalTypes.json").success(function(a){b.animalTypes=a})}]}}]),angular.module("npn-viz-tool.filters",[]).filter("cssClassify",function(){return function(a){return"string"==typeof a?a.trim().toLowerCase().replace(/\s+/g,"-"):a}}).filter("yesNo",function(){return function(a){return a?"Yes":"No"}}).filter("gte",function(){return function(a,b){return b&&angular.isArray(a)?a.filter(function(a){return a>=b}):a}}).filter("lte",function(){return function(a,b){return b&&angular.isArray(a)?a.filter(function(a){return b>=a}):a}}).filter("trim",function(){return function(a){return angular.isString(a)?a.trim():a}}).filter("faFileIcon",function(){var a={pdf:"fa-file-pdf-o"};return function(b){return b&&!a[b]&&console.debug("no explicit file type icon for "+b),a[b]||"fa-file-o"}}).filter("ellipses",function(){return function(a){var b=2==arguments.length?arguments[1]:55;return"string"==typeof a&&a.length>b?a.substring(0,b)+" ...":a}}),angular.module("npn-viz-tool.layers",["npn-viz-tool.filter","ngResource"]).factory("LayerService",["$rootScope","$http","$q","uiGmapIsReady",function(a,b,c,d){function e(a){if(!a.properties.CENTER){var b,c,d,e,f,g,h=a.geometry,i="Polygon"===h.type?h.coordinates[0]:h.coordinates.reduce(function(a,b){return a.concat(b[0])},[]);for(b=0;b<i.length;b++)c=i[b],0===b?(f=g=c[0],d=e=c[1]):(f=Math.max(f,c[0]),g=Math.min(g,c[0]),d=Math.max(d,c[1]),e=Math.min(e,c[1]));a.properties.CENTER={latitude:e+(d-e)/2,longitude:g+(f-g)/2}}}function f(d){var f=c.defer();return d.data?f.resolve(d):(a.$broadcast("layer-load-start",{}),b.get("layers/"+d.file).success(function(b){"GeometryCollection"===b.type&&(console.log("Translating GeometryCollection to FeatureCollection"),b.features=[],angular.forEach(b.geometries,function(a,c){b.features.push({type:"Feature",properties:{NAME:""+c},geometry:a})}),b.type="FeatureCollection",delete b.geometries),b.features.forEach(e),d.data=b,f.resolve(d),a.$broadcast("layer-load-end",{})})),f.promise}function g(){j.data.setStyle(function(a){var b=a.getProperty("$style");return b&&"function"==typeof b?b(a):b?angular.extend(l,b):l})}function h(a){if(a.loaded){for(var b=[],c=0;c<a.loaded.length;c++)a.loaded[c].removeProperty("$style"),j.data.remove(a.loaded[c]),b.push(a.loaded[c]);return delete a.loaded,b}}var i=null,j=null,k=d.promise(1).then(function(a){return j=a[0].map,console.log("LayerService - map is ready"),b.get("layers/layers.json").success(function(a){i={},a.forEach(function(a,b){a.index=b,i[a.id]=a}),console.log("LayerService - layer list is loaded",i)})}),l={strokeColor:"#ffffff",strokeOpacity:null,strokeWeight:1,fillColor:"#c0c5b8",fillOpacity:null};return{getAvailableLayers:function(){var a=c.defer();return k.then(function(){var b,c,d=[];for(b in i)c=i[b],d.push({id:c.id,index:c.index,label:c.label,source:c.source,img:c.img,link:c.link});a.resolve(d.sort(function(a,b){return a.idx-b.idx}))}),a.promise},restyleLayers:function(){var a=c.defer();return k.then(function(){g(),a.resolve()}),a.promise},resetLayers:function(){var a=c.defer();return k.then(function(){for(var b in i)h(i[b]);a.resolve()}),a.promise},loadLayer:function(a,b){var d=c.defer();return k.then(function(){var c=i[a];return c?void f(c).then(function(){c.style=b,c.loaded=j.data.addGeoJson(c.data),c.loaded.forEach(function(a){a.setProperty("$style",b)}),g(),d.resolve([j,c.loaded])}):(console.log("no such layer with id",a),d.reject(a))}),d.promise},unloadLayer:function(a){var b=c.defer();return k.then(function(){var c=i[a];if(!c)return console.log("no such layer with id",a),b.reject(a);var d=h(c);b.resolve(d)}),b.promise}}}]).directive("layerControl",["$rootScope","$q","$location","LayerService","FilterService","GeoFilterArg",function(a,b,c,d,e,f){return{restrict:"E",templateUrl:"js/layers/layerControl.html",controller:function(g){function h(){g.layerOnMap={layer:"none"}}function i(b,c){var h=(b.getProperty("NAME"),b.getProperty("$FILTER"));k=b,h?(e.removeFromFilter(h),h=null):(h=new f(b,g.layerOnMap.layer.id),e.addToFilter(h),c.data.overrideStyle(b,{fillColor:"#800000"})),b.setProperty("$FILTER",h),d.restyleLayers().then(function(){e.isFilterEmpty()||a.$broadcast("filter-rerun-phase2",{})})}function j(a){var c=b.defer();return"none"===a?c.resolve(null):(d.loadLayer(a.id,function(a){var b={strokeOpacity:1,strokeColor:"#ffffff",strokeWeight:1,fillOpacity:0};return a.getProperty("$FILTER")&&(b.fillColor="#800000",b.fillOpacity=.5),b}).then(function(a){if(!l.length){var b=a[0];g.$on("filter-phase2-end",function(){if(k){var a=k.getProperty("CENTER");b.panTo(new google.maps.LatLng(a.latitude,a.longitude)),k=null}}),l.push(b.data.addListener("mouseover",function(a){b.data.overrideStyle(a.feature,{strokeWeight:3})})),l.push(b.data.addListener("mouseout",function(){b.data.revertStyle()})),l.push(b.data.addListener("click",function(a){g.$apply(function(){i(a.feature,b)})}))}c.resolve(a)}),c.promise)}var k,l=[];h(),g.$on("filter-reset",h),d.getAvailableLayers().then(function(b){function d(){a.$broadcast("layers-ready",{})}console.log("av.layers",b),g.layers=b;var e=c.search();if(e.g){console.log("init layers from query arg",e.g);var f,h,k=e.g.split(";"),l=k.map(function(a){return a.substring(a.indexOf(":")+1)}),m=k[0].substring(0,k[0].indexOf(":"));for(h=0;h<b.length;h++)if(b[h].id===m){f=b[h];break}f&&j(f).then(function(a){var b=a[0],c=a[1];g.layerOnMap.skipLoad=!0,g.layerOnMap.layer=f,c.forEach(function(a){-1!=l.indexOf(a.getProperty("NAME"))&&i(a,b)}),d()})}else d()}),g.$watch("layerOnMap.layer",function(b,c){return g.layerOnMap.skipLoad?void(g.layerOnMap.skipLoad=!1):void(c&&"none"!=c?d.unloadLayer(c.id).then(function(c){var d=!1;c.forEach(function(a){var b=a.getProperty("$FILTER");b&&(d=!0,e.removeFromFilter(b),a.setProperty("$FILTER",null))}),d&&!e.isFilterEmpty()&&a.$broadcast("filter-rerun-phase2",{}),j(b)}):b&&j(b))}),g.$on("$destroy",function(){d.resetLayers(),l.forEach(function(a){a.remove()})})}}}]),angular.module("npn-viz-tool",["templates-npnvis","npn-viz-tool.map","uiGmapgoogle-maps","ui.bootstrap","ngAnimate"]).config(function(a){a.configure({v:"3.17",libraries:"geometry"})}),angular.module("npn-viz-tool.map",["npn-viz-tool.layers","npn-viz-tool.stations","npn-viz-tool.toolbar","npn-viz-tool.filter","npn-viz-tool.settings","npn-viz-tool.vis","npn-viz-tool.share","uiGmapgoogle-maps"]).directive("npnVizMap",["$location","$timeout","uiGmapGoogleMapApi","uiGmapIsReady","FilterService",function(a,b,c,d,e){return{restrict:"E",templateUrl:"js/map/map.html",scope:{},controller:["$scope",function(f){function g(){f.stationView=!1}function h(){i&&(i.panTo(new google.maps.LatLng(j.latitude,j.longitude)),i.setZoom(4)),f.stationView=!0}var i,j={latitude:38.8402805,longitude:-97.61142369999999},k=4;f.stationView=!1,c.then(function(a){console.log("maps",a),f.map={center:j,zoom:k,options:{streetViewControl:!1,panControl:!1,zoomControl:!0,zoomControlOptions:{style:a.ZoomControlStyle.SMALL,position:a.ControlPosition.RIGHT_TOP}}}}),d.promise(1).then(function(b){i=b[0].map;var c=a.search();f.stationView=!c.d&&!c.s}),f.$on("tool-open",function(a,b){"layers"===b.tool.id&&g()}),f.$on("filter-phase1-start",g),f.$on("filter-reset",h),f.reset=function(){f.stationView?(f.stationView=!1,b(h,500)):e.resetFilter()}}]}}]).directive("npnWorking",["uiGmapIsReady",function(a){return{restrict:"E",template:'<div id="npn-working" ng-show="working"><i class="fa fa-circle-o-notch fa-spin fa-5x"></i></div>',scope:{},controller:function(b){function c(){b.working=!0}function d(){b.working=!1}c(),a.promise(1).then(d),b.$on("filter-phase1-start",c),b.$on("filter-phase2-start",c),b.$on("filter-rerun-phase2",c),b.$on("filter-phase2-end",d),b.$on("layer-load-start",c),b.$on("layer-load-end",d)}}}]),angular.module("templates-npnvis",["js/calendar/calendar.html","js/filter/dateFilterTag.html","js/filter/filterControl.html","js/filter/filterTags.html","js/filter/speciesFilterTag.html","js/layers/layerControl.html","js/map/map.html","js/scatter/scatter.html","js/settings/settingsControl.html","js/toolbar/tool.html","js/toolbar/toolbar.html","js/vis/visControl.html","js/vis/visDialog.html"]),angular.module("js/calendar/calendar.html",[]).run(["$templateCache",function(a){a.put("js/calendar/calendar.html",'<vis-dialog title="Calendar" modal="modal">\n<form class="form-inline">\n    <div class="form-group" ng-if="!selection.start_year">\n        <label for="yearsInput">Select a starting year</label>\n        <select name="yearsInput" class="form-control" ng-model="selection.start_year" ng-options="year for year in availableYears"></select>\n    </div>\n    <div class="form-group animated-show-hide" ng-if="selection.start_year">\n        <label for="toPlotInput">Select Species/Phenophase pairs</label>\n        <select name="toPlotInput" class="form-control" ng-model="selection.toPlot" ng-options="o.phenophase_name group by (o|speciesTitle) for o in plottable"></select>\n        <div class="btn-group" dropdown is-open="selection.color_isopen">\n          <button type="button" class="btn btn-default dropdown-toggle" dropdown-toggle style="background-color: {{colorScale(selection.color)}};">\n            &nbsp; <span class="caret"></span>\n          </button>\n          <ul class="dropdown-menu" role="menu">\n            <li ng-repeat="i in colors track by $index" style="background-color: {{colorScale($index)}};"><a href ng-click="selection.color=$index;">&nbsp;</a></li>\n          </ul>\n        </div>\n    </div>\n    <button class="btn btn-default" ng-click="addToPlot()" ng-disabled="!canAddToPlot()"><i class="fa fa-plus"></i></button>\n</form>\n\n<div class="panel panel-default main-vis-panel" >\n    <div class="panel-body">\n        <center>\n        <ul class="date-range list-inline animated-show-hide">\n            <li>{{selection.start_year}}</li>\n            <li>-</li>\n            <li>{{selection.end_year}}</li>\n        </ul>\n        <ul class="to-plot list-inline animated-show-hide" ng-if="toPlot.length">\n            <li ng-repeat="tp in toPlot">{{tp|speciesTitle}}/{{tp.phenophase_name}} <i style="color: {{colorScale(tp.color)}};" class="fa fa-circle"></i>\n                <a href ng-click="removeFromPlot($index)"><i class="fa fa-times-circle-o"></i></a>\n            </li>\n            <li class="animated-show-hide"><button class="btn btn-default" ng-click="visualize()">Visualize</button></li>\n        </ul>\n        <svg class="chart"></svg>\n        </center>\n    </div>\n</div>\n<pre ng-if="record">{{record | json}}</pre>\n\n</vis-dialog>')}]),angular.module("js/filter/dateFilterTag.html",[]).run(["$templateCache",function(a){a.put("js/filter/dateFilterTag.html",'<div class="btn-group">\n    <button class="btn btn-default" disabled>\n        {{arg.arg.start_date}} - {{arg.arg.end_date}} <span class="badge">{{counts | speciesBadge:badgeFormat}}</span>\n    </button>\n    <button class="btn btn-default" ng-click="removeFromFilter(arg)">\n        <i class="fa fa-times-circle-o"></i>\n    </button>\n</div>')}]),angular.module("js/filter/filterControl.html",[]).run(["$templateCache",function(a){a.put("js/filter/filterControl.html",'<a class="btn btn-default" id="filter-placebo" href ng-click="$parent.close()" ng-disabled="!filterHasSufficientCriteria()">Execute Filter <i class="fa fa-search"></i></a>\n\n<ul class="list-unstyled">\n    <li>\n        <label for="yearInputForm">Years (at most ten)</label>\n        <form id="yearInputForm" name="yearInputForm">\n        <input id="start_date" type="number" class="form-control"\n               max="{{selected.date.end_date || thisYear}}"\n               ng-model="selected.date.start_date"\n               typeahead="year for year in validYears | lte:selected.date.end_date | filter:$viewValue"\n               required placeholder="From" /> - \n        <input id="end_date" type="number" class="form-control"\n                min="{{selected.date.start_date || 2008}}"\n                ng-model="selected.date.end_date"\n                typeahead="year for year in validYears | gte:selected.date.start_date | filter:$viewValue"\n                required placeholder="To" />\n        <button class="btn btn-default"\n                ng-disabled="yearInputForm.$invalid || ((selected.date.end_date - selected.date.start_date) > 10)"\n                ng-click="addDateRangeToFilter()"><i class="fa fa-plus"></i></button>\n        </form>\n    </li>\n    <li class="divider" ng-if="filterHasDate()"></li>\n    <li ng-if="filterHasDate()">\n        <label for="species">Species</label>\n        <input id="species"\n               type="text" class="form-control"\n               placeholder="Add Species To Filter"\n               typeahead="sp as sp.$display for sp in findSpecies()  | filter:{common_name:$viewValue} | limitTo:15"\n               typeahead-loading="findingSpecies"\n               ng-model="selected.addSpecies"\n               ng-disabled="findSpeciesParamsEmpty" />\n        <button class="btn btn-default" ng-disabled="!selected.speciesToAdd"\n                ng-click="addSpeciesToFilter(selected.speciesToAdd)">\n            <i class="fa" ng-class="{\'fa-refresh fa-spin\': findingSpecies, \'fa-plus\': !findingSpecies}"></i>\n        </button>\n    </li>\n    <li ng-if="filterHasDate()">\n        <label>Animal Types</label>\n        <div isteven-multi-select\n            max-labels="3"\n            input-model="animalTypes"\n            output-model="speciesInput.animals"\n            button-label="species_type"\n            item-label="species_type"\n            tick-property="selected"\n            orientation="horizontal"\n            helper-elements="all none reset filter"></div>\n    </li>\n    <li ng-if="filterHasDate()">\n        <label>Plant Types</label>\n        <div isteven-multi-select\n            max-labels="3"\n            input-model="plantTypes"\n            output-model="speciesInput.plants"\n            button-label="species_type"\n            item-label="species_type"\n            tick-property="selected"\n            orientation="horizontal"\n            helper-elements="all none reset filter"></div>\n    </li>\n    <li ng-if="filterHasDate()">\n        <label>Partners</label>\n        <div isteven-multi-select\n            max-labels="3"\n            input-model="partners"\n            output-model="speciesInput.networks"\n            button-label="network_name"\n            item-label="network_name"\n            tick-property="selected"\n            orientation="horizontal"\n            helper-elements="all none reset filter"></div>\n    </li>\n</ul>\n')
}]),angular.module("js/filter/filterTags.html",[]).run(["$templateCache",function(a){a.put("js/filter/filterTags.html",'<ul class="list-inline filter-tags">\n    <li ng-repeat="s in getFilter().getSpeciesArgs()"><species-filter-tag arg="s"></species-filter-tag></li>\n    <li ng-if="(date = getFilter().getDateArg())"><date-filter-tag arg="date"></date-filter-tag></li>\n</ul>')}]),angular.module("js/filter/speciesFilterTag.html",[]).run(["$templateCache",function(a){a.put("js/filter/speciesFilterTag.html",'<div class="btn-group filter-tag" ng-class="{open: status.isopen}">\n    <button type="button" class="btn btn-primary" style="background-color: {{arg.color}};" ng-disabled="!arg.phenophases" ng-click="status.isopen = !status.isopen">\n        {{arg.arg | speciesTitle:titleFormat}} <span class="badge">{{arg.counts | speciesBadge:badgeFormat}}</span> <span class="caret"></span>\n    </button>\n    <ul class="dropdown-menu phenophase-list" role="menu">\n        <li class="inline">Select <a href ng-click="selectAll(true)">all</a> <a href ng-click="selectAll(false)">none</a></li>\n        <li class="divider"></li>\n        <li ng-repeat="phenophase in arg.phenophases">\n            <input type="checkbox" ng-model="phenophase.selected"> <span class="badge">{{phenophase.count}}</span> {{phenophase.phenophase_name}}\n        </li>\n    </ul>\n    <button class="btn btn-primary" style="background-color: {{arg.color}};" ng-click="removeFromFilter(arg)">\n        <i class="fa fa-times-circle-o"></i>\n    </button>\n</div>')}]),angular.module("js/layers/layerControl.html",[]).run(["$templateCache",function(a){a.put("js/layers/layerControl.html",'<ul class="list-unstyled">\n    <li><input type="radio" id="layer-none" ng-model="layerOnMap.layer" value="none"/> <label for="layer-none">None</label></li>\n    <li ng-repeat="layer in layers">\n        <input type="radio" id="layer-{{layer.id}}" ng-model="layerOnMap.layer" ng-value="layer"/> <label for="layer-{{layer.id}}">{{layer.label}}</label>\n        <span ng-if="layer.source">(<a href="{{layer.source}}" target="_blank">Source</a>)</span>\n        <span ng-if="layer.img">\n            <a ng-if="layer.link" href="{{layer.link}}" target="_blank"><img ng-src="{{layer.img}}" /></a>\n            <img ng-if="!layer.link" ng-src="{{layer.img}}" />\n        </span>\n    </li>\n</ul>')}]),angular.module("js/map/map.html",[]).run(["$templateCache",function(a){a.put("js/map/map.html",'<a title="Reset" href id="reset-control" class="btn btn-default btn-xs" ng-click="reset()"><i class="fa fa-refresh"></i></a>\n\n<npn-working></npn-working>\n\n<ui-gmap-google-map ng-if="map" center=\'map.center\' zoom=\'map.zoom\' options="map.options">\n    <npn-stations ng-if="stationView"></npn-stations>\n    <npn-filter-results></npn-filter-results>\n</ui-gmap-google-map>\n\n<share-control></share-control>\n<filter-tags></filter-tags>\n\n<toolbar>\n    <tool id="filter" icon="fa-search" title="Filter">\n        <filter-control></filter-control>\n    </tool>\n    <tool id="layers" icon="fa-bars" title="Layers">\n        <layer-control></layer-control>\n    </tool>\n    <tool id="visualizations" icon="fa-bar-chart" title="Visualizations">\n        <vis-control></vis-control>\n    </tool>\n    <tool id="settings" icon="fa-cog" title="Settings">\n        <settings-control></settings-control>\n    </tool>\n</toolbar>')}]),angular.module("js/scatter/scatter.html",[]).run(["$templateCache",function(a){a.put("js/scatter/scatter.html",'<vis-dialog title="Scatter Plot" modal="modal">\n<form class="form-inline">\n    <div class="form-group">\n        <label for="toPlotInput">Select up to three Species/Phenophase pairs</label>\n        <select name="toPlotInput" class="form-control" ng-model="selection.toPlot" ng-options="o.phenophase_name group by (o|speciesTitle) for o in plottable"></select>\n        <div class="btn-group" dropdown is-open="selection.color_isopen">\n          <button type="button" class="btn btn-default dropdown-toggle" dropdown-toggle style="background-color: {{colorScale(selection.color)}};">\n            &nbsp; <span class="caret"></span>\n          </button>\n          <ul class="dropdown-menu" role="menu">\n            <li ng-repeat="i in colors track by $index" style="background-color: {{colorScale($index)}};"><a href ng-click="selection.color=$index;">&nbsp;</a></li>\n          </ul>\n        </div>\n    </div>\n    <button class="btn btn-default" ng-click="addToPlot()" ng-disabled="!canAddToPlot()"><i class="fa fa-plus"></i></button>\n</form>\n\n<div class="panel panel-default main-vis-panel" >\n    <div class="panel-body">\n        <center>\n        <ul class="to-plot list-inline animated-show-hide" ng-if="toPlot.length">\n            <li ng-repeat="tp in toPlot">{{tp|speciesTitle}}/{{tp.phenophase_name}} <i style="color: {{colorScale(tp.color)}};" class="fa fa-circle"></i>\n                <a href ng-click="removeFromPlot($index)"><i class="fa fa-times-circle-o"></i></a>\n            </li>\n            <li>\n                <select class="form-control vis-axis" ng-model="selection.axis" ng-options="o as o.label for o in axis"></select>\n            </li>\n            <li class="animated-show-hide"><button class="btn btn-default" ng-click="visualize()">Visualize</button></li>\n        </ul>\n        <svg class="chart"></svg>\n        </center>\n    </div>\n</div>\n<pre ng-if="record">{{record | json}}</pre>\n\n</vis-dialog>')}]),angular.module("js/settings/settingsControl.html",[]).run(["$templateCache",function(a){a.put("js/settings/settingsControl.html",'<ul class="list-unstyled">\n    <li>\n        <Label for="clusterMarkersSetting">Cluster Markers</label>\n        <ul class="list-unstyled">\n            <li ng-repeat="option in [true,false]">\n                <input type="radio" id="clusterMarkers{{option}}" ng-model="settings.clusterMarkers.value"\n                       ng-value="{{option}}" /> <label for="clusterMarkers{{option}}">{{option | yesNo}}</label>\n            </li>\n        </ul>\n    </li>\n    <li class="divider"></li>\n    <li>\n        <label>Species Badge Contents</label>\n        <ul class="list-unstyled">\n            <li ng-repeat="option in settings.tagBadgeFormat.options">\n                <input type="radio"\n                       id="{{option.value}}" ng-model="settings.tagBadgeFormat.value"\n                       value="{{option.value}}"> <label for="{{option.value}}">{{option.label}}</label>\n            </li>\n        </ul>\n\n    </li>\n    <li class="divider"></li>\n    <li>\n        <label>Species Tag Title</label>\n        <ul class="list-unstyled">\n            <li ng-repeat="option in settings.tagSpeciesTitle.options">\n                <input type="radio"\n                       id="{{option.value}}" ng-model="settings.tagSpeciesTitle.value"\n                       value="{{option.value}}"> <label for="{{option.value}}">{{option.label}}</label>\n            </li>\n        </ul>\n\n    </li>\n</ul>')}]),angular.module("js/toolbar/tool.html",[]).run(["$templateCache",function(a){a.put("js/toolbar/tool.html",'<div class="tool-content {{title.toLowerCase()}}" ng-show="selected">\n    <h2>{{title}}</h2>\n    <div ng-transclude>\n    </div>\n</div>')}]),angular.module("js/toolbar/toolbar.html",[]).run(["$templateCache",function(a){a.put("js/toolbar/toolbar.html",'<div class="toolbar">\n  <ul class="tools-list">\n    <li ng-repeat="t in tools" ng-class="{open: t.selected}"\n        popover-placement="right" popover="{{t.title}}" popover-trigger="mouseenter" popover-popup-delay="1000"\n        ng-click="select(t)">\n      <i class="fa {{t.icon}}"></i>\n    </li>\n  </ul>\n  <div class="toolbar-content" ng-class="{open: open}" ng-transclude></div>\n</div>')}]),angular.module("js/vis/visControl.html",[]).run(["$templateCache",function(a){a.put("js/vis/visControl.html",'<ul class="list-unstyled">\n    <li ng-repeat="vis in visualizations">\n        <a href ng-click="open(vis)">{{vis.title}}</a>\n        <p>{{vis.description}}</p>\n    </li>\n</ul>')}]),angular.module("js/vis/visDialog.html",[]).run(["$templateCache",function(a){a.put("js/vis/visDialog.html",'<div class="modal-header">\n    <a href class="modal-dismiss" ng-click="modal.dismiss()"><i class="fa fa-times-circle-o fa-2x"></i></a>\n    <h3 class="modal-title">{{title}}</h3>\n</div>\n<div class="modal-body vis-dialog {{title | cssClassify}}" ng-transclude>\n</div>')}]),angular.module("npn-viz-tool.vis-scatter",["npn-viz-tool.vis","npn-viz-tool.filter","npn-viz-tool.filters","ui.bootstrap"]).controller("ScatterVisCtrl",["$scope","$modalInstance","$http","$timeout","$filter","FilterService","ChartService",function(a,b,c,d,e,f,g){function h(){return angular.extend({},a.selection.toPlot,{color:a.selection.color})}function i(){function b(b){return b[a.selection.axis.key]}if(j){var c=1;p.domain([d3.min(j,b)-c,d3.max(j,b)+c]),q.scale(p).tickFormat(d3.format(".2f"));var d=k.selectAll("g .x.axis");d.call(q),d.selectAll(".axis-label").remove(),d.append("text").attr("class","axis-label").attr("x",o.width-6).attr("dy","-.71em").style("text-anchor","end").text(a.selection.axis.label);var f=k.selectAll(".circle").data(j,function(a){return a.id});f.exit().remove(),f.enter().append("circle").attr("class","circle"),f.attr("cx",function(b){return p(b[a.selection.axis.key])}).attr("cy",function(a){return r(a.first_yes_doy)}).attr("r","5").attr("fill",function(a){return a.color}).on("click",function(b){d3.event.defaultPrevented||a.$apply(function(){a.record=b})}).append("title").text(function(a){return t(a.day_in_range)+" ["+a.latitude+","+a.longitude+"]"});var h=[],i=d3.format(".2f");angular.forEach(a.toPlot,function(b){var c=a.colorScale(b.color),d=j.filter(function(a){return a.color===c}),f=d.sort(function(b,c){return b[a.selection.axis.key]-c[a.selection.axis.key]}),k=f.map(function(b){return b[a.selection.axis.key]}),l=f.map(function(a){return a.first_yes_doy}),m=g.leastSquares(k,l),n=k[0],o=g.approxY(m,n),p=k[k.length-1],q=g.approxY(m,p);h.push({id:b.species_id+"."+b.phenophase_id,legend:e("speciesTitle")(b)+"/"+b.phenophase_name+" (R^2 = "+i(m[2])+")",color:c,p1:[n,o],p2:[p,q]})});var l=k.selectAll(".regression").data(h,function(a){return a.id});l.exit().remove(),l.enter().append("line").attr("class","regression"),l.attr("data-legend",function(a){return a.legend}).attr("data-legend-color",function(a){return a.color}).attr("x1",function(a){return p(a.p1[0])}).attr("y1",function(a){return r(a.p1[1])}).attr("x2",function(a){return p(a.p2[0])}).attr("y2",function(a){return r(a.p2[1])}).attr("stroke",function(a){return a.color}).attr("stroke-width",2),k.select(".legend").remove();{k.append("g").attr("class","legend").attr("transform","translate(30,-45)").style("font-size","12px").call(d3.legend)}k.selectAll(".legend text").html(function(a){return a.key.replace("R^2",'R<tspan style="baseline-shift: super; font-size: 8px;">2</tspan>')})}}a.modal=b,a.colorScale=d3.scale.category20(),a.colors=new Array(20),a.axis=[{key:"latitude",label:"Latitude"},{key:"longitude",label:"Longitude"},{key:"elevation_in_meters",label:"Elevation"}],a.selection={color:0,axis:a.axis[0]},a.plottable=[],angular.forEach(f.getFilter().getSpeciesArgs(),function(b){angular.forEach(b.phenophases,function(c){a.plottable.push(angular.extend({},b.arg,c))})}),a.toPlot=[],a.canAddToPlot=function(){if(!a.selection.toPlot||3===a.toPlot.length)return!1;if(0===a.toPlot.length)return!0;var b,c=h();for(b=0;b<a.toPlot.length;b++)if(angular.equals(a.toPlot[b],c))return!1;for(b=0;b<a.toPlot.length;b++)if(c.color===a.toPlot[b].color)return!1;return!0};var j,k,l=f.getFilter().getDateArg(),m=l.arg.start_date,n=new Date(m,0),o=(l.arg.end_date,g.getSizeInfo({top:80})),p=d3.scale.linear().range([0,o.width]).domain([0,100]),q=d3.svg.axis().scale(p).orient("bottom"),r=d3.scale.linear().range([o.height,0]).domain([1,365]),s=d3.time.format("%x"),t=function(a){var b=(a-1)*g.ONE_DAY_MILLIS+n.getTime(),c=new Date(b);return s(c)},u=d3.svg.axis().scale(r).orient("left");d(function(){k=d3.select(".chart").attr("width",o.width+o.margin.left+o.margin.right).attr("height",o.height+o.margin.top+o.margin.bottom).append("g").attr("transform","translate("+o.margin.left+","+o.margin.top+")"),k.append("g").attr("class","x axis").attr("transform","translate(0,"+o.height+")").call(q),k.append("g").attr("class","y axis").call(u).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Onset DOY")},500),a.addToPlot=function(){a.selection.toPlot&&(a.toPlot.push(h()),a.selection.color++,j=void 0)},a.removeFromPlot=function(b){a.toPlot.splice(b,1),j=void 0},a.visualize=function(){if(j)return i();console.log("visualize",a.selection.axis,a.toPlot);var b=f.getFilter().getDateArg(),d={request_src:"npn-vis-scatter-plot",start_date:b.getStartDate(),end_date:b.getEndDate()},e=0,h={};angular.forEach(a.toPlot,function(a){h[a.species_id+"."+a.phenophase_id]=a.color,d["species_id["+e+"]"]=a.species_id,d["phenophase_id["+e++ +"]"]=a.phenophase_id}),c.get("/npn_portal/observations/getSummarizedData.json",{params:d}).success(function(b){b.forEach(function(b,c){b.id=c,b.day_in_range=365*(b.first_yes_year-m)+b.first_yes_doy,b.color=a.colorScale(h[b.species_id+"."+b.phenophase_id])}),j=b.filter(g.filterSuspectSummaryData),console.log("scatterPlot data",j),i()})}}]),angular.module("npn-viz-tool.settings",["npn-viz-tool.filters"]).factory("SettingsService",[function(){var a={clusterMarkers:{name:"cluster-markers",q:"cm",value:!0},tagSpeciesTitle:{name:"tag-species-title",q:"tst",value:"common-name",options:[{value:"common-name",q:"cn",label:"Common Name"},{value:"genus-species",q:"gs",label:"Genus Species"}]},tagBadgeFormat:{name:"tag-badge-format",q:"tbf",value:"observation-count",options:[{value:"observation-count",q:"oc",label:"Observation Count"},{value:"station-count",q:"sc",label:"Station Count"},{value:"station-observation-count",q:"soc",label:"Station Count/Observation Count"}]}};return{getSettings:function(){return a},getSetting:function(b){return a[b]},getSettingValue:function(b){return a[b].value},getSharingUrlArgs:function(){var b,c,d,e="";for(b in a)if(c=a[b],e+=(""!==e?";":"")+c.q+"=",c.options){for(d=0;d<c.options.length;d++)if(c.value===c.options[d].value){e+=c.options[d].q;break}}else e+=c.value;return"ss="+encodeURIComponent(e)},populateFromSharingUrlArgs:function(b){b&&b.split(";").forEach(function(b){var c,d,e=b.split("="),f=e[0],g=e[1];for(c in a)if(a[c].q===f){if(a[c].options){for(d=0;d<a[c].options.length;d++)if(a[c].options[d].q===g){a[c].value=a[c].options[d].value;break}}else a[c].value="true"===g||"false"===g?"true"===g:g;break}})}}}]).directive("settingsControl",["$rootScope","$location","SettingsService",function(a,b,c){return{restrict:"E",templateUrl:"js/settings/settingsControl.html",controller:function(d){function e(b){console.log("broadcastSettingChange",d.settings[b]),a.$broadcast("setting-update-"+b,d.settings[b])}function f(a){d.$watch("settings."+a+".value",function(){e(a)})}c.populateFromSharingUrlArgs(b.search().ss),d.settings=c.getSettings();for(var g in d.settings)f(g)}}}]),angular.module("npn-viz-tool.share",["npn-viz-tool.filter","npn-viz-tool.layers","npn-viz-tool.settings","uiGmapgoogle-maps"]).directive("shareControl",["uiGmapIsReady","FilterService","LayerService","DateFilterArg","SpeciesFilterArg","GeoFilterArg","$location","SettingsService",function(a,b,c,d,e,f,g,h){return{restrict:"E",template:'<a title="Share" href id="share-control" class="btn btn-default btn-xs" ng-disabled="!getFilter().hasSufficientCriteria()" ng-click="share()"><i class="fa fa-share"></i></a><div ng-show="url" id="share-content"><input type="text" class="form-control" ng-model="url" ng-blur="url = null" onClick="this.setSelectionRange(0, this.value.length)"/></div>',scope:{},controller:function(c){b.pause(),a.promise(1).then(function(){function a(){m&&l===k&&(console.log("ready.."),h(),i(),b.resume())}function f(a){e.fromString(a).then(b.addToFilter)}var h,i,j=g.search(),k=0,l=0,m=!1;if(h=c.$on("layers-ready",function(){console.log("layers ready..."),m=!0,a()}),i=c.$on("species-filter-ready",function(b,c){console.log("species filter ready...",c),l++,a()}),console.log("qargs",j),j.d&&j.s){b.addToFilter(d.fromString(j.d));var n=j.s.split(";");k=n.length,n.forEach(f)}else b.resume()}),c.getFilter=b.getFilter,c.share=function(){if(c.url)return void(c.url=null);var a=b.getFilter(),d={},e=g.absUrl(),f=e.indexOf("?");d.d=a.getDateArg().toString(),a.getSpeciesArgs().forEach(function(a){d.s?d.s+=";"+a.toString():d.s=a.toString()}),a.getGeoArgs().forEach(function(a){d.g?d.g+=";"+a.toString():d.g=a.toString()}),-1!=f&&(e=e.substring(0,f)),e+=-1===e.indexOf("#")?"#?":"?",Object.keys(d).forEach(function(a,b){e+=(b>0?"&":"")+a+"="+encodeURIComponent(d[a])}),e+="&"+h.getSharingUrlArgs(),console.log("absUrl",e),c.url=e}}}}]),angular.module("npn-viz-tool.stations",["npn-viz-tool.settings","npn-viz-tool.layers"]).directive("npnStations",["$http","LayerService","SettingsService",function(a,b,c){return{restrict:"E",template:'<ui-gmap-markers models="regions.markers" idKey="\'name\'" coords="\'self\'" icon="\'icon\'" options="\'markerOpts\'" isLabel="true"></ui-gmap-markers><ui-gmap-markers models="stations.markers" idKey="\'station_id\'" coords="\'self\'" icon="\'icon\'" options="\'markerOpts\'" doCluster="doCluster"></ui-gmap-markers>',scope:{},controller:["$scope",function(d){d.doCluster=c.getSettingValue("clusterMarkers"),d.$on("setting-update-clusterMarkers",function(a,b){d.doCluster=b.value}),d.regions={markers:[]},d.stations={states:[],markers:[]};var e=[];a.get("/npn_portal/stations/getStationCountByState.json").success(function(c){var f=c.reduce(function(a,b){return a[b.state]=b,b.number_stations=parseInt(b.number_stations),a.$min=Math.min(a.$min,b.number_stations),a.$max=Math.max(a.$max,b.number_stations),a},{$max:0,$min:0}),g=d3.scale.linear().domain([f.$min,f.$max]).range(["#F7FBFF","#08306B"]);b.resetLayers().then(function(){b.loadLayer("primary",function(a){var b=a.getProperty("NAME"),c=-1!=d.stations.states.indexOf(b),e=f[b],h={strokeOpacity:1,strokeColor:"#ffffff",strokeWeight:1,fillOpacity:0};if(e&&!c){e.visited=!0,h.fillOpacity=.8,h.fillColor=g(e.number_stations),h.clickable=!0;var i=a.getProperty("CENTER"),j=angular.extend({name:b,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:"#000",fillOpacity:.5,scale:16,strokeColor:"#ccc",strokeWeight:1},markerOpts:{title:b,labelClass:"station-count",labelContent:""+e.number_stations}},i);e.number_stations<10?(j.icon.scale=8,j.markerOpts.labelAnchor="4 8"):e.number_stations<100?(j.icon.scale=12,j.markerOpts.labelAnchor="8 8"):e.number_stations<1e3?(j.icon.scale=14,j.markerOpts.labelAnchor="10 8"):j.markerOpts.labelAnchor="13 8",d.$apply(function(){d.regions.markers.push(j)})}else c||console.warn("no station count for "+b);return h}).then(function(b){var c=b[0];e.push(c.data.addListener("mouseover",function(a){c.data.overrideStyle(a.feature,{strokeWeight:3})})),e.push(c.data.addListener("mouseout",function(){c.data.revertStyle()})),e.push(c.data.addListener("click",function(b){var e=b.feature.getProperty("NAME");-1===d.stations.states.indexOf(e)&&(d.stations.states.push(e),c.panTo(b.latLng),c.setZoom(6),a.get("/npn_portal/stations/getAllStations.json",{params:{state_code:e}}).success(function(a){a.forEach(function(a){a.markerOpts={title:a.station_name}}),d.stations.markers=d.stations.markers.concat(a),c.data.remove(b.feature);for(var f=[],g=0;g<d.regions.markers.length;g++)d.regions.markers[g].name!==e&&f.push(d.regions.markers[g]);d.regions.markers=f}))}))})})}),d.$on("$destroy",function(){b.resetLayers(),e.forEach(function(a){a.remove()})})}]}}]),angular.module("npn-viz-tool.toolbar",[]).directive("toolbar",["$rootScope",function(a){return{restrict:"E",templateUrl:"js/toolbar/toolbar.html",transclude:!0,scope:{},controller:function(b){function c(b){a.$broadcast("tool-"+(b.selected?"open":"close"),{tool:b})}var d=b.tools=[];b.select=function(a){a.selected=!a.selected,b.open=a.selected,c(a)},this.addTool=function(a){d.push(a)},this.closeTool=function(a){b.open=a.selected=!1,c(a)}}}}]).directive("tool",[function(){return{restrict:"E",require:"^toolbar",templateUrl:"js/toolbar/tool.html",transclude:!0,scope:{id:"@",title:"@",icon:"@"},link:function(a,b,c,d){d.addTool(a),a.close=function(){d.closeTool(a)}}}}]),angular.module("npn-viz-tool.vis",["npn-viz-tool.filter","npn-viz-tool.filters","npn-viz-tool.vis-scatter","npn-viz-tool.vis-calendar","ui.bootstrap"]).factory("ChartService",["$window",function(a){var b=930,c=500,d={top:20,right:30,bottom:60,left:40},e=(b-d.left-d.right,c-d.top-d.bottom,{ONE_DAY_MILLIS:864e5,getSizeInfo:function(b){var c=angular.extend({},d,b),e=Math.round(.92*a.innerWidth),f=Math.round(.5376*e),g=e-c.left-c.right,h=f-c.top-c.bottom,i={width:g,height:h,margin:c};return console.log("sizing",i),i},leastSquares:function(a,b){var c=function(a,b){return a+b},d=1*a.reduce(c)/a.length,e=1*b.reduce(c)/b.length,f=a.map(function(a){return Math.pow(a-d,2)}).reduce(c),g=b.map(function(a){return Math.pow(a-e,2)}).reduce(c),h=a.map(function(a,c){return(a-d)*(b[c]-e)}).reduce(c),i=h/f,j=e-d*i,k=Math.pow(h,2)/(f*g);return[i,j,k]},approxY:function(a,b){var c=a[1],d=a[0];return c+d*b},filterSuspectSummaryData:function(a){var b=0===a.latitude||0===a.longitude||a.elevation_in_meters<0;return b&&console.warn("suspect station data",a),!b}});return e}]).directive("visDialog",[function(){return{restrict:"E",templateUrl:"js/vis/visDialog.html",transclude:!0,scope:{title:"@",modal:"="},controller:["$scope",function(){}]}}]).directive("visControl",["$modal",function(a){var b=[{title:"Scatter Plot",controller:"ScatterVisCtrl",template:"js/scatter/scatter.html",description:"This visualization allows you to plot various geographic or climactic variables on the X axis against Onset Day Of Year on the Y axis.  Up to three Species/Phenophase pairs may be plotted."},{title:"Calendar",controller:"CalendarVisCtrl",template:"js/calendar/calendar.html",description:'This visualization illustrates phenophase activity for various species/phenophase pairs of your choosing.  Horizontal bars are graphed representing a "calendar" of phenological activity at a regional level for up to two years allowing year to year comparison of activity.'}];return{restrict:"E",templateUrl:"js/vis/visControl.html",scope:{},controller:function(c){c.visualizations=b,c.open=function(b){a.open({templateUrl:b.template,controller:b.controller,windowClass:"vis-dialog-window",backdrop:"static",keyboard:!1,size:"lg"})}}}}]);