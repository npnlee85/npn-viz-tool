/*
 * USANPN-Visualization-Tool
 * Version: 1.0.0 - 2018-03-14
 */

angular.module("npn-viz-tool.vis-activity",["npn-viz-tool.vis","npn-viz-tool.filter","npn-viz-tool.filters","npn-viz-tool.settings","ui.bootstrap"]).factory("ActivityCurve",["$log","$filter","FilterService",function(e,t,n){var r=t("doy"),a=t("number"),i=t("speciesTitle"),o=function(e){return a(e,2)},s=[{id:"num_yes_records",sampleSize:"status_records_sample_size",label:"Total Yes Records",description:'The total number of reported "yes" (presence) records for the species and phenophase within the selected time period.'},{id:"proportion_yes_records",sampleSize:"status_records_sample_size",label:"Proportion Yes Records",description:'The number of "yes" (presence) records divided by the total number of records (presence and absence) for the species and phenophase within the selected time period.',valueFormat:o,proportion:!0}],l={Plantae:s.concat([{id:"proportion_individuals_with_yes_record",sampleSize:"individuals_sample_size",label:"Proportion Individuals with Yes Records",description:'The proportion of observed plant individuals of the species that have at least one "yes" record for the phenophase within the selected time period.',valueFormat:o,proportion:!0}]),Animalia:s.concat([{id:"proportion_sites_with_yes_record",sampleSize:"sites_sample_size",label:"Proportion Sites with Yes Records",description:'The proportion of observed sites that have at least one "yes" record for the species and phenophase within the selected time period.',valueFormat:o,proportion:!0},{id:"total_numanimals_in-phase",sampleSize:"in-phase_site_visits_sample_size",label:"Total Animals In Phase",description:"The sum of reported animal abundance for each site visit for the species and phenophase within the selected time period."},{id:"mean_numanimals_in-phase",sampleSize:"in-phase_per_hr_sites_sample_size",label:"Mean Animals In Phase",description:"The mean of reported animal abundance at each site visit for the species and phenophase within the selected time period.",valueFormat:o},{id:"mean_numanimals_in-phase_per_hr",sampleSize:"in-phase_per_hr_sites_sample_size",label:"Animals In Phase per Hour",description:'The mean of reported animal abundance corrected by the time spent searching for animals at each site visit for the species and phenophase within the selected time period. Site visits with a search method of "Incidental" or where no search time or method were reported are excluded.',valueFormat:o},{id:"mean_numanimals_in-phase_per_hr_per_acre",sampleSize:"phase_per_hr_per_acre_sites_sample_size",label:"Animals In Phase per Hour per Acre",description:'The mean of reported animal abundance corrected by the time spent searching and search area for animals at each site visit for the species and phenophase within the selected time period. Sites with no size reported and site visits with a search method other than "Area Search" or where no search time were reported are excluded.',valueFormat:o}])},c=function(e){var t,r,a,i,o,s,c=this;function d(){delete c.$data,delete c.$metricData}c.id=e,Object.defineProperty(this,"validPhenophases",{get:function(){return o}}),Object.defineProperty(this,"validMetrics",{get:function(){return s}}),Object.defineProperty(this,"year",{enumerable:!0,get:function(){return r},set:function(e){d(),r=e,t&&n.getFilter().getPhenophasesForSpecies(t.species_id,!0,[r]).then(function(e){o=e,c.phenophase=o.length?o[0]:void 0})}}),Object.defineProperty(this,"phenophase",{enumerable:!0,get:function(){return a},set:function(e){d(),a=e}}),Object.defineProperty(this,"metric",{enumerable:!0,get:function(){return i},set:function(e){d(),i=e}}),Object.defineProperty(this,"species",{enumerable:!0,get:function(){return t},set:function(e){d(),s=(t=e)&&t.kingdom&&l[t.kingdom]||[],c.metric&&-1===s.indexOf(c.metric)&&delete c.metric,s.length&&!c.metric&&(c.metric=s[0]),o=void 0,t&&n.getFilter().getPhenophasesForSpecies(t.species_id,!0,[r]).then(function(e){o=e,c.phenophase=o.length?o[0]:void 0})}})};return c.prototype.axisLabel=function(){return this.metric?this.metric.label:"?"},c.prototype.doyDataValue=function(){var e,t,n,r=this,a=r.data();if(r.doyFocus&&a)for(n=0;n<a.length;n++)if(t=a[n],r.doyFocus>=t.start_doy&&r.doyFocus<=t.end_doy)return e=(r.metric.valueFormat||angular.identity)(t[r.metric.id]),-9999!==t[r.metric.sampleSize]&&(e+=" N:"+t[r.metric.sampleSize]),e},c.prototype.legendLabel=function(e){var t=this.doyDataValue();return this.year+": "+i(this.species)+" - "+this.phenophase.phenophase_name+(e?" ("+this.metric.label+")":"")+(void 0!==t?" ["+t+"]":"")},c.prototype.metricId=function(){return this.metric?this.metric.id:void 0},c.prototype.data=function(t){if(arguments.length)return delete this.$data,delete this.$metricData,t&&(t.forEach(function(e){e.start_doy=r(e.start_date),e.end_doy=r(e.end_date)}),t.sort(function(e,t){return e.start_doy-t.start_doy}),this.$data=t),this;var n=this,a=n.$data;return a&&n.metric&&(n.$metricData?a=n.$metricData:(n.metric.sampleSize||e.warn("Metric does not define a sampleSize property, cannot filter out invalid data points."),(a=a.filter(function(e){return(!n.metric.sampleSize||-9999!==e[n.metric.sampleSize])&&-9999!==e[n.metric.id]})).length!==n.$data.length&&e.debug("filtered out "+(n.$data.length-a.length)+"/"+n.$data.length+" of -9999 records for metric ",n.metric),n.$metricData=a)),a},c.prototype.color=function(e){return arguments.length?(this.$color=e,this):this.$color},c.prototype.axisOrient=function(e){return arguments.length?(this.$orient=e,this):this.$orient},c.prototype.axis=function(){var e=this.y(),t=e.ticks(),n=d3.svg.axis().scale(e);return t.length&&(t[t.length-1]=e.domain()[1],n.tickValues(t)),n.orient(this.axisOrient()||"left")},c.prototype.x=function(e){return arguments.length?(this.$$x=e,this):this.$$x},c.prototype.y=function(e){return arguments.length?(this.$$y=e,this):this.$$y},c.prototype.isValid=function(){return this.species&&this.phenophase&&this.year&&this.metric},c.prototype.plotted=function(){return this.isValid()&&this.data()},c.prototype.shouldRevisualize=function(){return this.isValid()&&!this.data()},c.prototype.domain=function(){var t,n=this,r=n.data();if(r&&n.metric)return(t=d3.extent(r,function(e){return e[n.metric.id]}))[0]>0?t[0]=0:t[0]<0&&e.warn("negative domain start for metric",t,n.metric),t},c.prototype.draw=function(t){var n,r,a,i,o,s,l=this,c=l.data(),d=[[]];if(t.selectAll("path.curve.curve-"+l.id).remove(),t.selectAll("circle.curve-point.curve-point-"+l.id).remove(),c&&c.length){for(a=0;a<c.length;a++)i=c[a],o=a+1<c.length?c[a+1]:void 0,d[d.length-1].push(i),o&&o.start_doy!==i.end_doy+1&&d.push([]);n=l.x(),r=l.y();var u=function(e,t){return n(e.start_doy+Math.round((e.end_doy-e.start_doy)/2))},p=function(e){return r(e[l.metric.id])};s=d3.svg.line().interpolate(l.interpolate||"monotone").x(u).y(p),e.debug("ActivityCurve.draw",l.species,l.phenophase,l.year,l.metric,l.domain(),r.domain()),e.debug("draw.datas",d),d.forEach(function(e,n){(1===e.length||l.dataPoints)&&e.forEach(function(e){t.append("circle").attr("class","curve-point curve-point-"+l.id).attr("r",3).attr("fill",l.color()).attr("cx",u(e)).attr("cy",p(e))}),e.length>1&&t.append("path").attr("class","curve curve-"+l.id).attr("fill","none").attr("stroke",l.color()).attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1.5).attr("d",s(e))})}},c}]).controller("ActivityCurvesVisCtrl",["$scope","$q","$uibModalInstance","$timeout","$log","$filter","ActivityCurve","FilterService","ChartService",function(e,t,n,r,a,i,o,s,l){function c(){e.selection.$updateCount>0&&!e.selection.shouldRevisualize()&&e.selection.$updateCount++}e.modal=n,e.frequencies=[{value:"months",label:"Monthly"},{value:14,label:"Bi-weekly"},{value:7,label:"Weekly"}],e.selection={$updateCount:0,interpolate:"monotone",dataPoints:!0,curves:[{color:"#0000ff",orient:"left"},{color:"orange",orient:"right"}].map(function(e,t){return new o(t).color(e.color).axisOrient(e.orient)}),frequency:e.frequencies[0],shouldRevisualize:function(){return e.selection.curves.reduce(function(e,t){return e||t.shouldRevisualize()},!1)}},e.$watch(function(){return e.selection.shouldRevisualize()},function(t){t&&e.visualize()}),e.$watch("selection.frequency",function(t){e.selection.curves.forEach(function(e){e.data(null)})}),e.$watch("selection.interpolate",function(t){e.selection.curves.forEach(function(e){t?e.interpolate=t:delete e.interpolate,c()})}),e.$watch("selection.dataPoints",function(t){e.selection.curves.forEach(function(e){e.dataPoints=t}),c()}),e.$watch("selection.curves[0].metric",c),e.$watch("selection.curves[1].metric",c),e.visualize=function(){var n=e.selection.curves.filter(function(e){return e.data(null).isValid()}).map(function(n){var r,o,s=t.defer(),c={request_src:"npn-vis-activity-curves",start_date:n.year+"-01-01",end_date:(r=n.year,o=new Date,r===o.getFullYear()?i("date")(o,"yyyy-MM-dd"):r+"-12-31"),frequency:e.selection.frequency.value,"species_id[0]":n.species.species_id,"phenophase_id[0]":n.phenophase.phenophase_id};return a.debug("params",c),e.working=!0,l.getMagnitudeData(c,function(e){s.resolve(n.data(e))}),s.promise});t.all(n).then(function(){a.debug("all activity data has arrived"),e.selection.$updateCount++,delete e.working})}}]).directive("activityCurveControl",["$log","FilterService",function(e,t){return{restrict:"E",templateUrl:"js/activity/curve-control.html",scope:{input:"="},link:function(n){n.validYears=function(e){for(var t=(new Date).getFullYear(),n=[];e<=t;)n.push(e++);return n}(2010),n.input.year=n.validYears[n.validYears.length-2],t.getFilter().getSpeciesList().then(function(t){e.debug("speciesList",t),n.speciesList=t,t.length&&0===n.input.id&&(n.input.species=n.input.id<t.length?t[n.input.id]:t[0])})}}}]).directive("activityCurvesChart",["$log","$timeout","$filter","ChartService",function(e,t,n,r){function a(e){for(var t=1,n=[];t<=365;)n.push(t),t+=e;return n}var i={7:{rotate:45,values:a(14)},14:{rotate:45,values:a(28)},months:{values:[1,32,60,91,121,152,182,213,244,274,305,335]}},o=new Date(2010,0),s=n("legendDoy");return{restrict:"E",replace:!0,template:'<div class="chart-container"><vis-download ng-if="selection.$updateCount > 0" selector=".chart" filename="npn-activity-curves.png"></vis-download><div><svg class="chart"></svg></div></div>',scope:{selection:"="},link:function(n){var a,l=n.selection,c=14,d=r.getSizeInfo({top:80,left:80,right:80,bottom:80}),u=d3.time.format("%m/%d"),p=d3.scale.linear().range([0,d.width]).domain([1,365]),g=d3.svg.axis().scale(p).orient("bottom").tickFormat(function(e){var t=(e-1)*r.ONE_DAY_MILLIS+o.getTime(),n=new Date(t);return u(n)}),f=function(){return d3.scale.linear().range([d.height,0]).domain([0,100])};function h(){if(!l.curves[1].isValid()||l.curves[0].metricId()===l.curves[1].metricId())return l.curves[0].metric}function m(){function t(e,t){return e&&2===e.length&&(e=[e[0],1.05*e[1]],t&&t.proportion&&e[1]>1&&(e[1]=1)),e}a.selectAll("g .axis").remove();var n=h();if(n){var r=d3.extent(l.curves.reduce(function(e,t){return t.isValid()&&(e=e.concat(t.domain())),e},[])),o=f().domain(t(r,n));e.debug("ActivityCurves.common domain",r),l.curves.forEach(function(e){e.y(o)})}else l.curves.forEach(function(e){e.isValid()&&e.y(f().domain(t(e.domain(),e.metric)))});a.append("g").attr("class","y axis left").call(l.curves[0].axis()).append("text").attr("class","axis-title").attr("transform","rotate(-90)").attr("y","0").attr("dy","-4em").attr("x",d.height/2*-1).style("text-anchor","middle").text(l.curves[0].axisLabel()),n||a.append("g").attr("class","y axis right").attr("transform","translate("+d.width+")").call(l.curves[1].axis()).append("text").attr("class","axis-title").attr("transform","rotate(-90)").attr("y","0").attr("dy","4em").attr("x",d.height/2*-1).style("text-anchor","middle").text(l.curves[1].axisLabel());var s=i[l.frequency.value];g.tickValues(s.values),a.append("g").attr("class","x axis").attr("transform","translate(0,"+d.height+")").call(g).append("text").attr("y","0").attr("dy","3em").attr("x",d.width/2).attr("class","axis-label").style("text-anchor","middle").text("Date"),s.rotate&&(a.selectAll("g.x.axis g.tick text").style("text-anchor","end").attr("transform","rotate(-"+s.rotate+")"),a.selectAll("g.x.axis .axis-label").attr("dy","4em")),a.selectAll(".axis path").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),a.selectAll(".axis line").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),a.selectAll("text").style("font-family","Arial"),a.selectAll("g .x.axis text").style("font-size",c+"px"),a.selectAll("g .y.axis text").style("font-size",c+"px"),n||(a.selectAll("g.y.axis.left g.tick text").style("fill",l.curves[0].color()),a.selectAll("g.y.axis.left text.axis-title").style("fill",l.curves[0].color()),a.selectAll("g.y.axis.right g.tick text").style("fill",l.curves[1].color()),a.selectAll("g.y.axis.right text.axis-title").style("fill",l.curves[1].color())),l.curves.forEach(function(e){e.draw(a)}),v()}function v(){a.select(".legend").remove();var e=h(),t=a.append("g").attr("class","legend").attr("transform","translate(150,-"+(d.margin.top-10)+")").style("font-size","1em");l.curves.reduce(function(n,r){var a;return r.plotted()&&((a=t.append("g").attr("class","legend-item curve-"+r.id).attr("transform","translate(10,"+((n+1)*c+4*n)+")")).append("circle").attr("r",5).attr("fill",r.color()),a.append("text").style("font-size",c+"px").attr("x",10).attr("y",2.5).text(r.legendLabel(!e)),n++),n},0)}l.curves.forEach(function(e){e.x(p).y(f())}),t(function(){var e=d3.select(".chart").attr("width",d.width+d.margin.left+d.margin.right).attr("height",d.height+d.margin.top+d.margin.bottom);e.append("g").append("rect").attr("width","100%").attr("height","100%").attr("fill","#fff"),(a=e.append("g").attr("transform","translate("+d.margin.left+","+d.margin.top+")")).append("g").attr("class","chart-title").append("text").attr("y","0").attr("dy","-3em").attr("x","0").style("text-anchor","start").style("font-size","18px").text("Activity Curves"),e.append("g").append("text").attr("dx",5).attr("dy",d.height+136).attr("font-size","11px").attr("font-style","italic").attr("text-anchor","right").text("USA National Phenology Network, www.usanpn.org"),m();var t=e.append("g").attr("transform","translate("+d.margin.left+","+d.margin.top+")").style("display","none"),n=t.append("line").attr("class","focus").attr("fill","none").attr("stroke","green").attr("stroke-width",1).attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",d.height),r=t.append("text").attr("class","focus-doy").attr("y",10).attr("x",0).text("hover doy");e.append("rect").attr("class","overlay").attr("transform","translate("+d.margin.left+","+d.margin.top+")").style("fill","none").style("pointer-events","all").attr("x",0).attr("y",0).attr("width",d.width).attr("height",d.height).on("mouseover",function(){l.curves.reduce(function(e,t){return e||t.plotted()},!1)&&t.style("display",null)}).on("mouseout",function(){l.curves.forEach(function(e){delete e.doyFocus}),t.style("display","none"),v()}).on("mousemove",function(){var e=d3.mouse(this),t=e[0],a=(e[1],Math.round(p.invert(t))),i=l.curves.reduce(function(e,t){return!e&&t.plotted()&&(e=t.data().reduce(function(e,t){return e||(a>=t.start_doy&&a<=t.end_doy?t:void 0)},void 0)),e},void 0);n.attr("transform","translate("+t+")"),r.style("text-anchor",a<324?"start":"end").attr("x",t+10*(a<324?1:-1)).text(i?s(i.start_doy)+" - "+s(i.end_doy):s(a)),l.curves.forEach(function(e){e.doyFocus=a}),v()})}),n.$watch("selection.$updateCount",function(e){e>0&&m()})}}}]),angular.module("npn-viz-tool.bounds",["npn-viz-tool.filter","uiGmapgoogle-maps"]).service("RestrictedBoundsService",["$log","$location","uiGmapGoogleMapApi",function(e,t,n){var r=t.search().allowedBounds,a={},i={getRestrictor:function(e,t){return a[e]||(a[e]=new o(e)),a[e].setBounds(t),a[e]}},o=function(t){this.key=t;var n=this;n.center_changed=function(t,a,i){e.debug("["+n.key+"].center_changed"),n.bounds?(r&&!n.rectangle&&(n.rectangle=new google.maps.Rectangle({strokeColor:"#FFF",strokeOpacity:.8,strokeWeight:2,fillColor:"#FFF",fillOpacity:.35,map:t,bounds:n.bounds})),n.bounds.contains(t.getCenter())?n.lastValidCenter=t.getCenter():(e.debug("["+n.key+"] attempted to pan center out of bounds, panning back to ",n.lastValidCenter),t.panTo(n.lastValidCenter))):e.debug("["+n.key+"] no bounds set ignoring.")}};return o.prototype.setBounds=function(t){e.debug("["+this.key+"].setBounds:",t),this.bounds=t,this.lastValidCenter=t?t.getCenter():void 0,this.rectangle&&this.rectangle.setMap(null),this.rectangle=void 0},o.prototype.getBounds=function(){return this.bounds},i}]).directive("boundsManager",["$rootScope","$log","uiGmapGoogleMapApi","FilterService","BoundsFilterArg",function(e,t,n,r,a){return{restrict:"E",template:'<ui-gmap-drawing-manager ng-if="!isFilterEmpty()" options="options" control="control"></ui-gmap-drawing-manager>',controller:["$scope",function(i){function o(){r.getFilter().hasSufficientCriteria()&&e.$broadcast("filter-rerun-phase2",{})}i.isFilterEmpty=r.isFilterEmpty,n.then(function(e){var n=e,s={drawingModes:[n.drawing.OverlayType.RECTANGLE],position:n.ControlPosition.TOP_RIGHT,drawingControl:!1};t.debug("api",e),i.options={drawingControlOptions:s,rectangleOptions:a.RECTANGLE_OPTIONS},i.control={},i.$on("bounds-filter-ready",function(e,t){n.event.addListener(t.filter.arg,"mouseover",function(){t.filter.arg.setOptions(angular.extend({},a.RECTANGLE_OPTIONS,{strokeWeight:2}))}),n.event.addListener(t.filter.arg,"mouseout",function(){t.filter.arg.setOptions(a.RECTANGLE_OPTIONS)}),n.event.addListener(t.filter.arg,"rightclick",function(){r.removeFromFilter(t.filter),o()})}),i.$watch("control.getDrawingManager",function(){if(i.control.getDrawingManager){var e=i.control.getDrawingManager();n.event.addListener(e,"rectanglecomplete",function(t){e.setDrawingMode(null),r.addToFilter(new a(t)),o()}),i.$on("filter-reset",function(t,n){s.drawingControl=!1,e.setOptions(s)}),i.$on("filter-update",function(t,n){s.drawingControl=r.hasSufficientCriteria(),e.setOptions(s)})}})})}]}}]),angular.module("npn-viz-tool.vis-cache",["angular-md5"]).factory("CacheService",["$log","$timeout","md5",function(e,t,n){var r=[];return{keyFromObject:function(e){return n.createHash(JSON.stringify(e))},dump:function(){e.debug("cache",r)},put:function(n,a){if(null!=n){if(null==a)return e.debug("removing cached object '"+n+"'",r[n]),void(r[n]=null);var i=arguments.length>2?arguments[2]:3e5,o=i<0?-1:(new Date).getTime()+i;e.debug("caching (expiry:"+o+") '"+n+"'",a),r[n]={data:a,expiry:o},i>0&&t(function(){e.debug("expiring cached object '"+n+"'",r[n]),r[n]=null},i)}},get:function(t){var n=r[t];return null==n?arguments.length>1?arguments[1]:null:n.expiry<0||n.expiry>(new Date).getTime()?(e.debug("cache entry '"+t+"' is valid returning."),n.data):(e.debug("cache entry '"+t+"' has expired."),delete r[t],arguments.length>1?arguments[1]:null)}}}]),angular.module("npn-viz-tool.vis-calendar",["npn-viz-tool.vis","npn-viz-tool.filter","npn-viz-tool.filters","ui.bootstrap"]).controller("CalendarVisCtrl",["$scope","$uibModalInstance","$http","$timeout","$filter","$log","FilterService","ChartService",function(e,t,n,r,a,i,o,s){o.getFilter().getDateArg();var l,c,d,u=s.getSizeInfo({top:20,right:35,bottom:45,left:35}),p=d3.time.format("%B"),g=d3.scale.ordinal().rangeBands([0,u.width]).domain(d3.range(1,366)),f=d3.svg.axis().scale(g).orient("bottom").tickValues(function(){var e,t=[1],n=1;for(e=1;e<12;e++){var r=new Date(1900,e);r.setTime(r.getTime()-s.ONE_DAY_MILLIS),n+=r.getDate(),t.push(n)}return g.domain().filter(function(e){return-1!==t.indexOf(e)})}()).tickFormat(function(e){var t=new Date(1900,0);return t.setTime(t.getTime()+s.ONE_DAY_MILLIS*e),p(t)}),h=d3.scale.ordinal().rangeBands([u.height,0]).domain(d3.range(0,6)),m=d3.svg.axis().scale(h).orient("right").tickSize(u.width).tickFormat(function(e){return e}).tickFormat(function(e){return c&&c.labels&&e<c.labels.length?c.labels[e]:""});e.validYears=d3.range(1900,(new Date).getFullYear()+1),e.modal=t;var v=o.getColorScale();function y(){i.debug("Calling phenophase list update"),e.phenophaseList=[];var t=e.selection.species.species_id,n=e.selection.year;t&&n&&(e.phenophaseList=[],o.getFilter().getPhenophasesForSpecies(t,!0,[n]).then(function(t){i.debug("phenophaseList",t),t.length&&(t.splice(0,0,{phenophase_id:-1,phenophase_name:"All phenophases"}),e.selection.phenophase=t.length?t[0]:void 0),e.phenophaseList=t}))}function b(t){i.debug("addToPlot",t),t&&(-1===t.phenophase_id?(i.debug("add all phenophases..."),function(t){for(;;){var n,r=-1;for(n=0;n<e.toPlot.length;n++)if(e.toPlot[n].species_id===t){r=n;break}if(-1===r)break;e.removeFromPlot(r)}}(t.species_id),e.phenophaseList.filter(function(e){return-1!==e.phenophase_id}).forEach(function(t){b(angular.extend(e.selection.species,t))})):(e.toPlot.push(w(t)),e.selection.color<e.colors.length?e.selection.color++:e.selection.color=0),e.data=c=void 0)}function w(t){var n=t||angular.extend({},e.selection.species,e.selection.phenophase);return angular.extend({},n,{color:e.selection.color})}function x(){var e=d3.select(".chart");e.selectAll("g .y.axis line").style("stroke","#777").style("stroke-dasharray","2,2"),e.selectAll(".axis path").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),e.selectAll(".axis line").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),e.selectAll("text").style("font-family","Arial")}function k(t){var n=-1*(h.rangeBand()/2+e.yAxisConfig.labelOffset);t.selectAll("text").attr("x",0).attr("dy",n).attr("style","text-anchor: start; font-size: "+e.yAxisConfig.fontSize+"px;")}function _(e,t,n){return Number((e+t).toFixed(n))}e.colors=v.domain(),e.colorRange=v.range(),e.selection={color:0,year:(new Date).getFullYear(),netagive:!1},e.toPlotYears=[],e.toPlot=[],o.getFilter().getSpeciesList().then(function(t){i.debug("speciesList",t),e.speciesList=t,t.length&&(e.selection.species=t[0])}),e.$watch("selection.species",y),e.$watch("selection.year",y),e.canAddToPlot=function(){if(!e.selection.species||!e.selection.phenophase)return!1;if(0===e.toPlot.length)return!0;var t,n=w();for(t=0;t<e.toPlot.length;t++)if(angular.equals(e.toPlot[t],n))return!1;return!0},e.addToPlot=function(){b(w())},e.removeFromPlot=function(t){e.toPlot.splice(t,1),e.data=c=void 0},e.addYear=function(){e.selection.year&&(e.toPlotYears.push(e.selection.year),e.toPlotYears.sort(),e.data=c=void 0)},e.canAddYear=function(){return e.toPlotYears.length<2&&e.selection.year&&-1===e.toPlotYears.indexOf(e.selection.year)&&-1!==e.validYears.indexOf(e.selection.year)},e.removeYear=function(t){e.toPlotYears.splice(t,1),e.data=c=void 0},r(function(){var e=d3.select(".chart").attr("width",u.width+u.margin.left+u.margin.right).attr("height",u.height+u.margin.top+u.margin.bottom);e.append("g").append("rect").attr("width","100%").attr("height","100%").attr("fill","#fff"),(d=e.append("g").attr("transform","translate("+u.margin.left+","+u.margin.top+")")).append("g").attr("class","x axis").attr("transform","translate(0,"+u.height+")").call(f),d.append("g").attr("class","y axis").call(m).call(k),d.selectAll("g .x.axis text").attr("style","font-size: 14px"),d.selectAll("g .y.axis path").style("display","none"),e.append("g").append("text").attr("dx",5).attr("dy",u.height+61).attr("font-size","11px").attr("font-style","italic").attr("text-anchor","right").text("USA National Phenology Network, www.usanpn.org"),x()},500),e.yAxisConfig={labelOffset:4,bandPadding:.5,fontSize:14},e.$watch("yAxisConfig.labelOffset",$),e.$watch("yAxisConfig.bandPadding",$),e.$watch("yAxisConfig.fontSize",$),e.incrBandPadding=function(){e.yAxisConfig.bandPadding=_(e.yAxisConfig.bandPadding,.05,2)},e.decrBandPadding=function(){e.yAxisConfig.bandPadding=_(e.yAxisConfig.bandPadding,-.05,2)},e.incrFontSize=function(){e.yAxisConfig.fontSize++},e.decrFontSize=function(){e.yAxisConfig.fontSize--};var S="#aaa";function $(){if(c){e.working=!0,g.rangeBands([0,u.width],-.1,.5),f.scale(g),d.selectAll("g .x.axis").call(f),h.rangeBands([u.height,0],e.yAxisConfig.bandPadding,.5),c&&c.labels&&h.domain(d3.range(0,c.labels.length)),m.scale(h),d&&d.selectAll("g .y.axis").call(m).call(k);var t=d.selectAll(".doy").data(c.data,function(e){return e.y+"-"+e.x+"-"+e.color});t.exit().remove(),t.enter().insert("line",":first-child").attr("class","doy");var n=Math.ceil(g.rangeBand()/2),r=h.rangeBand()/2;t.attr("x1",function(e){return g(e.x)-n}).attr("y1",function(e,t){return h(e.y)+r}).attr("x2",function(e){return g(e.x)+n}).attr("y2",function(e,t){return h(e.y)+r}).attr("doy-point",function(e){return"("+e.x+","+e.y+")"}).attr("stroke",function(t){return t.color===S?S:e.colorRange[t.color]}).attr("stroke-width",h.rangeBand()).append("title").text(function(e){return e.x}),x(),e.working=!1}}function C(){if(l){if(l.error_message)return i.warn("Received error",l),e.error_message=l.error_message,void(e.working=!1);var t={},n={labels:[],data:[]},r=e.toPlot.length*e.toPlotYears.length-1;angular.forEach(l,function(e){t[e.species_id]=e;var n={};angular.forEach(e.phenophases,function(e){n[e.phenophase_id]=e}),e.phenophases=n}),i.debug("speciesMap",t),angular.forEach(e.toPlot,function(s){i.debug("toPlot",s);var l=t[s.species_id],c=l.phenophases[s.phenophase_id];angular.forEach(e.toPlotYears,function(t){c&&c.years&&c.years[t]&&(e.selection.negative&&(i.debug("year negative",r,t,l.common_name,c,c.years[t].negative),o(c.years[t].negative,S)),i.debug("year positive",r,t,l.common_name,c,c.years[t].positive),o(c.years[t].positive,s.color)),n.labels.splice(0,0,a("speciesTitle")(s)+"/"+s.phenophase_name+" ("+t+")"),i.debug("y of "+r+" is for "+n.labels[0]),r--})}),e.data=c=n,i.debug("calendar data",c),$()}function o(e,t){angular.forEach(e,function(e){n.data.push({y:r,x:e,color:t})})}}e.$watch("selection.negative",C),e.visualize=function(){if(c)return $();e.working=!0,i.debug("visualize",e.selection.axis,e.toPlot);o.getFilter().getDateArg();var t={request_src:"npn-vis-calendar"},n={};e.toPlotYears.forEach(function(e,n){t["year["+n+"]"]=e}),angular.forEach(e.toPlot,function(e,r){n[e.species_id+"."+e.phenophase_id]=e.color,t["species_id["+r+"]"]=e.species_id,t["phenophase_id["+r+"]"]=e.phenophase_id}),e.error_message=void 0,s.getObservationDates(t,function(e){l=e,C()})}}]),angular.module("npn-viz-tool.cluster",[]).factory("ClusterService",[function(){return{getDefaultClusterOptions:function(){return{styles:[0,1,2,4,8,16,32,64,128,256].map(function(e){return{n:1e3*e,url:"cluster/m"+e+".png",width:52,height:52,textColor:"#fff"}}),maxZoom:12}}}}]),angular.module("npn-viz-tool.export",["npn-viz-tool.filter"]).directive("exportControl",["$log","$http","$window","FilterService",function(e,t,n,r){return{restrict:"E",template:'<a title="Export" href id="export-control" class="btn btn-default btn-xs" ng-disabled="!getFilteredMarkers().length" ng-click="exportData()"><i class="fa fa-download"></i></a>',controller:["$scope",function(a){a.getFilteredMarkers=r.getFilteredMarkers,a.exportData=function(){var a=r.getFilter(),i=a.getDateArg().toExportParam();i.downloadType="selectable",i.searchSource="visualization-tool",i.endDate=i.endYear+"-12-31",a.getSpeciesArgs().length&&(i.species=[],a.getSpeciesArgs().forEach(function(e){i.species.push(e.getId())})),a.getNetworkArgs().length&&(i.partnerGroups=[],a.getNetworkArgs().forEach(function(e){i.partnerGroups.push(e.getId())})),a.getGeographicArgs().length&&(i.stations=[],r.getFilteredMarkers().forEach(function(e,t){i.stations.push(e.station_id)})),e.debug("export.params",i);var o="",s="";location.hostname.includes("local")?(o="https://data-dev.usanpn.org",s="https://data-dev.usanpn.org"):location.hostname.includes("dev")?(o="https://data-dev.usanpn.org",s="https://data-dev.usanpn.org"):(o="https://data.usanpn.org",s="https://data.usanpn.org"),t({method:"POST",url:s+":3002/pop/search",data:{searchJson:i}}).then(function(e){location.hostname.includes("local")?n.open(o+":8080?search="+e.data.saved_search_hash):(console.log(o+"/observations?search="+e.data.saved_search_hash),n.open(o+"/observations?search="+e.data.saved_search_hash))})}}]}}]),angular.module("npn-viz-tool.filter",["npn-viz-tool.settings","npn-viz-tool.stations","npn-viz-tool.cluster","npn-viz-tool.vis-cache","npn-viz-tool.help","angular-md5","isteven-multi-select"]).factory("FilterArg",[function(){var e=function(e){this.arg=e};return e.prototype.getArg=function(){return this.arg},e.prototype.$filter=function(e){return!0},e.prototype.$removed=function(){},e}]).factory("DateFilterArg",["FilterArg",function(e){var t=function(t){t&&(t.start_date&&"number"!=typeof t.start_date&&(t.start_date=parseInt(t.start_date)),t.end_date&&"number"!=typeof t.end_date&&(t.end_date=parseInt(t.end_date))),e.apply(this,arguments)};return t.prototype.getId=function(){return"date"},t.prototype.getStartYear=function(){return this.arg.start_date},t.prototype.getStartDate=function(){return this.arg.start_date+"-01-01"},t.prototype.getEndYear=function(){return this.arg.end_date},t.prototype.getEndDate=function(){return this.arg.end_date+"-12-31"},t.prototype.toExportParam=function(){return{startDate:this.arg.start_date+"-01-01",endDate:this.arg.end_date+"-01-01",startYear:this.arg.start_date,startMonth:"January",startDay:1,endYear:this.arg.end_date,endMonth:"January",endDay:1,rangeType:"Calendar"}},t.prototype.toString=function(){return this.arg.start_date+"-"+this.arg.end_date},t.fromString=function(e){var n=e.indexOf("-");return new t({start_date:e.substring(0,n),end_date:e.substring(n+1)})},t}]).factory("NetworkFilterArg",["$http","$rootScope","$log","$url","FilterArg","SpeciesFilterArg","SettingsService",function(e,t,n,r,a,i,o){var s=function(e){a.apply(this,arguments),this.counts={station:"?",observation:"?"},this.stations=[],this.ydo=arguments.length>1?arguments[1]:o.getSettingValue("onlyYesData"),n.debug("NetworkFilterArg",this.arg,this.ydo);t.$broadcast("network-filter-ready",{filter:this})};return s.prototype.getId=function(){return parseInt(this.arg.network_id)},s.prototype.getName=function(){return this.arg.network_name},s.prototype.toExportParam=function(){return this.getId()},s.prototype.resetCounts=function(e){this.counts.station=this.counts.observation=e,this.stations=[]},s.prototype.updateCounts=function(e,t,n){var r,a,o=this.getId(),s=0;if(-1!==e.networks.indexOf(o)){-1===this.stations.indexOf(e.station_id)&&(this.stations.push(e.station_id),this.counts.station++);for(r in t)(t[r].$match||n)&&(a=i.countObservationsForPhenophase.call(this,t[r]),n&&(e.observationCount+=a),this.counts.observation+=a,s+=a)}return s},s.prototype.toString=function(){var e=this.arg.network_id;return this.ydo&&(e+=":1"),e},s.fromString=function(t){var a=t.split(":"),i=a.length>1?a[0]:t,o=2===a.length?"1"===a[1]:void 0;return e.get(r("/npn_portal/networks/getPartnerNetworks.json"),{params:{active_only:!0}}).then(function(e){for(var r=e.data,a=0;r&&a<r.length;a++)if(i==r[a].network_id)return o?new s(r[a],o):new s(r[a]);n.warn("NO NETWORK FOUND WITH ID "+t)})},s}]).factory("SpeciesFilterArg",["$http","$rootScope","$log","$url","FilterArg","SettingsService",function(e,t,n,r,a,i){var o=function(o,s){a.apply(this,arguments),this.counts={station:"?",observation:"?"},s&&"*"!=s&&(this.phenophaseSelections=s.split(",")),this.ydo=arguments.length>2?arguments[2]:i.getSettingValue("onlyYesData"),n.debug("SpeciesFilterArg:",o,this.phenophaseSelections,this.ydo);var l=this;e.get(r("/npn_portal/phenophases/getPhenophasesForSpecies.json"),{params:{return_all:!0,species_id:l.arg.species_id}}).then(function(e){var n=e.data,r={};l.phenophases=n[0].phenophases.filter(function(e){return!r[e.phenophase_id]&&(r[e.phenophase_id]=e,e.selected=!l.phenophaseSelections||-1!=l.phenophaseSelections.indexOf(e.phenophase_id),!0)}),l.phenophasesMap={},angular.forEach(l.phenophases,function(e){l.phenophasesMap[e.phenophase_id]=e}),t.$broadcast("species-filter-ready",{filter:l})})};return o.countObservationsForPhenophase=function(e){var t=this||{},n=0;return e.y&&(n+=e.y),t.ydo||(e.n&&(n+=e.n),e.q&&(n+=e.q)),n},o.prototype.getId=function(){return parseInt(this.arg.species_id)},o.prototype.getPhenophaseList=function(){return angular.copy(this.phenophases)},o.prototype.resetCounts=function(e){this.counts.station=this.counts.observation=e,angular.forEach(this.phenophases,function(e){e.count=0})},o.prototype.$filter=function(e){var t=this,r=0;return Object.keys(e).filter(function(a){if(!t.phenophasesMap[a])return n.error("phenophase_id: "+a+" not found for species: "+t.arg.species_id),!1;var i=o.countObservationsForPhenophase.call(t,e[a]);return t.phenophasesMap[a].count+=i,e[a].$match=t.phenophasesMap[a].selected,e[a].$match&&(r+=i),e[a].$match}).length>0&&t.counts.station++,t.counts.observation+=r,r},o.prototype.toExportParam=function(){var e={species_id:this.getId(),common_name:this.arg.common_name},t=this.phenophases.filter(function(e){return e.selected});return t.length!==this.phenophases.length&&(e.phenophases=t.map(function(e){return parseInt(e.phenophase_id)})),e},o.prototype.toString=function(){var e=this.arg.species_id+":",t=this.phenophases.filter(function(e){return e.selected});return t.length===this.phenophases.length?e+="*":t.forEach(function(t,n){e+=(n>0?",":"")+t.phenophase_id}),this.ydo&&(e+=":1"),e},o.fromString=function(t){var n=t.split(":"),a=n[0],i=n[1],s=3===n.length?"1"===n[2]:void 0;return e.get(r("/npn_portal/species/getSpeciesById.json"),{params:{species_id:a}}).then(function(e){return e.data.species_id=a,s?new o(e.data,i,s):new o(e.data,i)})},o}]).factory("GeoFilterArg",["FilterArg",function(e){var t=function(t,n){e.apply(this,arguments),this.sourceId=n};return t.prototype.getId=function(){return this.arg.getProperty("NAME")},t.prototype.getSourceId=function(){return this.sourceId},t.prototype.getUid=function(){return this.getSourceId()+"-"+this.getId()},t.prototype.$filter=function(e){return function e(t,n){var r,a,i,o=n.getType();if("Polygon"==o){for(a=n.getArray(),i=0;i<a.length;i++)if(r=new google.maps.Polygon({paths:a[i].getArray()}),google.maps.geometry.poly.containsLocation(t,r)||google.maps.geometry.poly.isLocationOnEdge(t,r))return!0}else if("MultiPolygon"===o||"GeometryCollection"==o)for(a=n.getArray(),i=0;i<a.length;i++)if(e(t,a[i]))return!0;return!1}(new google.maps.LatLng(parseFloat(e.latitude),parseFloat(e.longitude)),this.arg.getGeometry())},t.prototype.toString=function(){return this.sourceId+":"+this.arg.getProperty("NAME")},t}]).factory("BoundsFilterArg",["$rootScope","FilterArg",function(e,t){var n=function(n){t.apply(this,arguments);e.$broadcast("bounds-filter-ready",{filter:this})};return n.RECTANGLE_OPTIONS={strokeColor:"#fff",strokeWeight:1,fillColor:"#000080",fillOpacity:.25,visible:!0,zIndex:1},n.prototype.getId=function(){return this.arg.getBounds().getCenter().toString()},n.prototype.getUid=function(){return this.getId()},n.prototype.$filter=function(e){return this.arg.getBounds().contains(new google.maps.LatLng(parseFloat(e.latitude),parseFloat(e.longitude)))},n.prototype.$removed=function(){this.arg.setMap(null)},n.prototype.toString=function(){var e=this.arg.getBounds(),t=e.getSouthWest(),n=e.getNorthEast();return t.lat().toFixed(4)+","+t.lng().toFixed(4)+":"+n.lat().toFixed(4)+","+n.lng().toFixed(4)},n.fromString=function(e,t){var r=e.split(":"),a=r[0].split(","),i=new google.maps.LatLng(parseFloat(a[0]),parseFloat(a[1])),o=r[1].split(","),s=new google.maps.LatLng(parseFloat(o[0]),parseFloat(o[1])),l=new google.maps.LatLngBounds(i,s),c=new google.maps.Rectangle(n.RECTANGLE_OPTIONS);return c.setBounds(l),c.setMap(t),new n(c)},n}]).factory("NpnFilter",["$q","$log","$http","$url","$filter","DateFilterArg","SpeciesFilterArg","NetworkFilterArg","GeoFilterArg","BoundsFilterArg","CacheService","Analytics",function(e,t,n,r,a,i,o,s,l,c,d,u){function p(e){var t,n=[];for(t in e)n.push(e[t]);return n}var g=function(){this.reset()};function f(e){return e&&Object.keys(e).forEach(function(t){e[t].$removed&&e[t].$removed()}),{}}function h(e){var t=[];return e.filter(function(e){return!t[e.phenophase_id]&&(t[e.phenophase_id]=e,!0)})}function m(e){return h(e.reduce(function(e,t){return e.concat(t)},[]))}function v(t,a){var i=e.defer(),o={date:a,species_id:t},s=d.keyFromObject(o),l=d.get(s);return l?i.resolve(l):n.get(r("/npn_portal/phenophases/getPhenophasesForSpecies.json"),{params:o}).then(function(e){var t=e.data[0].phenophases;t=h(t),d.put(s,t),i.resolve(t)},i.reject),i.promise}function y(n,r){var a=e.defer(),i=r.map(function(r){return a=n,i=r,o=e.defer(),e.all([v(a,i+"-12-31"),v(a,i+"-01-01")]).then(function(e){t.debug("getPhenophasesForYear.results",e),o.resolve(m(e))}),o.promise;var a,i,o});return e.all(i).then(function(e){t.debug("getPhenophasesForYears.results",e),a.resolve(m(e))}),a.promise}return g.prototype.hasDate=function(){return!!this.date},g.prototype.hasCriteria=function(){return!!this.date||(Object.keys(this.species).length>0||Object.keys(this.networks).length>0)},g.prototype.hasSufficientCriteria=function(){return this.date&&(Object.keys(this.species).length>0||Object.keys(this.networks).length>0)},g.prototype.getUpdateCount=function(){return this.updateCount},g.prototype.getDateArg=function(){return this.date},g.prototype.getSpeciesArg=function(e){return this.species[e]},g.prototype.getSpeciesArgs=function(){return p(this.species)},g.prototype.getNetworkArg=function(e){return this.networks[e]},g.prototype.getNetworkArgs=function(){return p(this.networks)},g.prototype.getCriteria=function(){var e=p(this.species);return this.date&&e.append(this.date),e},g.prototype.getGeoArgs=function(){return p(this.geo)},g.prototype.getBoundsArgs=function(){return p(this.bounds)},g.prototype.getGeographicArgs=function(){return this.getBoundsArgs().concat(this.getGeoArgs())},g.prototype.ga=function(e){e=e||"execute";var t=this.getDateArg(),n=a("speciesTitle"),r=this.getBoundsArgs().length;t&&u.trackEvent("filter",e+" date",t.getStartYear()+"-"+t.getEndYear()),this.getSpeciesArgs().forEach(function(t){u.trackEvent("filter",e+" species",n(t.arg,"common-name"))}),this.getNetworkArgs().forEach(function(t){u.trackEvent("filter",e+" network",t.getName())}),this.getGeoArgs().forEach(function(t){u.trackEvent("filter",e+" geo",t.getUid())}),r&&u.trackEvent("filter",e+" bounds",r)},g.prototype.add=function(e){return this.updateCount++,e instanceof i?this.date=e:e instanceof o?this.species[e.getId()]=e:e instanceof s?this.networks[e.getId()]=e:e instanceof l?this.geo[e.getId()]=e:e instanceof c&&(this.bounds[e.getId()]=e),!(e instanceof l)},g.prototype.remove=function(e){return this.updateCount++,e instanceof i?(this.date=void 0,this.species={},this.networks={},this.bounds={}):e instanceof o?delete this.species[e.getId()]:e instanceof s?delete this.networks[e.getId()]:e instanceof l?delete this.geo[e.getId()]:e instanceof c&&delete this.bounds[e.getId()],e.$removed&&e.$removed(),!(e instanceof l||e instanceof c)},g.prototype.reset=function(){this.updateCount=0,this.date=void 0,this.species=f(this.species),this.geo=f(this.geo),this.networks=f(this.networks),this.bounds=f(this.bounds)},g.prototype.getSpeciesList=function(){var t=[],a=this.getSpeciesArgs(),i=this.getNetworkArgs(),o=e.defer();if(a.length)a.forEach(function(e){t.push(e.arg)}),o.resolve(t);else if(i.length){var s={},l=0;i.forEach(function(e){s["network_id["+l+++"]"]=e.getId()});var c=d.keyFromObject(s);(t=d.get(c))&&t.length?o.resolve(t):n.get(r("/npn_portal/species/getSpeciesFilter.json"),{params:s}).then(function(e){var t=e.data;d.put(c,t),o.resolve(t)})}else o.resolve(t);return o.promise},g.prototype.getPhenophasesForSpecies=function(t,n,r){var a,i=this.getSpeciesArgs(),o=this.getDateArg(),s=e.defer();if("string"==typeof t&&(t=parseInt(t)),!n&&i.length){var l=!1;for(a=0;a<i.length;a++)if(i[a].getId()===t){s.resolve(i[a].getPhenophaseList()),l=!0;break}l||s.resolve([])}else y(t,r=r||d3.range(o.getStartYear(),o.getEndYear()+1)).then(function(e){s.resolve(e)});return s.promise},g}]).factory("FilterService",["$q","$http","$rootScope","$timeout","$log","$filter","$url","uiGmapGoogleMapApi","md5","NpnFilter","SpeciesFilterArg","SettingsService","Analytics",function(e,t,n,r,a,i,o,s,l,c,d,u,p){var g,f,h=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#222299","#c51b8a","#8c564b","#637939","#843c39","#5254a3","#636363","#bcbd22","#7b4173","#e7ba52","#222299","#f03b20","#1b9e77","#e377c2","#ef8a62","#91cf60","#9467bd"],m=d3.range(0,h.length),v=d3.scale.ordinal().domain(m).range(m.map(function(e){return d3.rgb(h[e]).darker(1).toString()})),y=m.map(function(e){var t=v(e),n=d3.rgb(t).brighter(4).toString();return d3.scale.linear().range([n,t])}),b=new c,w=!1,x={fillColor:"#00ff00",fillOpacity:1,scale:8,strokeColor:"#204d74",strokeWeight:1},k=[];s.then(function(e){x.path=e.SymbolPath.CIRCLE}),n.$on("filter-rerun-phase2",function(e,t){w||r(function(){if(f){F.getFilter().ga("re-execute");var e=S(f,!0);n.$broadcast("filter-marker-updates",{markers:e})}},500)});var _={previousFilterCount:0,previousFilterMap:{},hits:[],misses:[]};function S(e,t){var r=Date.now();n.$broadcast("filter-phase2-start",{count:e.length});var o=0,s=b.getSpeciesArgs().length>0,c=b.getNetworkArgs(),d=i("speciesTitle"),p=u.getSettingValue("tagSpeciesTitle"),g=function(e,t,n){var r;c.length&&angular.forEach(c,function(a){r=a.updateCounts(e,t,n),n&&(o+=r)})},f=function(e,t){function n(e,t){var n,r=Object.keys(e),i=Object.keys(t);if(r.length!==i.length+1&&a.warn("Issue with usage of _mapdiff, unexpected key lengths",e,t),1===r.length)return e[r[0]];for(n=0;n<r.length;n++)if(!t[r[n]])return e[r[n]];a.warn("Issue with usage of _mapdiff, unfound diff",e,t)}function r(e,t){var n={hits:[],misses:[]};return angular.forEach(e,function(e){t(e)?n.hits.push(e):n.misses.push(e)}),n}var i,o,s=Date.now(),l=b.getGeographicArgs(),c=l.length,d=c>_.previousFilterCount,u=(o={},angular.forEach(b.getGeographicArgs(),function(e){o[e.getUid()]=e}),o);if(c>0&&_.previousFilterCount===c){if(angular.equals(Object.keys(u),Object.keys(_.previousFilterMap)))return a.debug("refilter but no change in geographic filters"),_.hits;a.warn("refilter but no change in geo filter count")}if(_.previousFilterCount=c,0===c)_.misses=[],_.hits=[].concat(e);else if(t&&1!==Object.keys(u).length)if(d){var p=n(u,_.previousFilterMap);i=r(_.misses,function(e){return p.$filter(e)}),_.hits=_.hits.concat(i.hits),_.misses=i.misses}else{var g=n(_.previousFilterMap,u);i=r(_.hits,function(e){return g.$filter(e)}),_.hits=i.misses,_.misses=_.misses.concat(i.hits)}else i=r(e,function(e){var t,n=!1;for(t=0;t<l.length&&!(n=l[t].$filter(e));t++);return n}),_.hits=i.hits,_.misses=i.misses;return _.previousFilterMap=u,a.debug("geo time:"+(Date.now()-s)),_.hits}(e,t).filter(function(e){e.markerOpts.icon.fillColor=x.fillColor;var t,n,r,i=0,l={};e.observationCount=0,e.speciesInfo=void 0;for(t in e.species)n=b.getSpeciesArg(t),l[t]=0,n||!s?n&&(r=n.$filter(e.species[t]))?(o+=r,e.observationCount+=r,l[t]++,i++,g(e,e.species[t]),e.speciesInfo||(e.speciesInfo={titles:{},counts:{}}),e.speciesInfo.titles[t]=d(n.arg,p),e.speciesInfo.counts[t]=r):n||(i++,g(e,e.species[t],!0)):a.warn("species found in results but not in filter",e.species[t]);l.n=0;for(t in l)"n"!=t&&l[t]>0&&l.n++;return e.markerOpts.title=e.station_name+" ("+e.observationCount+")",e.speciesInfo&&(e.markerOpts.title+=" ["+Object.keys(e.speciesInfo.titles).map(function(t){return e.speciesInfo.titles[t]}).join(",")+"]"),e.markerOpts.icon.strokeColor=l.n>1?"#00ff00":x.strokeColor,e.markerOpts.zIndex=e.observationCount+2,i>0}).map(function(e){return{latitude:e.latitude,longitude:e.longitude,markerOpts:e.markerOpts,station_id:e.station_id,station_name:e.station_name,observationCount:e.observationCount,speciesInfo:e.speciesInfo}});if(s){var h={};f.forEach(function(e){var t=Object.keys(e.speciesInfo.counts),n=t.reduce(function(t,n){return h[n]?(e.speciesInfo.counts[n]<h[n].min&&(h[n].min=e.speciesInfo.counts[n]),e.speciesInfo.counts[n]>h[n].max&&(h[n].max=e.speciesInfo.counts[n])):h[n]={min:e.speciesInfo.counts[n],max:e.speciesInfo.counts[n]},e.speciesInfo.counts[n]>e.speciesInfo.counts[t]?n:t},t[0]),r=b.getSpeciesArg(n);e.markerOpts.icon.fillColorIdx=r.colorIdx}),b.getSpeciesArgs().forEach(function(e){if(h[e.arg.species_id]){var t=f.filter(function(t){return e.colorIdx===t.markerOpts.icon.fillColorIdx}),n=e.arg.species_id,r=h[n].min,i=h[n].max;a.debug("observationCount variability for "+e.toString()+" ("+e.arg.common_name+") ["+r+"-"+i+"]");var o=y[e.colorIdx];o.domain([r,i]),t.forEach(function(e){e.markerOpts.icon.fillColor=o(e.speciesInfo.counts[n])})}})}else{var m=d3.min(f,function(e){return e.observationCount}),v=d3.max(f,function(e){return e.observationCount});a.debug("observationCount variability for network only results ["+m+"-"+v+"]"),y[0].domain([m,v]),f.forEach(function(e){e.markerOpts.icon.fillColorIdx=0,e.markerOpts.icon.fillColor=y[0](e.observationCount)})}return f.forEach(function(e){e.$markerKey=l.createHash(JSON.stringify(e))}),n.$broadcast("filter-phase2-end",{station:f.length,observation:o}),a.debug("phase2 time:",Date.now()-r),k=f}function $(){w||n.$broadcast("filter-update",{})}function C(){k=[],n.$broadcast("filter-reset",{})}var F={execute:function(){var r=e.defer(),i=function(){if(b.hasCriteria()){var e={},t=b.getDateArg();return t&&(e.start_date=t.getStartDate(),e.end_date=t.getEndDate()),b.getSpeciesArgs().forEach(function(t,n){e["species_id["+n+"]"]=t.getId()}),b.getNetworkArgs().forEach(function(t,n){e["network_id["+n+"]"]=t.getId()}),e}}();if(!w&&i&&g!=b.getUpdateCount()){g=b.getUpdateCount();var s=Date.now();a.debug("execute",g,i),n.$broadcast("filter-phase1-start",{}),t.get(o("/npn_portal/observations/getAllObservationsForSpecies.json"),{params:i}).then(function(e){var t=e.data;angular.forEach(t.station_list,function(e){e.markerOpts={title:e.station_name,icon:angular.extend({},x)}}),n.$broadcast("filter-phase1-end",{count:t.station_list.length}),a.debug("phase1 time:",Date.now()-s),r.resolve(S(f=t.station_list))})}else r.resolve(k);return r.promise},getFilteredMarkers:function(){return k},pause:function(){a.debug("PAUSE"),w=!0},resume:function(){a.debug("RESUME"),w=!1,$()},getFilter:function(){return b},hasFilterChanged:function(){return g!==b.getUpdateCount()},isFilterEmpty:function(){return!b.hasCriteria()},hasDate:function(){return b.hasDate()},hasSufficientCriteria:function(){return b.hasSufficientCriteria()},addToFilter:function(e){b.add(e)&&(b.getSpeciesArgs().forEach(function(e,t){e.colorIdx=t,e.color=v(t)}),$())},removeFromFilter:function(e){b.remove(e)&&(b.hasCriteria()?$():C())},resetFilter:function(){b.reset(),g=b.getUpdateCount(),C()},getColorScale:function(){return v},getChoroplethScale:function(e){var t=b.getSpeciesArg(e);if(t)return y[t.colorIdx]},getChoroplethScales:function(){return y}};return F}]).directive("npnFilterResults",["$rootScope","$http","$timeout","$filter","$log","FilterService","SettingsService","StationService","ClusterService","Analytics",function(e,t,n,r,a,i,o,s,l,c){return{restrict:"E",template:'<ui-gmap-markers models="results.markers" idKey="\'$markerKey\'" coords="\'self\'" icon="\'icon\'" options="\'markerOpts\'" doCluster="doCluster" clusterOptions="clusterOptions" control="mapControl" events="markerEvents"></ui-gmap-markers>',scope:{},link:function(t){var a=!1;t.results={markers:[]},t.mapControl={},t.doCluster=o.getSettingValue("clusterMarkers");var c=l.getDefaultClusterOptions(),d=r("speciesBadge");function u(e){var n,r=e.reduce(function(e,t){return e+t.observationCount},0),a=r>512?Math.round(r/2):512;for(n=c.styles.length-1;n>=0;n--)c.styles[n].n=a,a=Math.round(a/2);t.results.markers=e}function p(){i.hasFilterChanged()&&i.hasSufficientCriteria()&&(i.getFilter().ga("execute"),n(function(){t.results.markers=[],n(function(){i.execute().then(function(e){u(e)})},500)},500))}t.clusterOptions=angular.extend(c,{calculator:function(e,t){var n=0,r=(o.getSettingValue("tagBadgeFormat"),{index:1});e.values().forEach(function(e){n+=e.model.observationCount}),r.text=d({station:e.length,observation:n},o.getSettingValue("tagBadgeFormat"));for(var a=0;a<c.styles.length;a++)n>=c.styles[a].n&&(r.index=a+1);return r}}),t.$on("setting-update-tagBadgeFormat",function(e,n){t.mapControl&&t.mapControl.managerDraw&&t.mapControl.managerDraw()}),t.$on("setting-update-clusterMarkers",function(e,n){t.doCluster=n.value}),t.$on("tool-open",function(e,t){a="filter"===t.tool.id}),t.$on("tool-close",function(e,t){"filter"===t.tool.id&&(a=!1,p())}),t.$on("filter-update",function(e,t){a||p()}),t.$on("filter-reset",function(e,n){t.results.markers=[]}),t.$on("filter-marker-updates",function(e,t){u(t.markers)});var g=s.getMarkerEvents();t.markerEvents={click:g.click,mouseover:function(t){e.$broadcast("marker-mouseover",{marker:t})},mouseout:function(t){e.$broadcast("marker-mouseout",{marker:t})}}}}}]).directive("choroplethInfo",["$log","$timeout","FilterService",function(e,t,n){return{restrict:"E",templateUrl:"js/filter/choroplethInfo.html",link:function(r){var a=!1;function i(e){var t,n,r=Math.ceil(e.domain[1]/20),a=[];for(t=0;t<20;t++)n=r*t+1,a[t]=e.scale(n),e.count>=n&&(e.color=a[t]);return a.forEach(function(t){-1===e.colors.indexOf(t)&&e.colors.push(t)}),e}r.show=!1,r.$on("marker-mouseover",function(o,s){e.debug("mouseover",s),(s.marker.model.speciesInfo||s.marker.model.observationCount)&&(a=!0,t(function(){if(r.show=a){r.station_name=s.marker.model.station_name;var t=n.getChoroplethScales();if(s.marker.model.speciesInfo){var o=Object.keys(s.marker.model.speciesInfo.counts);r.data=o.map(function(e){var r=n.getFilter().getSpeciesArg(e);return i({sid:e,count:s.marker.model.speciesInfo.counts[e],title:s.marker.model.speciesInfo.titles[e],arg:r,scale:t[r.colorIdx],domain:t[r.colorIdx].domain(),colors:[]})})}else if(s.marker.model.observationCount){var l={count:s.marker.model.observationCount,title:"All Records",scale:t[0],domain:t[0].domain(),colors:[]};r.data=[i(l)]}e.debug(r.data)}},500))}),r.$on("marker-mouseout",function(n,i){e.debug("mouseout",i),a=!1,r.show&&t(function(){a||(r.show=!1,r.data=void 0)},500)})}}}]).directive("filterTags",["FilterService",function(e){return{restrict:"E",templateUrl:"js/filter/filterTags.html",scope:{},controller:["$scope",function(t){t.getFilter=e.getFilter}]}}]).filter("speciesBadge",function(){return function(e,t){return"observation-count"===t?e.observation:"station-count"===t?e.station:"station-observation-count"===t?e.station+"/"+e.observation:e}}).filter("speciesTitle",["SettingsService",function(e){return function(t,n){var r=n||e.getSettingValue("tagSpeciesTitle");if("common-name"===r){if(t.common_name){var a=t.common_name.toLowerCase();return a.substring(0,1).toUpperCase()+a.substring(1)}return t.common_name}return"scientific-name"===r?t.genus+" "+t.species:t}}]).directive("speciesFilterTag",["$rootScope","FilterService","SettingsService","SpeciesFilterArg",function(e,t,n,r){return{restrict:"E",require:"^filterTags",templateUrl:"js/filter/speciesFilterTag.html",scope:{arg:"="},link:function(r){var a,i;r.titleFormat=n.getSettingValue("tagSpeciesTitle"),r.$on("setting-update-tagSpeciesTitle",function(e,t){r.titleFormat=t.value}),r.badgeFormat=n.getSettingValue("tagBadgeFormat"),r.badgeTooltip=n.getSettingValueLabel("tagBadgeFormat"),r.$on("setting-update-tagBadgeFormat",function(e,t){r.badgeFormat=t.value,r.badgeTooltip=n.getSettingValueLabel("tagBadgeFormat")}),r.$on("setting-update-onlyYesData",function(t,n){n.value!==r.arg.ydo&&(r.arg.ydo=n.value,e.$broadcast("filter-rerun-phase2",{}))}),r.$on("filter-phase2-start",function(e,t){r.arg.resetCounts(0)}),r.$on("filter-phase1-start",function(e,t){r.arg.resetCounts("?")}),r.removeFromFilter=t.removeFromFilter,r.status={isopen:!1},r.hasCount=function(e,t){return e.count>0},r.$watch("status.isopen",function(){if(r.status.isopen)a=r.arg.phenophases.map(function(e){return e.selected}),i=r.arg.ydo;else if(a){for(var t=!1,n=0;n<a.length;n++)if(a[n]!=r.arg.phenophases[n].selected){t=!0;break}t||(t=i!=r.arg.ydo),t&&e.$broadcast("filter-rerun-phase2",{})}}),r.selectAll=function(e){angular.forEach(r.arg.phenophases,function(t){t.selected=e})}}}}]).directive("dateFilterTag",["FilterService","SettingsService",function(e,t){return{restrict:"E",require:"^filterTags",templateUrl:"js/filter/dateFilterTag.html",scope:{arg:"="},link:function(n){n.badgeFormat=t.getSettingValue("tagBadgeFormat"),n.badgeTooltip=t.getSettingValueLabel("tagBadgeFormat"),n.$on("setting-update-tagBadgeFormat",function(e,r){n.badgeFormat=r.value,n.badgeTooltip=t.getSettingValueLabel("tagBadgeFormat")}),n.removeFromFilter=e.removeFromFilter,n.counts={station:"?",observation:"?"},n.$on("filter-phase1-start",function(e,t){n.counts.station=n.counts.observation="?"}),n.$on("filter-phase2-start",function(e,t){n.counts.station=n.counts.observation=0}),n.$on("filter-phase2-end",function(e,t){n.counts=t})}}}]).directive("networkFilterTag",["$rootScope","FilterService","SettingsService",function(e,t,n){return{restrict:"E",require:"^filterTags",templateUrl:"js/filter/networkFilterTag.html",scope:{arg:"="},link:function(r){var a;r.status={isopen:!1},r.badgeFormat=n.getSettingValue("tagBadgeFormat"),r.badgeTooltip=n.getSettingValueLabel("tagBadgeFormat"),r.$on("setting-update-tagBadgeFormat",function(e,t){r.badgeFormat=t.value,r.badgeTooltip=n.getSettingValueLabel("tagBadgeFormat")}),r.$on("setting-update-onlyYesData",function(t,n){n.value!==r.arg.ydo&&(r.arg.ydo=n.value,e.$broadcast("filter-rerun-phase2",{}))}),r.removeFromFilter=t.removeFromFilter,r.$on("filter-phase1-start",function(e,t){r.arg.resetCounts("?")}),r.$on("filter-phase2-start",function(e,t){r.arg.resetCounts(0)}),r.$watch("status.isopen",function(t){t?a=r.arg.ydo:void 0!==a&&a!==r.arg.ydo&&e.$broadcast("filter-rerun-phase2",{})})}}}]).directive("filterControl",["$http","$filter","$timeout","$url","FilterService","DateFilterArg","SpeciesFilterArg","NetworkFilterArg","HelpService","SpeciesService",function(e,t,n,r,a,i,o,s,l,c){return{restrict:"E",templateUrl:"js/filter/filterControl.html",controller:["$scope",function(d){d.addDateRangeToFilter=function(){a.addToFilter(new i(d.selected.date))},d.filterHasDate=a.hasDate,d.filterHasSufficientCriteria=a.hasSufficientCriteria;var u=(new Date).getYear()+1900,p=d3.range(1900,u+1);d.thisYear=u,d.validYears=p,d.selected={date:{start_date:u-1,end_date:u},species:[]},d.speciesInput={animals:[],plants:[],networks:[]},d.findSpeciesParamsEmpty=!0,d.$watch("selected.species.length",function(e){e&&l.lookAtMe("#add-species-button")}),d.$watch("speciesInput.networks.length",function(e){e&&l.lookAtMe("#add-networks-button")}),d.networksMaxedOut=function(){return a.getFilter().getNetworkArgs().length>=10},d.speciesMaxedOut=function(){return a.getFilter().getSpeciesArgs().length>=20},d.addNetworksToFilter=function(){l.stopLookingAtMe("#add-networks-button"),angular.forEach(d.speciesInput.networks,function(e){d.networksMaxedOut()||a.addToFilter(new s(e))})},d.addSpeciesToFilter=function(){l.stopLookingAtMe("#add-species-button"),angular.forEach(d.selected.species,function(e){d.speciesMaxedOut()||a.addToFilter(new o(e))})};var g,f,h=!0;function m(){var e={},t=0;angular.forEach([].concat(d.speciesInput.animals).concat(d.speciesInput.plants),function(n){e["group_ids["+t+++"]"]=n.species_type_id}),t=0,angular.forEach(d.speciesInput.networks,function(n){e["network_id["+t+++"]"]=n.network_id}),g=e,d.findSpeciesParamsEmpty=0===Object.keys(e).length,h=!0}d.$watch("speciesInput.animals",m),d.$watch("speciesInput.plants",m),d.$watch("speciesInput.networks",m),d.findSpecies=function(){h&&(h=!1,angular.forEach(d.selected.species,function(e){e.selected=!1}),d.selected.species=[],d.findSpeciesParamsEmpty&&f&&f.length?d.speciesList=f:(d.findingSpecies=!0,d.serverResults=e.get(r("/npn_portal/species/getSpeciesFilter.json"),{params:g}).then(function(e){var r=[];angular.forEach(e.data,function(e){e.number_observations=parseInt(e.number_observations),e.display=t("speciesTitle")(e)+" ("+e.number_observations+")",r.push(e)});var a=d.speciesList=r.sort(function(e,t){return e.number_observations<t.number_observations?1:e.number_observations>t.number_observations?-1:0});return d.findSpeciesParamsEmpty&&(f=a),n(function(){d.findingSpecies=!1},250),a})))},d.$on("setting-update-tagSpeciesTitle",function(e,r){n(function(){angular.forEach(d.speciesList,function(e){e.display=t("speciesTitle")(e)+" ("+e.number_observations+")"})},250)}),e.get(r("/npn_portal/networks/getPartnerNetworks.json?active_only=true")).then(function(e){var t=e.data;angular.forEach(t,function(e){e.network_name=e.network_name.trim()}),d.partners=t}),c.getPlantTypes().then(function(e){d.plantTypes=e}),c.getAnimalTypes().then(function(e){d.animalTypes=e}),d.findSpecies()}]}}]).factory("SpeciesService",["$q","$http","$url",function(e,t,n){var r=t.get(n("/npn_portal/species/getPlantTypes.json")),a=t.get(n("/npn_portal/species/getAnimalTypes.json"));function i(t){return function(){var n=e.defer();return t.then(function(e){n.resolve(e.data)}),n.promise}}return{getPlantTypes:i(r),getAnimalTypes:i(a)}}]),angular.module("npn-viz-tool.filters",[]).filter("cssClassify",function(){return function(e){return"string"==typeof e?e.trim().toLowerCase().replace(/\s+/g,"-"):e}}).filter("yesNo",function(){return function(e){return e?"Yes":"No"}}).filter("gte",function(){return function(e,t){return t&&angular.isArray(e)?e.filter(function(e){return e>=t}):e}}).filter("lte",function(){return function(e,t){return t&&angular.isArray(e)?e.filter(function(e){return e<=t}):e}}).filter("trim",function(){return function(e){return angular.isString(e)?e.trim():e}}).filter("ellipses",function(){return function(e){var t=2==arguments.length?arguments[1]:55;return"string"==typeof e&&e.length>t?e.substring(0,t)+" ...":e}}).filter("doy",function(){return function(e,t){if("string"==typeof e){var n=e.split("-");if(3===n.length){var r=parseInt(n[0]),a=parseInt(n[1]),i=parseInt(n[2]);!isNaN(r)&&!isNaN(a)&&!isNaN(i)&&a<13&&i<32&&(e=new Date(r,a-1,i))}}if(e instanceof Date){e=new Date(e.getTime()),t&&e.setFullYear(2010);for(var o=e.getDate();e.getMonth()>0;)e.setDate(1),e.setTime(e.getTime()-864e5),o+=e.getDate();return o}return e}}),angular.module("npn-viz-tool.gridded",["npn-viz-tool.gridded-services"]).service("GriddedControlService",["$location",function(e){var t={getLegend:function(){return t.legend},getLayer:function(){return t.layer},addSharingUrlArgs:function(e){if(t.layer){var n=t.layer.name+"/"+t.layer.extent.current.value,r=t.layer.getStyleRange();r&&(n+="/"+r[0]+"/"+r[1]),e.gl=n}},getSharingUrlArgs:function(){var t=e.search().gl;if(t)return t.split(/\//)}};return t}]).directive("griddedLegendMain",["GriddedControlService",function(e){return{restrict:"E",template:'<div id="griddedLegendMain" ng-style="{display: shared.legend ? \'inherit\' : \'none\'}"><gridded-legend legend="shared.legend"></gridded-legend></div>',scope:{},link:function(t){t.shared=e}}}]).directive("griddedControl",["$log","$rootScope","uiGmapGoogleMapApi","uiGmapIsReady","WmsService","GriddedControlService","GriddedInfoWindowHandler",function(e,t,n,r,a,i,o){return{restrict:"E",templateUrl:"js/gridded/gridded-control.html",link:function(s){var l,c,d;function u(){console.log("gridded.js init called getting maps"),d||(d=!0,n.then(function(t){t,r.promise(1).then(function(t){c=t[0].map,l=new o(c),c.addListener("click",function(e){l.open(e.latLng,s.selection.activeLayer,s.legend)}),a.getLayers(c).then(function(t){e.debug("layers",t),s.layers=t;var n,r,a,o,l=i.getSharingUrlArgs();l&&(e.debug("arguments from shared url",l),n=l[0],r=l[1],(o=t.categories.reduce(function(e,t){return e||(e=t.layers.reduce(function(e,t){return e||(t.name===n?t:void 0)},void 0))&&(a=t),e},void 0))?(o.extent.current=o.extent.values.reduce(function(e,t){return e||(t.value===r?t:void 0)},void 0)||o.extent.current,s.selection.layerCategory=a,s.selection.layer=o,4===l.length&&o.setStyleRange([parseInt(l[2]),parseInt(l[3])])):e.warn("unable to find gridded layer named "+n))},function(){e.error("unable to get map layers?")})})}))}function p(){l&&l.close()}s.selection={},s.actions={reset:function(){delete s.selection.layerCategory,delete s.selection.layer}},s.$on("filter-reset",s.actions.reset),i.getSharingUrlArgs()?u():s.$on("tool-open",function(e,t){"gridded"===t.tool.id&&u()}),s.$watch("selection.layerCategory",function(n){if(e.debug("layer category change ",n),null!=s.selection.layerCategory&&t.$broadcast("reset-pest-layer"),s.selection.activeLayer){e.debug("turning off layer ",s.selection.activeLayer.name);var r=s.selection.activeLayer;s.selection.activeLayer.off(),delete s.selection.activeLayer,delete s.legend,delete i.legend,delete i.layer,p(),t.$broadcast("gridded-layer-off",{layer:r})}}),s.$watch("selection.layer",function(n){n&&(p(),e.debug("selection.layer",n),s.selection.activeLayer&&(e.debug("turning off layer ",s.selection.activeLayer.name),s.selection.activeLayer.off()),e.debug("fitting new layer ",n.name),i.layer=s.selection.activeLayer=n.fit().on(),delete s.legend,s.selection.activeLayer.getLegend(n).then(function(e){i.legend=s.legend=e}),t.$broadcast("gridded-layer-on",{layer:s.selection.activeLayer}))}),s.$watch("selection.activeLayer.extent.current",function(t){var n;(n=s.selection.activeLayer)&&(e.debug("layer extent change ",n.name,t),p(),n.bounce())}),s.$on("reset-gridded-layer",function(){if(console.log("resetting the gridded layer"),delete s.selection.layerCategory,delete s.selection.layer,s.selection.activeLayer){e.debug("turning off layer ",s.selection.activeLayer.name);s.selection.activeLayer;s.selection.activeLayer.off(),delete s.selection.activeLayer,delete s.legend,delete i.legend,delete i.layer,p()}})}}}]),angular.module("npn-viz-tool.gridded-services",[]).provider("$url",[function(){this.$get=["$log",function(e){var t=window.location.origin.replace("data","www");return e.debug("BASE_URL",t),function(e){return t+e}}]}]).service("DateExtentUtil",[function(){var e=/^(\d\d\d\d)-0?(\d+)-0?(\d+)/;return{parse:function(t){var n=e.exec(t.replace(/T.*$/,"")),r=parseInt(n[1]),a=parseInt(n[2])-1,i=parseInt(n[3]);return new Date(r,a,i)}}}]).directive("griddedPointInfoWindow",["$log","$timeSeriesVis",function(e,t){return{restrict:"E",template:'<div id="griddedPointInfoWindow" class="ng-cloak"><div ng-if="gridded_point_legend" class="gridded-legend-color" style="background-color: {{gridded_point_legend.color}};">&nbsp;</div><div class="gridded-point-data">{{legend.formatPointData(point)}}</div><ul class="list-unstyled" ng-if="timeSeries"><li><a href ng-click="timeSeries()">Show Accumulation</a></li></ul></div>',scope:{point:"=",layer:"=",legend:"=",latLng:"="},link:function(n){var r=n.latLng,a=n.point,i=n.layer,o=n.legend;e.debug("griddedPointInfoWindow:latLng",r),e.debug("griddedPointInfoWindow:point",a),e.debug("griddedPointInfoWindow:layer",i),e.debug("griddedPointInfoWindow:legend",o),n.gridded_point_legend=n.legend.getPointData(a),i.supports_time_series&&(n.timeSeries=function(){t(i,o,r)})}}}]).factory("GriddedInfoWindowHandler",["$log","$timeout","$compile","$rootScope",function(e,t,n,r){function a(e){this.map=e}return a.prototype.open=function(a,i,o){var s,l=this.map;a&&i&&o&&(this.infoWindow||(this.infoWindow=new google.maps.InfoWindow({maxWidth:200,content:"contents"})),s=this.infoWindow,i.getGriddedData(a).then(function(c){e.debug("tuples",c);var d,u=c&&c.length?c[0]:void 0,p=r.$new();-9999===u||isNaN(u)?e.debug("received -9999 or Nan ignoring"):void 0!==(p.point=u)?(p.layer=i,p.legend=o,p.latLng=a,d=n('<div><gridded-point-info-window point="point" layer="layer" legend="legend" lat-lng="latLng"></gridded-point-info-window></div>')(p),t(function(){s.setContent(d[0]),s.setPosition(a),s.open(l)})):e.debug("undefined point?")},function(){e.error("unable to get gridded data.")}))},a.prototype.close=function(){this.infoWindow&&this.infoWindow.close()},a}]).directive("griddedOpacitySlider",["$log","$timeout","WmsService",function(e,t,n){return{restrict:"E",template:'<div ng-if="layer" class="form-group"><label for="griddedOpacitySlider" style="margin-bottom: 15px;">Opacity</label><rzslider rz-slider-model="selection.opacity" rz-slider-options="options"></rzslider></div>',scope:{layer:"="},link:function(e){function t(){e.layer&&e.layer.googleLayer.setOpacity(e.selection.opacity/100)}e.selection={opacity:75},e.options={floor:0,ceil:100,step:1},e.$watch("layer.extent.current",t),e.$watch("selection.opacity",t),e.$watch("layer",t)}}}]).directive("griddedRangeSlider",["$log","$timeout","WmsService",function(e,t,n){return{restrict:"E",template:'<div ng-if="legend" class="form-group"><label for="griddedRangeSlider" style="margin-bottom: 15px;">Range</label><rzslider rz-slider-model="selection.min" rz-slider-high="selection.max" rz-slider-options="options"></rzslider></div>',scope:{layer:"="},link:function(n){var r;function a(){r&&t.cancel(r),r=t(function(){var e=n.layer,t=n.legend,r=n.data;if(t&&r){if(n.selection.min===n.options.floor&&n.selection.max===n.options.ceil)return e.setStyleRange(void 0);e.setStyleRange([n.selection.min,n.selection.max])}},500)}n.$watch("layer",function(t){delete n.legend,t&&t.getLegend().then(function(r){n.legend=r,e.debug("legend",r);var a=n.data=r.getData(),i=t.getStyleRange();n.selection={min:i?i[0]:0,max:i?i[1]:a.length-1},n.options={floor:0,ceil:a.length-1,step:1,showTicks:!0,showSelectionBar:!0,translate:function(e){return a[e].label},getTickColor:function(e){return a[e].color},getPointerColor:function(e){return a[e].color},getSelectionBarColor:function(e){return a[e].color}}})}),n.$watch("selection.min",a),n.$watch("selection.max",a)}}}]).directive("griddedDoyControl",["$log","thirtyYearAvgDayOfYearFilter",function(e,t){var n=t(1,!0).getFullYear(),r=864e5,a=d3.range(0,12).map(function(e){return new Date(n,e)});return{restrict:"E",templateUrl:"js/gridded/doy-control.html",scope:{layer:"="},link:function(n){var i;function o(r){n.selection.month.setDate(r);var a=t(n.selection.month);e.debug("doy-control:date "+a),n.layer.extent.current=n.layer.extent.values.reduce(function(e,t){return e||(t.label===a?t:void 0)},void 0)}n.months=a,n.$watch("layer",function(e){i=t(n.layer.extent.current.value,!0),n.selection={month:a[i.getMonth()],date:i.getDate()}}),n.$watch("selection.month",function(t){var a,s,l;e.debug("doy-control:month "+(t.getMonth()+1),t),n.dates=d3.range(1,(11===(l=(a=t).getMonth())?31:((s=new Date(a.getTime())).setDate(1),s.setMonth(s.getMonth()+1),s.setTime(s.getTime()-r),e.debug("last day of month "+(l+1)+" is "+s),s.getDate()))+1),i?i=void 0:1===n.selection.date?o(1):n.selection.date=1}),n.$watch("selection.date",o)}}}]).directive("griddedYearControl",["$log",function(e){return{restrict:"E",templateUrl:"js/gridded/year-control.html",scope:{layer:"="},link:function(e){}}}]).directive("griddedDateControl",["$log","dateFilter",function(e,t){return{restrict:"E",templateUrl:"js/gridded/date-control.html",scope:{layer:"="},link:function(n){n.$watch("layer",function(t){t&&(n.selection=t.extent.current.date,n.minDate=t.extent.values[0].date,n.maxDate=t.extent.values[t.extent.values.length-1].date,e.debug("minDate",n.minDate),e.debug("maxDate",n.maxDate))},!1),n.open=function(){n.isOpen=!0},n.$watch("selection",function(r){e.debug("selection",r);var a="longDate",i=t(r,a);n.layer.extent.current=n.layer.extent.values.reduce(function(e,n){return e||(i===t(n.date,a)?n:void 0)},void 0)})}}}]).directive("pestDateControl",["$log","dateFilter",function(e,t){return{restrict:"E",templateUrl:"js/pest/date-control.html",scope:{layer:"="},link:function(n){n.$watch("layer",function(e){e&&e.extent.current&&(n.options={minDate:new Date((new Date).getFullYear()-1,0,1),maxDate:new Date((new Date).getTime()+5184e5)},n.selection=e.extent.current.date)},!0),n.open=function(){n.isOpen=!0},n.$watch("selection",function(r){e.debug("selection",r);var a="longDate",i=t(r,a);n.layer.extent.current=n.layer.extent.values.reduce(function(e,n){return e||(i===t(n.date,a)?n:void 0)},void 0)})}}}]).directive("pestLayerControl",["$log",function(e){return{restrict:"E",templateUrl:"js/pest/pest-layer-control.html",link:function(e){e.categories=["Insect Pest Forecast","Tree Budburst Forecast","Pollen Forecast"],e.pests=["Apple Maggot","Emerald Ash Borer","Hemlock Woolly Adelgid","Lilac Borer","Winter Moth"]}}}]).directive("griddedLayerControl",["$log",function(e){return{restrict:"E",templateUrl:"js/gridded/layer-control.html",link:function(e){}}}]).directive("pestLegend",["$log","$window",function(e,t){return{restrict:"E",templateUrl:"js/gridded/pest-legend.html",scope:{legendId:"@",legend:"="},link:function(n,r){var a=r.find("svg")[0];function i(){var t=n.legend,r=d3.select(a);if(r.selectAll("g").remove(),t){e.debug("legend.title",t.getTitle()),e.debug("legend.length",t.length),e.debug("legend.colors",t.getColors()),e.debug("legend.quantities",t.getQuantities()),e.debug("legend.labels",t.getLabels()),e.debug("legend.original_labels",t.getOriginalLabels());for(var i=parseFloat(r.style("width").replace("px","")),o=parseFloat(r.style("height").replace("px","")),s=t.getData(),l=20,c=[],d=0;d<s.length;d++)-1==s[d].original_label.indexOf("ignore")&&c.push(s[d]);s=c,e.debug("svg dimensions",i,o),e.debug("legend cell width",l);var u=r.append("g");u.selectAll("g.cell").data(s).enter().append("g").attr("class","cell").attr("transform",function(e,t){return"translate(0,"+t*l+")"}).append("rect").attr("height",20).attr("width",l).style("stroke","black").style("stroke-width","1px").style("fill",function(e,t){return e.color}).append("title").text(function(e){return e.label});for(var p,g,f,h=u.selectAll("g.cell")[0],m=(Math.floor(h.length/2),0);m<s.length;m++)p=d3.select(h[m]),g=s[m].original_label,f="start",p.append("text").attr("dx","2.4em").attr("dy",l/1.5).style("text-anchor",f).text(g);var v=20*s.length,y=document.getElementsByClassName("pest-legend");y[0].style.height=v+48+10+"px","Hemlock Woolly Adelgid"==t.pest?y[0].style.width="445px":y[0].style.width="350px";var b=null;"Emerald Ash Borer"==t.pest||"Lilac Borer"==t.pest?b="Spray adults":"Winter Moth"==t.pest&&(b="Spray caterpillars"),b?(r.append("g").append("text").attr("dx",5).attr("dy",20+v).attr("font-size","16px").attr("text-anchor","right").text(t.pest+" Forecast, "+t.ldef.extent.current.label),r.append("g").append("text").attr("dx",5).attr("dy",38+v).attr("font-size","14px").attr("text-anchor","right").text("Treatment method: "+b),r.append("g").append("text").attr("dx",5).attr("dy",54+v).attr("font-size","11px").attr("text-anchor","right").text("USA National Phenology Network, www.usanpn.org")):(r.append("g").append("text").attr("dx",5).attr("dy",30+v).attr("font-size","16px").attr("text-anchor","right").text(t.pest+" Forecast, "+t.ldef.extent.current.label),r.append("g").append("text").attr("dx",5).attr("dy",48+v).attr("font-size","11px").attr("text-anchor","right").text("USA National Phenology Network, www.usanpn.org"))}}n.$watch("legend",i),$(t).bind("resize",i),n.$watch("legend.layer.extent.current",i),n.$on("$destroy",function(){e.debug("legend removing resize handler"),$(t).unbind("resize",i)})}}}]).filter("thirtyYearAvgDayOfYear",["dateFilter",function(e){var t=new Date(2010,0);return function(n,r){"string"==typeof n&&(n=parseFloat(n));var a=n instanceof Date?n:new Date(t.getTime()+864e5*(n-1));return r?a:e(a,"MMMM d")}}]).directive("griddedLegend",["$log","$window",function(e,t){return{restrict:"E",templateUrl:"js/gridded/legend.html",scope:{legendId:"@",legend:"="},link:function(n,r){var a=r.find("svg")[0];function i(){var t=n.legend,r=d3.select(a);if(r.selectAll("g").remove(),t){e.debug("legend.title",t.getTitle()),e.debug("legend.length",t.length),e.debug("legend.colors",t.getColors()),e.debug("legend.quantities",t.getQuantities()),e.debug("legend.labels",t.getLabels()),e.debug("legend.original_labels",t.getOriginalLabels());var i=parseFloat(r.style("width").replace("px","")),o=parseFloat(r.style("height").replace("px","")),s=t.getData(),l=i/s.length,c=30,d=2;e.debug("svg dimensions",i,o),e.debug("legend cell width",l);var u=r.append("g"),p=u.selectAll("g.cell").data(s).enter().append("g").attr("class","cell").attr("transform",function(e,t){return"translate("+t*l+","+d+")"}).append("rect").attr("height",c).attr("width",l).style("stroke","black").style("stroke-width","1px").style("fill",function(e,t){return e.color});if(t.ldef.legend_delimiter_every){var g=t.ldef.legend_delimiter_every,f=0,h=s.map(function(e,t){return t+1===s.length||(f+=s[t+1].quantity-s[t].quantity)>=g&&(f=0,!0)}),m=[l+1,c,l+1,c].join(","),v=[2*l+c,c].join(","),y=[l+1,c,l+c+1,0].join(",");e.debug("legend_delimiter_every",g),p.style("stroke-dasharray",function(e,t){return 0===t?h[t]?void 0:y:h[t]?v:m}).attr("width",function(e,t){var n=parseFloat(d3.select(this).attr("width"));return h[t]?n:n+1}),u.selectAll("g.cell").append("line").attr("stroke",function(e,t){return h[t]?"black":"none"}).attr("stroke-width",2).attr("x1",l-1).attr("x2",l-1).attr("y1",0).attr("y2",c)}p.append("title").text(function(e){return e.label});var b=5,w=3,x=u.selectAll("g.cell")[0],k=Math.floor(x.length/2);_(d3.select(x[0]),s[0].label,"start"),_(d3.select(x[k]),s[k].label,"middle"),_(d3.select(x[x.length-1]),s[s.length-1].label,"end"),t.ldef.legend_units&&r.append("g").append("text").attr("dx",i/2).attr("dy",75+d).attr("text-anchor","middle").text(t.ldef.legend_units),r.append("g").append("text").attr("dx",5).attr("dy",100+d).attr("font-size","18px").attr("text-anchor","right").text(t.ldef.title+", "+t.ldef.extent.current.label),r.append("g").append("text").attr("dx",5).attr("dy",118+d).attr("font-size","11px").attr("text-anchor","right").text("USA National Phenology Network, www.usanpn.org")}function _(e,t,n){var r=d+c+w;e.append("line").attr("x1",l/2).attr("y1",r).attr("x2",l/2).attr("y2",r+b).attr("stroke","black").attr("stroke-width","1"),e.append("text").attr("dx",l/2).attr("dy","3.8em").style("text-anchor",n).text(t)}}n.$watch("legend",i),$(t).bind("resize",i),n.$watch("legend.layer.extent.current",i),n.$on("$destroy",function(){e.debug("legend removing resize handler"),$(t).unbind("resize",i)})}}}]).filter("thirtyYearAvgDayOfYear",["dateFilter",function(e){var t=new Date(2010,0);return function(n,r){"string"==typeof n&&(n=parseFloat(n));var a=n instanceof Date?n:new Date(t.getTime()+864e5*(n-1));return r?a:e(a,"MMMM d")}}]).filter("legendDoy",["dateFilter",function(e){var t=new Date(2010,0),n=new Date((new Date).getFullYear(),0);return function(r,a,i){return 0===(r=Math.round(r))&&(r=1),a=a||"MMM d",e(new Date((i?n:t).getTime()+864e5*(r-1)),a)}}]).filter("legendGddUnits",["numberFilter",function(e){return function(t,n){return e(t,0)+(n?" AGDD":"")}}]).filter("legendDegrees",["numberFilter",function(e){return function(t,n){return e(t,0)+"°"+(n||"F")}}]).filter("legendAgddAnomaly",["numberFilter",function(e){return function(t,n){if(0===t)return"No Difference";var r=t<0;return e(Math.abs(t),0)+(n?" AGDD ":" ")+(r?"<":">")+" Avg"}}]).filter("agddDefaultTodayElevation",["dateFilter",function(e){var t=e(new Date,"MMMM d");return function(e){return e.reduce(function(e,n){return e||(n.label==t?n:void 0)},void 0)}}]).filter("agddDefaultTodayTime",["dateFilter",function(e){var t=e(new Date,"longDate");return function(e){return e.reduce(function(e,n){return e||(n.label==t?n:void 0)},void 0)}}]).filter("legendSixAnomaly",[function(){return function(e){if(0===e)return"No Difference";var t=e<0;return Math.abs(e)+" Days "+(t?"Early":"Late")}}]).filter("extentDates",["$log","dateFilter","DateExtentUtil",function(e,t,n){var r=864e5;function a(e){var a=new Date;return"yesterday"===e||"today"===e||"tomorrow"===e?("yesterday"===e?a.setTime(a.getTime()-r):"tomorrow"===e&&a.setTime(a.getTime()+r),e=t(a,"yyyy-MM-dd 00:00:00")):-1===e.indexOf("T")&&(e=a.getFullYear()+"-"+e+" 00:00:00"),n.parse(e).getTime()}return function(e,t,r){var i=t?a(t):void 0,o=r?a(r):void 0;return(i||o)&&(e=e.filter(function(e){var t=n.parse(e).getTime();return(!i||i&&t>i)&&(!o||o&&t<o)})),e}}]).service("WmsService",["$log","$q","$http","$sce","$httpParamSerializer","$filter","DateExtentUtil","WcsService","Analytics",function(e,t,n,r,a,i,o,s,l){var c,d,u,p,g,f=n.get("map-vis-layers.json"),h="1.1.1",m={},v={baseUrl:d,getLayers:function(o){function v(){var u=angular.copy(p),f=u.description;return u.categories.forEach(function(u){var p=angular.copy(u);delete p.name,delete p.layers,p.description=p.description||f,u.layers=u.layers.map(function(u){return new function(o,u){if(u.extent_values_filter){e.debug("layer "+u.name+" has an extent_values_filter, processing",u.extent_values_filter);var p,g=i(u.extent_values_filter.name),f=u.extent.values.map(function(e){return e.value}),v=[f].concat(u.extent_values_filter.args||[]);p=g.apply(void 0,v),e.debug("filteredValues",p.length>1?p[0]+"..."+p[p.length-1]:p),u.extent.values=u.extent.values.filter(function(e){return-1!==p.indexOf(e.value)}),u.extent.current&&-1===p.indexOf(u.extent.current.value)&&(e.debug("current extent value has become invalid, replacing with last option"),u.extent.current=u.extent.values.length?u.extent.values[u.extent.values.length-1]:void 0)}if(u.extent_default_filter){e.debug("layer "+u.name+" has an extent_default_filter, processing",u.extent_default_filter);var b=i(u.extent_default_filter.name),w=[u.extent.values].concat(u.extent_default_filter.values||[]);u.extent.current=b.apply(void 0,w)||u.extent.current,e.debug("resulting default value",u.extent.current)}u.description&&(u.$description=r.trustAsHtml(u.description));var x,k,_=256,S={service:"WMS",request:"GetMap",version:h,layers:u.name,styles:"",format:"image/png",transparent:!0,height:_,width:_,srs:"EPSG:3857"},C=new google.maps.ImageMapType({getTileUrl:function(e,t){var n=o.getProjection(),r=Math.pow(2,t),i=n.fromPointToLatLng(new google.maps.Point(e.x*_/r,e.y*_/r)),s=n.fromPointToLatLng(new google.maps.Point((e.x+1)*_/r,(e.y+1)*_/r)),l=L(i),c=L(s),u={};F.extent&&F.extent.current&&F.extent.current.addToWmsParams(u);var p={bbox:[l.lng,c.lat,c.lng,l.lat].join(",")};return x&&(p.sld_body=x),d+"?"+a(angular.extend(u,S,p))},tileSize:new google.maps.Size(_,_),isPng:!0,name:u.title||u.name}),F=angular.extend({},u,{googleLayer:C,getMap:function(){return o},getStyleRange:function(){return F.styleRange},setStyleRange:function(e){var t=this;(t.styleRange=e)?t.getLegend().then(function(n){for(var r=n.getStyleDefinition(),a=n.getData(),i=a[e[0]].quantity,o=a[e[1]].quantity,s=$(r),l=s.find("ColorMapEntry"),c=s.find("ColorMap");r[0].firstElementChild.firstElementChild.children.length>2;)r[0].firstElementChild.firstElementChild.removeChild(r[0].firstElementChild.firstElementChild.lastChild);0===l.length&&(l=s.find("sld\\:ColorMapEntry")),0===c.length&&(c=s.find("sld\\:ColorMap")),c&&c.attr("type","intervals"),l.each(function(){var e=$(this),t=parseInt(e.attr("quantity"));e.attr("opacity",t>i&&t<=o?"1.0":"0.0")});var d=function(e){var t;t=window.ActiveXObject?e.xml:(new XMLSerializer).serializeToString(e);return t}(r[0]);t.setStyle(d)}):t.setStyle(void 0)},setStyle:function(t){t!==x&&(t&&e.debug("style:",t),x=t,this.bounce())},getBounds:function(){if(u.bbox)return u.bbox.getBounds()},supportsData:function(){return"boolean"!=typeof u.supports_data||u.supports_data},currentYearOnly:function(){return"boolean"==typeof u.current_year_only&&u.current_year_only},getTitle:function(){return F.title?F.title.replace(/^(.*?)\s+-\s+(.*)$/,"$2"):void 0},getAbstract:function(){return F.abstract?F.abstract.replace(/\s*developer notes.*$/i,""):void 0},fit:function(){var e=F.getBounds();return e&&o.fitBounds(e),F},bounce:function(){return o.overlayMapTypes.length&&o.overlayMapTypes.pop(),o.overlayMapTypes.push(C),F},bouncePest:function(e){if(!e)return k&&k.setMap(null),F;var r=t.defer(),a="https://data.usanpn.org:3006/v0/agdd/pestMap?species="+e+"&date="+F.extent.current.value.substring(0,10);-1!=location.hostname.indexOf("dev")&&(a="https://data-dev.usanpn.org:3006/v0/agdd/pestMap?species="+e+"&date="+F.extent.current.value.substring(0,10)),n.get(a,{params:{}}).then(function(e){var t={north:e.data.bbox[3],south:e.data.bbox[1],east:e.data.bbox[2],west:e.data.bbox[0]};return k&&k.setMap(null),(k=new google.maps.GroundOverlay(e.data.clippedImage,t,{clickable:!1})).setOpacity(.75),k.setMap(o),F},r.reject)},on:function(){return l.trackEvent("gridded-layer","on",this.getTitle()),o.overlayMapTypes.push(C),F},onPest:function(){return l.trackEvent("gridded-layer","on",this.getTitle()),F},off:function(){return o.overlayMapTypes.length&&(l.trackEvent("gridded-layer","off",this.getTitle()),o.overlayMapTypes.pop()),k&&k.setMap(null),F},offPest:function(){return o.overlayMapTypes.length&&(l.trackEvent("gridded-layer","off",this.getTitle()),o.overlayMapTypes.pop()),k&&k.setMap(null),F},getLegend:function(){var r=this,a=t.defer();return n.get(d,{params:{service:"wms",request:"GetStyles",version:h,layers:u.name}}).then(function(t){e.debug("legend response",t);var n=$($.parseXML(t.data)),i=n.find("ColorMap"),o=n.find("UserStyle");0===i.length&&(i=n.find("sld\\:ColorMap"),o=n.find("sld\\:UserStyle"));var s=o.toArray(),l=0,c=0;if("Emerald Ash Borer"===r.pest)for(c=0;c<s.length;c++)"emerald_ash_borer"===s[c].firstElementChild.textContent&&(l=c);else if("Apple Maggot"===r.pest)for(console.log("apple maggot"),c=0;c<s.length;c++)"apple_maggot"===s[c].firstElementChild.textContent&&(l=c);else if("Hemlock Woolly Adelgid"===r.pest)for(c=0;c<s.length;c++)"hemlock_woolly_adelgid"===s[c].firstElementChild.textContent&&(l=c);else if("Winter Moth"===r.pest)for(c=0;c<s.length;c++)"winter_moth"===s[c].firstElementChild.textContent&&(l=c);else if("Lilac Borer"===r.pest)for(c=0;c<s.length;c++)"lilac_borer"===s[c].firstElementChild.textContent&&(l=c);m[u.name]=0!==i.length?new y($(i.toArray()[l]),u,n):void 0,a.resolve(m[u.name]),a.resolve(m[u.name].setLayer(r))},a.reject),a.promise},getGriddedData:function(e){return s.getGriddedData(c,this,e,5)}});return F;function L(e){if(!(Math.abs(e.lng())>180||Math.abs(e.lat())>90)){var t=.017453292519943295*e.lng(),n=6378137*t,r=.017453292519943295*e.lat();return{lng:n,lat:3189068.5*Math.log((1+Math.sin(r))/(1-Math.sin(r)))}}}}(o,angular.extend(angular.copy(p),g[u.name],u))})}),u}var w=t.defer();return p&&g?w.resolve(v()):f.then(function(t){var r;p=t.data,r=p.geo_server.url,u=(d=(c=r)+"/wms")+"?service=wms&version="+h+"&request=GetCapabilities",e.debug("layer_config",t.data),n.get(u).then(function(t){var n=$($.parseXML(t.data));g=function(e){if(!e||e.length<2)return;var t=[];return e.slice(1).each(function(e,n){t.push(n)}),t.map(b).reduce(function(e,t){return e[t.name]=t,e},{})}(n.find("Layer")),e.debug("wms_layer_defs",g),w.resolve(v())},w.reject)},w.reject),w.promise}};function y(e,t,n){function r(e){var t=i(e.name);return function(n,r){var a=[r];return e.args&&(a=a.concat(e.args)),t.apply(void 0,a)}}var a,o,s=t.legend_label_filter?r(t.legend_label_filter):angular.identity,l=t.gridded_label_filter?r(t.gridded_label_filter):void 0;0===(a=e.find("ColorMapEntry")).length&&(a=e.find("sld\\:ColorMapEntry")),o=a.toArray().reduce(function(e,t,n){var r=$(t),a=parseFloat(r.attr("quantity")),i=r.attr("label");return e.push({color:r.attr("color"),quantity:a,original_label:i,label:0===n?i:s(i,a)}),e},[]),this.styleDefinition=n,this.ldef=t,this.lformat=s,this.gformat=l,this.title_data=o[0],this.data=o.slice(1),this.length=this.data.length}function b(e){var t,n,r=$(e),a={name:r.find("Name").first().text(),title:r.find("Title").first().text().replace(/\((.+?)\)/g,""),abstract:r.find("Abstract").first().text(),bbox:function(e){if(e.length){var t={westBoundLongitude:parseFloat(e.find("westBoundLongitude").text()),eastBoundLongitude:parseFloat(e.find("eastBoundLongitude").text()),southBoundLatitude:parseFloat(e.find("southBoundLatitude").text()),northBoundLatitude:parseFloat(e.find("northBoundLatitude").text()),getBounds:function(){return new google.maps.LatLngBounds(new google.maps.LatLng(t.southBoundLatitude,t.westBoundLongitude),new google.maps.LatLng(t.northBoundLatitude,t.eastBoundLongitude))}};return[t.westBoundLongitude,t.eastBoundLongitude,t.southBoundLatitude,t.northBoundLatitude].reduce(function(e,t){return e||0===t||-1===t},!1)?void 0:t}}(r.find("EX_GeographicBoundingBox").first()),style:(t=r.find("Style").first(),n=$(t),{name:n.find("Name").first().text(),title:n.find("Title").first().text().replace(/\((.+?)\)/g,""),legend:n.find("OnlineResource").attr("xlink:href")}),extent:function(e){var t,n,r,a,o=$(e),s=o.text(),l=o.attr("default"),c=o.attr("name"),d="yyyy";if(!c||!s)return;function u(e,t){return e||(t.value==l?t:void 0)}if("time"===c){if(-1===s.indexOf("/"))return t=s.split(",").map(function(e){return new w(e)}),l=l.replace(/0Z/,"0.000Z"),{label:"Date",type:"date",current:t.reduce(u,void 0),values:t};if((t=/^([^\/]+)\/(.*)\/P1Y$/.exec(s))&&3===t.length&&(n=new w(t[1],d),(r=new w(t[2],d)).date.getFullYear()>n.date.getFullYear())){for(t=[n],a=n.date.getFullYear()+1;a<r.date.getFullYear();a++)t.push(new w(a+"-01-01T00:00:00.000Z",d));return t.push(r),{label:"Year",type:"year",current:r,values:t}}}else if("elevation"===c)return t=s.split(",").map(function(e){return new function(e){return{value:e,label:i("thirtyYearAvgDayOfYear")(e),addToWmsParams:function(t){t.elevation=e},addToWcsParams:function(t){t.subset||(t.subset=[]),t.subset.push("http://www.opengis.net/def/axis/OGC/0/elevation("+e+")")}}}(e)}),{label:"Day of Year",type:"doy",current:t.reduce(u,void 0),values:t}}(r.find("Extent").first())};return a.bbox||(a.bbox=function(e){if(e.length){var t={westBoundLongitude:parseFloat(e.attr("minx")),eastBoundLongitude:parseFloat(e.attr("maxx")),southBoundLatitude:parseFloat(e.attr("miny")),northBoundLatitude:parseFloat(e.attr("maxy")),getBounds:function(){return new google.maps.LatLngBounds(new google.maps.LatLng(t.southBoundLatitude,t.westBoundLongitude),new google.maps.LatLng(t.northBoundLatitude,t.eastBoundLongitude))}};return t}}(r.find("LatLonBoundingBox").first())),a}function w(e,t){var n=o.parse(e);return{value:e,date:n,label:i("date")(n,t||"longDate"),addToWmsParams:function(t){t.time=e},addToWcsParams:function(t){t.subset||(t.subset=[]),t.subset.push('http://www.opengis.net/def/axis/OGC/0/time("'+e+'")')}}}return y.prototype.setLayer=function(e){return this.layer=e,this},y.prototype.getData=function(){return this.data},y.prototype.getStyleDefinition=function(){return this.styleDefinition},y.prototype.getTitle=function(){return this.title_data.label},y.prototype.getColors=function(){return this.data.map(function(e){return e.color})},y.prototype.getQuantities=function(){return this.data.map(function(e){return e.quantity})},y.prototype.getLabels=function(){return this.data.map(function(e){return e.label})},y.prototype.getOriginalLabels=function(){return this.data.map(function(e){return e.original_label})},y.prototype.formatPointData=function(e){return(this.gformat||this.lformat)(e,e)},y.prototype.getPointData=function(e){var t,n,r;for(t=0;t<this.data.length;t++){if(n=this.data[t],r=t+1<this.data.length?this.data[t+1]:void 0,e==n.quantity)return n;if(r&&e>=n.quantity&&e<r.quantity)return n}},v}]).service("WcsService",["$log","$q","$http","uiGmapGoogleMapApi",function(e,t,n,r){return r.then(function(t){e.debug("WcsService: adding functionality to Number/Google Maps prototypes."),Number.prototype.toRad=function(){return this*Math.PI/180},Number.prototype.toDeg=function(){return 180*this/Math.PI},t.LatLng.prototype.destinationPoint=function(e,t){t/=6371,e=e.toRad();var n=this.lat().toRad(),r=this.lng().toRad(),a=Math.asin(Math.sin(n)*Math.cos(t)+Math.cos(n)*Math.sin(t)*Math.cos(e)),i=r+Math.atan2(Math.sin(e)*Math.sin(t)*Math.cos(n),Math.cos(t)-Math.sin(n)*Math.sin(a));return isNaN(a)||isNaN(i)?null:new google.maps.LatLng(a.toDeg(),i.toDeg())}}),{getGriddedData:function(r,a,i,o){var s=r+"/wcs",l=t.defer(),c=[0,80,180,270].map(function(e){return i.destinationPoint(e,o/2)}),d={service:"WCS",request:"GetCoverage",version:"2.0.1",coverageId:a.name.replace(":","__"),format:"application/gml+xml",subset:[]};return d.subset.push("http://www.opengis.net/def/axis/OGC/0/Long("+[c[3].lng(),c[1].lng()].join(",")+")"),d.subset.push("http://www.opengis.net/def/axis/OGC/0/Lat("+[c[2].lat(),c[0].lat()].join(",")+")"),a.extent&&a.extent.current&&(null!=a.pest?d.subset.push('http://www.opengis.net/def/axis/OGC/0/time("'+a.extent.current.value+'")'):a.extent.current.addToWcsParams(d)),e.debug("wcsArgs",d),n.get(s,{params:d}).then(function(t){e.debug("wcs response",t);var n=$($.parseXML(t.data)),r=n.find("tupleList").text();e.debug("wcs_data",n),e.debug("tuples",r),r?l.resolve(r.trim().split(" ").map(function(e){return parseFloat(e)})):l.reject()},l.reject),l.promise}}}]),angular.module("npn-viz-tool.help",[]).factory("HelpService",["$timeout",function(e){var t,n="look-at-me",r={lookAtMe:function(a,i){t&&r.stopLookingAtMe(t),$(a).hasClass(n)||e(function(){$(a).addClass(n),t=a,e(function(){r.stopLookingAtMe(a)},65e3)},i||0)},stopLookingAtMe:function(e){$(e).removeClass(n),t=null}};return r}]).directive("helpVideoControl",["$http","$sce",function(e,t){return{restrict:"E",template:'<a ng-show="videos.length" title="Help" href id="help-video-control" class="btn btn-default btn-xs" ng-click="visible = !visible;"><i class="fa fa-question"></i></a><div ng-show="visible" id="help-video-content"><a class="close" href ng-click="visible = false"><i class="fa fa-times-circle-o" aria-hidden="true"></i></a><h4>{{title}}<span ng-if="selection.video"> <a href ng-click="selection.video = null"><i class="fa fa-window-close" aria-hidden="true"></i></a></span></h4><ul class="list-unstyled" ng-show="!selection.video"><li ng-repeat="video in videos"><a href ng-click="selection.video = video;">{{video.title}}</a></li></ul><span ng-if="selection.video" ng-bind-html="selection.video.$embed"></span>',scope:{},link:function(n){n.visible=!1,n.$watch("visible",function(){n.selection={}}),n.$watch("selection.video",function(e){n.title=e?e.title:"Help videos"}),e.get("help-videos.json").then(function(e){n.videos=e.data.map(function(e){return e.$embed=t.trustAsHtml(e.embed),e})})}}}]),angular.module("npn-viz-tool.layers",["npn-viz-tool.filter","ngResource"]).factory("LayerService",["$rootScope","$http","$q","$log","uiGmapIsReady","Analytics",function(e,t,n,r,a,i){var o=null,s=null,l=a.promise(1).then(function(e){return s=e[0].map,r.debug("LayerService - map is ready"),t.get("layers/layers.json").then(function(e){var t=e.data;o={},t.forEach(function(e,t){e.index=t,o[e.id]=e}),r.debug("LayerService - layer list is loaded",o)})}),c={strokeColor:"#666",strokeOpacity:null,strokeWeight:1,fillColor:"#c0c5b8",fillOpacity:null,zIndex:0};function d(e){if(!e.properties.CENTER){var t,n,r,a,i,o,s=e.geometry,l="Polygon"===s.type?s.coordinates[0]:s.coordinates.reduce(function(e,t){return e.concat(t[0])},[]);for(t=0;t<l.length;t++)n=l[t],0===t?(i=o=n[0],r=a=n[1]):(i=Math.max(i,n[0]),o=Math.min(o,n[0]),r=Math.max(r,n[1]),a=Math.min(a,n[1]));e.properties.CENTER={latitude:a+(r-a)/2,longitude:o+(i-o)/2}}}function u(e,t){e.properties||(e.properties={}),e.properties.NAME||(e.properties.NAME=""+t)}function p(){s.data.setStyle(function(e){var t=e.getProperty("$style");return t&&"function"==typeof t?t(e):t?angular.extend(c,t):c})}function g(e){if(e.loaded){for(var t=[],n=0;n<e.loaded.length;n++)e.loaded[n].removeProperty("$style"),s.data.remove(e.loaded[n]),t.push(e.loaded[n]);return delete e.loaded,t}}return{getAvailableLayers:function(){var e=n.defer();return l.then(function(){var t,n,r=[];for(t in o)n=o[t],r.push({id:n.id,index:n.index,label:n.label,source:n.source,img:n.img,link:n.link});e.resolve(r.sort(function(e,t){return e.idx-t.idx}))}),e.promise},restyleLayers:function(){var e=n.defer();return l.then(function(){p(),e.resolve()}),e.promise},resetLayers:function(){var e=n.defer();return l.then(function(){for(var t in o)g(o[t]);e.resolve()}),e.promise},loadLayer:function(a,c){var g=n.defer();return l.then(function(){var l,f,h=o[a];if(!h)return r.debug("no such layer with id",a),g.reject(a);(l=h,f=n.defer(),l.data?f.resolve(l):(e.$broadcast("layer-load-start",{}),t.get("layers/"+l.file).then(function(t){var n=t.data;"GeometryCollection"===n.type?(r.debug("Translating GeometryCollection to FeatureCollection"),n.features=[],angular.forEach(n.geometries,function(e,t){n.features.push({type:"Feature",properties:{NAME:""+t},geometry:e})}),n.type="FeatureCollection",delete n.geometries):"Topology"===n.type&&(r.debug("Translating Topojson to GeoJson"),n=topojson.feature(n,n.objects[Object.keys(n.objects)[0]])),n.features.forEach(u),n.features.forEach(d),l.data=n,f.resolve(l),e.$broadcast("layer-load-end",{})})),f.promise).then(function(e){h.style=c,h.loaded=s.data.addGeoJson(h.data),h.loaded.forEach(function(e){e.setProperty("$style",c)}),p(),i.trackEvent("filter-layer","on",h.label),g.resolve([s,h.loaded])})}),g.promise},unloadLayer:function(e){var t=n.defer();return l.then(function(){var n=o[e];if(!n)return r.debug("no such layer with id",e),t.reject(e);i.trackEvent("filter-layer","off",n.label);var a=g(n);t.resolve(a)}),t.promise}}}]).directive("layerControl",["$rootScope","$q","$location","$log","LayerService","FilterService","GeoFilterArg",function(e,t,n,r,a,i,o){return{restrict:"E",templateUrl:"js/layers/layerControl.html",link:function(s){s.hasSufficientCriteria=i.hasSufficientCriteria;var l,c=[];function d(){s.layerOnMap={layer:"none"}}function u(){a.restyleLayers().then(function(){i.getFilter().hasSufficientCriteria()&&e.$broadcast("filter-rerun-phase2",{})})}function p(e,t){var n=e.getProperty("$FILTER");l=e,n||(n=new o(e,s.layerOnMap.layer.id),i.addToFilter(n),t.data.overrideStyle(e,{fillColor:"#800000"}),e.setProperty("$FILTER",n),u())}function g(e){var n=t.defer();return"none"===e?n.resolve(null):(a.loadLayer(e.id,function(e){var t={strokeOpacity:1,strokeColor:"#666",strokeWeight:1,fillOpacity:0};return e.getProperty("$FILTER")&&(t.fillColor="#800000",t.fillOpacity=.25),t}).then(function(e){if(!c.length){var t=e[0];s.$on("filter-phase2-end",function(e,n){if(l){var r=l.getProperty("CENTER");t.panTo(new google.maps.LatLng(r.latitude,r.longitude)),l=null}}),c.push(t.data.addListener("mouseover",function(e){t.data.overrideStyle(e.feature,{strokeWeight:3})})),c.push(t.data.addListener("mouseout",function(e){t.data.revertStyle()})),c.push(t.data.addListener("click",function(e){s.$apply(function(){p(e.feature,t)})})),c.push(t.data.addListener("rightclick",function(e){s.$apply(function(){var t,n;t=e.feature,n=t.getProperty("$FILTER"),l=t,n&&(i.removeFromFilter(n),t.setProperty("$FILTER",null),u())})}))}n.resolve(e)}),n.promise)}d(),s.$on("filter-reset",d),a.getAvailableLayers().then(function(t){function a(){e.$broadcast("layers-ready",{})}r.debug("av.layers",t),s.layers=t;var i=n.search();if(i.g){r.debug("init layers from query arg",i.g);var o,l,c=i.g.split(";"),d=c.map(function(e){return e.substring(e.indexOf(":")+1)}),u=c[0].substring(0,c[0].indexOf(":"));for(l=0;l<t.length;l++)if(t[l].id===u){o=t[l];break}o&&g(o).then(function(e){var t=e[0],n=e[1];s.layerOnMap.skipLoad=!0,s.layerOnMap.layer=o,n.forEach(function(e){-1!=d.indexOf(e.getProperty("NAME"))&&p(e,t)}),a()})}else a()}),s.$watch("layerOnMap.layer",function(t,n){s.layerOnMap.skipLoad?s.layerOnMap.skipLoad=!1:n&&"none"!=n?a.unloadLayer(n.id).then(function(n){var r=i.getFilter().getGeoArgs(),a=r.length>0;r.forEach(function(e){i.removeFromFilter(e)}),n.forEach(function(e){e.setProperty("$FILTER",null)}),a&&!i.isFilterEmpty()&&e.$broadcast("filter-rerun-phase2",{}),g(t)}):t&&g(t)}),s.$on("$destroy",function(){a.resetLayers(),c.forEach(function(e){e.remove()})})}}}]),angular.module("npn-viz-tool",["templates-npnvis","npn-viz-tool.map","uiGmapgoogle-maps","ui.bootstrap","angular-google-analytics","ngAnimate"]).config(["uiGmapGoogleMapApiProvider","$logProvider","AnalyticsProvider","$locationProvider",function(e,t,n,r){r.hashPrefix(""),e.configure({key:"AIzaSyAsTM8XaktfkwpjEeDMXkNrojaiB2W5WyE",v:"3.27",libraries:["geometry","drawing"]});var a=window.location.hash&&window.location.hash.match(/^#.*#debug/);t.debugEnabled(a),window.onbeforeunload=function(){return"You are about to navigate away from the USA-NPN Visualization Tool.  Are you sure you want to do this?"},n.setAccount("UA-30327499-1"),a&&n.enterDebugMode(!0)}]),angular.module("npn-viz-tool.map",["npn-viz-tool.layers","npn-viz-tool.stations","npn-viz-tool.toolbar","npn-viz-tool.filter","npn-viz-tool.bounds","npn-viz-tool.settings","npn-viz-tool.vis","npn-viz-tool.share","npn-viz-tool.export","npn-viz-tool.help","npn-viz-tool.gridded","npn-viz-tool.pest","uiGmapgoogle-maps"]).directive("npnVizMap",["$location","$timeout","uiGmapGoogleMapApi","uiGmapIsReady","RestrictedBoundsService","FilterService","GriddedControlService","HelpService",function(e,t,n,r,a,i,o,s){return{restrict:"E",templateUrl:"js/map/map.html",scope:{},controller:["$scope",function(l){var c,d,u={latitude:38.8402805,longitude:-97.61142369999999};function p(){l.stationView=!1}function g(){d&&(d.panTo(new google.maps.LatLng(u.latitude,u.longitude)),d.setZoom(4)),t(function(){l.stationView=!0},500),s.lookAtMe("#toolbar-icon-filter",5e3)}l.stationView=!1,n.then(function(t){c=t;var n=a.getRestrictor("base_map",new c.LatLngBounds(new google.maps.LatLng(0,-174),new google.maps.LatLng(75,-43)));l.map={center:u,zoom:4,options:{mapTypeId:t.MapTypeId.TERRAIN,mapTypeControl:!0,mapTypeControlOptions:{position:t.ControlPosition.RIGHT_BOTTOM},streetViewControl:!1,panControl:!1,zoomControl:!0,zoomControlOptions:{style:t.ZoomControlStyle.SMALL,position:t.ControlPosition.RIGHT_TOP},styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"transit.station",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.park",stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{visibility:"off"}]}]},events:{center_changed:n.center_changed}},r.promise(1).then(function(t){d=t[0].map;var n=e.search();n.gl||n.d&&(n.s||n.n)||g()})}),l.$on("gridded-layer-on",p),l.$on("gridded-layer-off",function(){i.isFilterEmpty()&&!o.layer&&g()}),l.$on("filter-phase1-start",p),l.$on("filter-reset",g),l.reset=function(){i.resetFilter(),l.stationView&&(l.stationView=!1,t(g,500))},l.$on("filter-phase2-end",function(e,t){t&&t.observation&&s.lookAtMe("#toolbar-icon-visualizations",5e3)})}]}}]).directive("npnWorking",["uiGmapIsReady",function(e){return{restrict:"E",template:'<div id="npn-working" ng-show="working"><i class="fa fa-circle-o-notch fa-spin fa-5x"></i></div>',scope:{},link:function(t){function n(){t.working=!0}function r(){t.working=!1}n(),e.promise(1).then(r),t.$on("filter-phase1-start",n),t.$on("filter-phase2-start",n),t.$on("filter-rerun-phase2",n),t.$on("filter-phase2-end",r),t.$on("layer-load-start",n),t.$on("layer-load-end",r)}}}]),angular.module("npn-viz-tool.vis-map",["npn-viz-tool.vis","npn-viz-tool.filter","npn-viz-tool.filters","npn-viz-tool.settings","npn-viz-tool.gridded","ui.bootstrap","rzModule"]).directive("mapVisGeoLayer",["$log","$q","$timeout","uiGmapIsReady","FilterService",function(e,t,n,r,a){return{restrict:"E",template:"",scope:{},link:function(e,i,o){var s=a.getFilter().getGeoArgs(),l=i.parent().parent().find(".angular-google-map-container");s.length&&(n(function(){$(l.children().first().children().first().children().first().children()[1]).css("z-index","99")},1e3),r.promise(2).then(function(e){e[0].map;var n=e[1].map,r=s.map(function(e){var n=t.defer();return e.arg.toGeoJson(function(e){n.resolve(e)}),n.promise});t.all(r).then(function(e){n.data.addGeoJson({type:"FeatureCollection",features:e}),n.data.setStyle(function(e){return{clickable:!1,strokeColor:"#666",strokeOpacity:null,strokeWeight:1,fillColor:"#800000",fillOpacity:null,zIndex:0}})})}))}}}]).directive("mapVisBoundsLayer",["$log","$q","$timeout","uiGmapIsReady","FilterService","BoundsFilterArg",function(e,t,n,r,a,i){return{restrict:"E",template:"",scope:{},link:function(t,o,s){var l=a.getFilter().getBoundsArgs(),c=o.parent().parent().find(".angular-google-map-container");l.length&&(n(function(){$(c.children().first().children().first().children().first().children()[1]).css("z-index","99")},1e3),r.promise(2).then(function(t){t[0].map;var n=t[1].map,r=l.map(function(e){return new google.maps.Rectangle(angular.extend({clickable:!1,bounds:e.arg.getBounds(),map:n},i.RECTANGLE_OPTIONS))});e.debug("mapVisBoundsLayer.rectangles",r)}))}}}]).service("MapVisMarkerService",["$log",function(e){var t={PATHS:["M0 22 L22 22 L10 0 Z","M0 22 L22 22 L22 0 L0 0 Z","M4 22 L18 22 L22 10 L18 0 L4 0 L0 10 Z"],getBaseIcon:function(e){return{path:t.PATHS[e],anchor:{x:11,y:11},scale:1}},renderMarkerToSvg:function(e,n,r){if(!(n<0||n>=t.PATHS.length)){r=r||"steelblue";var a=d3.select(e);a.selectAll("path").remove(),a.attr("viewBox","0 0 22 22").attr("width",16).attr("height",16),a.append("path").attr("d",t.PATHS[n]).attr("fill",r)}}};return t}]).directive("mapVisFilterTags",["$log","$timeout","MapVisMarkerService",function(e,t,n){return{restrict:"E",templateUrl:"js/mapvis/filter-tags.html",scope:{mapVisFilter:"="},link:function(e){e.removeFromFilter=function(t){e.mapVisFilter.splice(t,1)},e.$watchCollection("mapVisFilter",function(){t(function(){e.mapVisFilter.forEach(function(e,t){n.renderMarkerToSvg("svg#map-vis-marker-"+t,t)})})})}}}]).directive("mapVisInSituControl",["$log","$q","$http","$url","CacheService","FilterService",function(e,t,n,r,a,i){var o=["20","1198","35","36"],s="map-vis-insitu-implicit-species";function l(e,t){var n=t.map(function(e){return e.species_id});return e.forEach(function(e){-1===n.indexOf(e.species_id)&&t.push(e)}),t}return{restrict:"E",templateUrl:"js/mapvis/in-situ-control.html",scope:{mapVisFilter:"=",layer:"=",mapVisPlot:"&"},link:function(c){var d=i.getFilter(),u=d.getDateArg(),p=d.getGeographicArgs().length>0;function g(){var e;c.layer&&(c.disableControl=!1,(c.currentYearOnly=c.layer.currentYearOnly())&&(e=c.layer.extent.current.date.getFullYear(),-1===c.years.indexOf(e)?c.disableControl=!0:c.selection.year=e))}function f(){var t=c.selection.species,n=c.selection.year;t&&n&&(c.phenophaseList=[],i.getFilter().getPhenophasesForSpecies(t.species_id,!0,[n]).then(function(t){e.debug("phenophaseList",t),c.phenophaseList=t,c.selection.phenophase=t.length?t[0]:void 0}))}c.years=d3.range(u.getStartYear(),u.getEndYear()+1),c.selection={year:c.years[0]},c.$watch("layer",g),c.$watch("layer.extent.current",g),d.getSpeciesList().then(function(i){var d,u,g;e.debug("speciesList",i),p?(e.debug("filter has geographic args, not adding implicit species."),c.speciesList=i,c.selection.species=i.length?i[0]:void 0):(e.debug("filter has no geographic args merging in implicit species."),(d=i,u=t.defer(),g=a.get(s),g?u.resolve(l(g,d)):n.get(r("/npn_portal/species/getSpeciesFilter.json")).then(function(t){g=t.data.filter(function(e){return-1!==o.indexOf(e.species_id)}),e.debug("filtered implicit list of species",g),a.put(s,g,-1),u.resolve(l(g,d))}),u.promise).then(function(t){e.debug("merged",t),c.speciesList=t,c.selection.species=t.length?t[0]:void 0}))}),c.$watch("selection.species",f),c.$watch("selection.year",f),c.validSelection=function(){var e=c.selection;return!!(e.species&&e.phenophase&&e.year)&&(c.mapVisFilter.length<3&&(0===c.mapVisFilter.length||!c.mapVisFilter.reduce(function(t,n){return t||e.species===n.species&&e.phenophase===n.phenophase&&e.year===n.year},!1)))},c.addSelectionToFilter=function(){c.mapVisFilter.push(angular.extend({},c.selection))}}}}]).directive("mapVisMarkerInfoWindow",[function(){return{restrict:"E",templateUrl:"js/mapvis/marker-info-window.html"}}]).controller("MapVisCtrl",["$scope","$uibModalInstance","$filter","$log","$compile","$timeout","$q","$http","$url","uiGmapGoogleMapApi","uiGmapIsReady","RestrictedBoundsService","WmsService","ChartService","MapVisMarkerService","md5","GriddedInfoWindowHandler",function(e,t,n,r,a,i,o,s,l,c,d,u,p,g,f,h,m){var v,y,b,w,x=u.getRestrictor("map_vis");function k(){e.results.markerModels={},e.results.markers=[]}function _(){b&&b.close(),w&&w.close()}e.modal=t,e.wms_map={center:{latitude:48.35674,longitude:-122.39658},zoom:3,options:{disableDoubleClickZoom:!0,scrollwheel:!0,streetViewControl:!1,panControl:!1,zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.RIGHT_TOP},styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"transit.station",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.park",stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{visibility:"off"}]}]},events:{click:function(t,n,a){var i=a[0];r.debug("click",i),b&&b.open(i.latLng,e.selection.activeLayer,e.legend)},center_changed:x.center_changed}},c.then(function(t){v=t,d.promise(2).then(function(t){y=t[1].map,b=new m(y),p.getLayers(y).then(function(t){r.debug("layers",t),e.layers=t},function(){r.error("unable to get map layers?")})})}),e.selection={},e.results={},k(),e.$watch("selection.layerCategory",function(t){r.debug("layer category change ",t),e.selection.activeLayer&&(r.debug("turning off layer ",e.selection.activeLayer.name),e.selection.activeLayer.off(),delete e.selection.activeLayer,delete e.legend,_())}),e.$watch("selection.layer",function(t){t&&(_(),delete e.markerModel,r.debug("selection.layer",t),e.selection.activeLayer&&(r.debug("turning off layer ",e.selection.activeLayer.name),e.selection.activeLayer.off()),r.debug("fitting new layer ",t.name),e.selection.activeLayer=t.fit().on(),x.setBounds(t.getBounds()),delete e.legend,e.selection.activeLayer.getLegend(t).then(function(t){e.legend=t,e.selection.activeLayer.supportsData()?e.results.markers=Object.keys(e.results.markerModels).map(function(t){return e.results.markerModels[t].restyle().marker()}):k()}))}),e.$watch("selection.activeLayer.extent.current",function(t){var n,a,i;(n=e.selection.activeLayer)&&(r.debug("layer extent change ",n.name,t),_(),n.bounce(),n.currentYearOnly()&&(a=t.date.getFullYear(),(i=e.speciesSelections.filter(function(e){return e.year===a})).length!==e.speciesSelections.length&&(e.speciesSelections.splice(0,e.speciesSelections.length),i.forEach(function(t){e.speciesSelections.push(t)}),e.plotMarkers())))}),e.speciesSelections=[],e.$watchCollection("speciesSelections",function(t,n){r.debug("speciesSelections",t,n),n&&t&&n.length>t.length&&e.results.markers.length&&e.plotMarkers()}),e.markerEvents={click:function(t){r.debug("click",t),e.$apply(function(){var n=e.markerModel===e.results.markerModels[t.model.site_id];e.markerModel=e.results.markerModels[t.model.site_id],w||(w=new v.InfoWindow({maxWidth:500,content:""})),n||w.setContent('<i class="fa fa-circle-o-notch fa-spin"></i>'),w.setPosition(t.position),w.open(t.map)})}},e.$watch("markerModel",function(t){if(t){var n,c,d=[];r.debug("mapVisMarkerInfoWindow.markerModel",t),t.station||(n=o.defer(),d.push(n.promise),s.get(l("/npn_portal/stations/getStationDetails.json"),{params:{ids:t.site_id}}).then(function(e){var r=e.data;t.station=r&&r.length?r[0]:void 0,n.resolve()})),c=o.defer(),d.push(c.promise),delete t.gridded_legend_data,e.selection.activeLayer.getGriddedData(new google.maps.LatLng(t.latitude,t.longitude)).then(function(n){r.debug("tuples",n);var a=n&&n.length?n[0]:void 0;if(void 0===a||-9999===a||isNaN(a))return r.debug("received undefined, -9999 or Nan ignoring"),void c.resolve();var i=e.legend.getPointData(a);i||(i={label:e.legend.formatPointData(a),color:"#ffffff"}),t.gridded_legend_data=angular.extend({point:a},i),c.resolve()},function(){r.error("unable to get gridded data."),c.resolve()}),o.all(d).then(function(){var n=a("<div><map-vis-marker-info-window></map-vis-marker-info-window></div>")(e);i(function(){w.setContent(n.html()),i(function(){e.speciesSelections.forEach(function(e,n){t.data[n].record&&t.data[n].legend_data&&f.renderMarkerToSvg("svg#map-vis-iw-marker-"+n,n,t.data[n].legend_data.color)})},250)})})}}),e.plotMarkers=function(){_(),k(),e.working=!0;var t=e.results.markerModels,n=e.speciesSelections.map(function(n,a){var i=o.defer(),s={request_src:"npn-vis-map",start_date:n.year+"-01-01",end_date:n.year+"-12-31","species_id[0]":n.species.species_id,"phenophase_id[0]":n.phenophase.phenophase_id};return r.debug("gathering summary data for ",n,s),g.getSiteLevelData(s,function(o){r.debug("site level data has arrived for ",n,o);var s=(o||[]).reduce(function(n,r){return-9999===r.mean_first_yes_doy?n:(t[r.site_id]?t[r.site_id].add(r,a):n.push(t[r.site_id]=(new function(){var t={data:e.speciesSelections.map(function(){return{record:null}}),getSiteId:function(){return t.site_id},restyle:function(){return t.markerOpts.icon.strokeColor=t.data.reduce(function(e,t){return e+(t.record?1:0)},0)>1?"#00ff00":"#204d74",t.markerOpts.title=t.data.reduce(function(t,n,r){if(delete n.legend_data,n.record){n.legend_data=n.record.legend_data=e.legend.getPointData(n.record.mean_first_yes_doy)||{color:"#ffffff",label:"off scale"};var a=e.speciesSelections[r];""!==t&&(t+=", "),t+=a.year,t+=": ",t+=e.legend.formatPointData(n.record.mean_first_yes_doy)}return t},""),t.markerOpts.icon.fillColor=t.data[t.filter_index].legend_data.color,t.$markerKey=h.createHash(JSON.stringify(t)),t},marker:function(){return{$markerKey:t.$markerKey,site_id:t.site_id,latitude:t.latitude,longitude:t.longitude,markerOpts:t.markerOpts}},add:function(e,n){return t.data[n].record=e,t.markerOpts||(t.site_id=e.site_id,t.filter_index=n,t.latitude=e.latitude,t.longitude=e.longitude,t.markerOpts={zIndex:365-e.first_yes_doy,icon:angular.extend(f.getBaseIcon(n),{fillOpacity:1,strokeWeight:1})}),t.restyle()}};return t}).add(r,a)),n)},[]);r.debug("resulted in "+s.length+" added markers."),i.resolve()}),i.promise});o.all(n).then(function(){r.debug("all summary data has arrived..."),e.results.markers=Object.keys(t).reduce(function(e,n){return e.push(t[n].marker()),e},[]),e.working=!1})}}]),angular.module("templates-npnvis",["js/activity/activity.html","js/activity/curve-control.html","js/calendar/calendar.html","js/filter/choroplethInfo.html","js/filter/dateFilterTag.html","js/filter/filterControl.html","js/filter/filterTags.html","js/filter/networkFilterTag.html","js/filter/speciesFilterTag.html","js/gridded/date-control.html","js/gridded/doy-control.html","js/gridded/gridded-control.html","js/gridded/layer-control.html","js/gridded/legend.html","js/gridded/pest-legend.html","js/gridded/year-control.html","js/layers/layerControl.html","js/map/map.html","js/mapvis/filter-tags.html","js/mapvis/in-situ-control.html","js/mapvis/mapvis.html","js/mapvis/marker-info-window.html","js/pest/date-control.html","js/pest/legend.html","js/pest/pest-control.html","js/pest/pest-layer-control.html","js/scatter/scatter.html","js/settings/settingsControl.html","js/time/time.html","js/toolbar/tool.html","js/toolbar/toolbar.html","js/vis/visControl.html","js/vis/visDialog.html","js/vis/visDownload.html"]),angular.module("js/activity/activity.html",[]).run(["$templateCache",function(e){e.put("js/activity/activity.html",'<vis-dialog title="Activity Curves" modal="modal">\n<form class="form-inline plot-criteria-form">\n    <ul class="list-unstyled">\n        <li ng-repeat="input in selection.curves" class="control"><h4 ng-style="{color: input.color()}">Curve {{$index+1}}</h4><activity-curve-control input="input"></activity-curve-control></li>\n        <li  style="padding-top: 10px;">\n            <form class="form-inline">\n                <div class="form-group">\n                    <label for="frequency">Date Interval</label>\n                    <select class="form-control" id="frequency"\n                        ng-model="selection.frequency"\n                        ng-options="f as f.label for f in frequencies"></select>\n                </div>\n                <div class="form-group">\n                    <label for="interpolate">Line Interpolation</label>\n                    <select class="form-control" id="interpolate"\n                        ng-model="selection.interpolate"\n                        ng-options="i as i for i in [\'linear\',\'step-after\',\'monotone\']"></select>\n                </div>\n                \x3c!--div class="form-group">\n                    <label for="points">Data Points</label>\n                    <input type="checkbox" id="points" ng-model="selection.dataPoints" />\n                </div--\x3e\n            </form>\n        </li>\n    </ul>\n</form>\n\n<div class="panel panel-default main-vis-panel" >\n    <div class="panel-body">\n        <center>\n            <div id="vis-container">\n                <div id="vis-working" ng-show="working"><i class="fa fa-circle-o-notch fa-spin fa-5x"></i></div>\n                <activity-curves-chart selection="selection"></activity-curves-chart>\n            </div>\n        </center>\n    </div>\n</div>\n</vis-dialog>\n')}]),angular.module("js/activity/curve-control.html",[]).run(["$templateCache",function(e){e.put("js/activity/curve-control.html",'<div class="activity-curve-control">\n    <form class="form-inline">\n        <div class="form-group">\n            <label for="species-{{input.id}}">Species</label>\n            <select class="form-control" id="species-{{input.id}}"\n                ng-model="input.species"\n                ng-options="(o|speciesTitle) for o in speciesList">\n              <option ng-if="input.id > 0" value="">-- Select species --</option>\n            </select>\n        </div>\n        <div class="form-group" ng-show="input.species">\n            <label for="phenophase-{{input.id}}">Phenophase</label>\n            <select class="form-control" id="phenophase-{{input.id}}"\n                ng-model="input.phenophase"\n                ng-options="o.phenophase_name for o in input.validPhenophases"></select>\n        </div>\n        <div class="form-group" ng-show="input.species">\n            <label for="year-{{input.id}}">Year</label>\n            <select class="form-control" id="year-{{input.id}}"\n                ng-model="input.year"\n                ng-options="y for y in validYears"></select>\n        </div>\n        <div class="form-group" ng-show="input.species">\n            <label for="metric-{{input.id}}">Metric</label>\n            <select class="form-control" id="metric-{{input.id}}"\n                ng-model="input.metric"\n                ng-options="m as m.label for m in input.validMetrics"></select>\n            <label popover-placement="bottom" popover-title="Metric Description" uib-popover="{{ input.metric ? input.metric.description : \'\' }}" popover-trigger="mouseenter" popover-append-to-body="true"><i class="fa fa-info-circle" aria-hidden="true"></i></label>\n        </div>\n    </form>\n</div>\n')}]),angular.module("js/calendar/calendar.html",[]).run(["$templateCache",function(e){e.put("js/calendar/calendar.html",'<vis-dialog title="Calendar" modal="modal">\n<form class="form-inline plot-criteria-form">\n    <div class="form-group">\n        <label for="yearsOneInput">Select up to two years</label>\n        <input id="yearsOneInput" type="number" class="form-control"\n               ng-model="selection.year"\n               uib-typeahead="year for year in validYears | filter:$viewValue"\n               required placeholder="Year" />\n        <button class="btn btn-default" ng-click="addYear()" ng-disabled="!canAddYear()"><i class="fa fa-plus"></i></button>\n    </div>\n    <div class="form-group animated-show-hide">\n        <label for="speciesInput">Species phenophase combinations</label>\n        <select name="speciesInput" class="form-control" ng-model="selection.species" ng-options="(o|speciesTitle) for o in speciesList"></select>\n        <select name="phenophaseInput" class="form-control" ng-model="selection.phenophase" ng-options="o.phenophase_name for o in phenophaseList"></select>\n        <div class="btn-group" uib-dropdown is-open="selection.color_isopen">\n          <button type="button" class="btn btn-default dropdown-toggle" uib-dropdown-toggle style="background-color: {{colorRange[selection.color]}};">\n            &nbsp; <span class="caret"></span>\n          </button>\n          <ul class="dropdown-menu" role="menu">\n            <li ng-repeat="i in colors track by $index" style="background-color: {{colorRange[$index]}};"><a href ng-click="selection.color=$index;">&nbsp;</a></li>\n          </ul>\n        </div>\n        <button class="btn btn-default" ng-click="addToPlot()" ng-disabled="!canAddToPlot()"><i class="fa fa-plus"></i></button>\n    </div>\n</form>\n<div class="panel panel-default main-vis-panel" >\n    <div class="panel-body">\n        <center ng-if="error_message"><p class="text-danger">{{error_message}}</p></center>\n        <center>\n        <ul class="to-plot list-inline animated-show-hide" ng-if="toPlot.length || toPlotYears.length">\n            <li class="criteria" ng-repeat="y in toPlotYears">{{y}}\n                <a href ng-click="removeYear($index)"><i class="fa fa-times-circle-o"></i></a>\n            </li>\n            <li class="criteria" ng-repeat="tp in toPlot">{{tp|speciesTitle}}/{{tp.phenophase_name}} <i style="color: {{colorRange[tp.color]}};" class="fa fa-circle"></i>\n                <a href ng-click="removeFromPlot($index)"><i class="fa fa-times-circle-o"></i></a>\n            </li>\n            <li ng-if="data">\n                <label for="negativeInput">Absence Data</label>\n                <input type="checkbox" id="negativeInput" ng-model="selection.negative" />\n            </li>\n            <li ng-if="!data && toPlotYears.length && toPlot.length"><button class="btn btn-primary" ng-click="visualize()">Visualize</button></li>\n        </ul>\n        <div id="vis-container">\n            <div id="vis-working" ng-show="working"><i class="fa fa-circle-o-notch fa-spin fa-5x"></i></div>\n            <div class="chart-container">\n                <vis-download ng-if="data"\n                              selector=".chart"\n                              filename="npn-calendar.png"></vis-download>\n                <div><svg class="chart"></svg></div>\n            </div>\n        </div>\n        </center>\n\t\t\x3c!--\n\t\t<p class = \'citation-text\'>USA National Phenology Network, www.usanpn.org</p>\n\t\t--\x3e\n        <ul class="list-inline calendar-chart-controls" ng-if="data" style="float: right;">\n            <li>Label Size\n                <a href class="btn btn-default btn-xs" ng-click="decrFontSize()"><i class="fa fa-minus"></i></a>\n                <a href class="btn btn-default btn-xs" ng-click="incrFontSize()"><i class="fa fa-plus"></i></a>\n            </li>\n            <li>Label Position\n                <a href class="btn btn-default btn-xs" ng-click="yAxisConfig.labelOffset=(yAxisConfig.labelOffset-1)"><i class="fa fa-minus"></i></a>\n                <a href class="btn btn-default btn-xs" ng-click="yAxisConfig.labelOffset=(yAxisConfig.labelOffset+1)"><i class="fa fa-plus"></i></a>\n            </li>\n            <li>Band Size\n                <a href class="btn btn-default btn-xs" ng-click="incrBandPadding()" ng-disabled="yAxisConfig.bandPadding >= 0.95"><i class="fa fa-minus"></i></a>\n                <a href class="btn btn-default btn-xs" ng-click="decrBandPadding()" ng-disabled="yAxisConfig.bandPadding <= 0.05"><i class="fa fa-plus"></i></a>\n            </li>\n        </ul>\n    </div>\n</div>\n\n</vis-dialog>\n')}]),angular.module("js/filter/choroplethInfo.html",[]).run(["$templateCache",function(e){e.put("js/filter/choroplethInfo.html",'<div id="choroplethHelp" ng-show="show">\n    <h4>{{station_name}}</h4>\n    <h5>Record Densit{{data.length == 1 ? \'y\' : \'ies\'}}</h5>\n    <ul class="list-unstyled">\n        <li ng-repeat="scale in data">\n            <label>{{scale.title}} ({{scale.count}})</label>\n            <ul class="list-inline color-scale">\n                <li ng-repeat="color in scale.colors" style="background-color: {{color}};" class="{{scale.color === color ? \'selected\' :\'\'}}">\n                    <div ng-if="$first">{{scale.domain[0]}}</div>\n                    <div ng-if="$last">{{scale.domain[1]}}</div>\n                </li>\n            </ul>\n        </li>\n    </li>\n</div>')}]),angular.module("js/filter/dateFilterTag.html",[]).run(["$templateCache",function(e){e.put("js/filter/dateFilterTag.html",'<div class="btn-group filter-tag date">\n    <a class="btn btn-default">\n        <span popover-placement="bottom" popover-popup-delay="500" popover-append-to-body="true"\n              popover-trigger="\'mouseenter\'" uib-popover="Indicates the span of time represented on the map">{{arg.arg.start_date}} - {{arg.arg.end_date}} </span>\n        <span class="badge"\n              popover-placement="bottom" popover-popup-delay="500" popover-append-to-body="true"\n              popover-trigger="\'mouseenter\'" uib-popover="{{badgeTooltip}}">{{counts | speciesBadge:badgeFormat}}</span>\n    </a>\n    <a class="btn btn-default" ng-click="removeFromFilter(arg)">\n        <i class="fa fa-times-circle-o"></i>\n    </a>\n</div>\n')}]),angular.module("js/filter/filterControl.html",[]).run(["$templateCache",function(e){e.put("js/filter/filterControl.html",'<ul class="list-unstyled">\n    <li>\n        <label for="yearInputForm">Select up to ten (consecutive) years</label>\n        <form id="yearInputForm" name="yearInputForm">\n        <input id="start_date" type="number" class="form-control"\n               max="{{selected.date.end_date || thisYear}}"\n               ng-model="selected.date.start_date"\n               uib-typeahead="year for year in validYears | lte:selected.date.end_date | filter:$viewValue"\n               required placeholder="From" /> -\n        <input id="end_date" type="number" class="form-control"\n                min="{{selected.date.start_date || 1900}}"\n                ng-model="selected.date.end_date"\n                uib-typeahead="year for year in validYears | gte:selected.date.start_date | filter:$viewValue"\n                required placeholder="To" />\n        <button class="btn btn-default"\n                ng-disabled="yearInputForm.$invalid || ((selected.date.end_date - selected.date.start_date) > 10)"\n                ng-click="addDateRangeToFilter()"\n                popover-placement="right" popover-popup-delay="500" popover-append-to-body="true"\n                popover-trigger="\'mouseenter\'" uib-popover="Add this filter to the map"><i class="fa fa-plus"></i></button>\n        </form>\n        <p ng-if="selected.date.start_date < 2008" class="disclaimer">\n            You have selected a starting year prior to 2008 when the contemprary phenology data begins.  Prior to 2008 there is\n            a much more limited set of historical data and a limited number of species (E.g. lilac and honeysuckle).\n        </p>\n    </li>\n    <li class="divider" ng-if="filterHasDate()"></li>\n    <li ng-if="filterHasDate()">\n        <label>Animal Types</label>\n        <div isteven-multi-select\n            max-labels="3"\n            input-model="animalTypes"\n            output-model="speciesInput.animals"\n            button-label="species_type"\n            item-label="species_type"\n            tick-property="selected"\n            orientation="horizontal"\n            helper-elements="all none reset filter"\n            on-close="findSpecies()"></div>\n    </li>\n    <li ng-if="filterHasDate()">\n        <label>Plant Types</label>\n        <div isteven-multi-select\n            max-labels="3"\n            input-model="plantTypes"\n            output-model="speciesInput.plants"\n            button-label="species_type"\n            item-label="species_type"\n            tick-property="selected"\n            orientation="horizontal"\n            helper-elements="all none reset filter"\n            on-close="findSpecies()"></div>\n    </li>\n    <li ng-if="filterHasDate()">\n        <label>Partners</label>\n        <div class="row">\n            <div class="col-xs-9">\n                <div isteven-multi-select\n                    max-labels="3"\n                    input-model="partners"\n                    output-model="speciesInput.networks"\n                    button-label="network_name"\n                    item-label="network_name"\n                    tick-property="selected"\n                    orientation="horizontal"\n                    helper-elements="none reset filter"\n                    on-close="findSpecies()"></div>\n            </div>\n            <div class="col-xs-3">\n                <button id="add-networks-button" class="btn btn-default"\n                        ng-disabled="!speciesInput.networks.length || networksMaxedOut()"\n                        ng-click="addNetworksToFilter()"\n                        popover-placement="right" popover-popup-delay="500"\n                        popover-trigger="\'mouseenter\'" uib-popover="Add this filter to the map" popover-append-to-body="true">\n                    <i class="fa fa-plus"></i>\n                </button>\n            </div>\n        </div>\n\n    </li>\n    <li ng-if="filterHasDate()">\n        <label for="species">Species</label>\n        <div class="row">\n            <div class="col-xs-9">\n                <div isteven-multi-select\n                    max-labels="3"\n                    input-model="speciesList"\n                    output-model="selected.species"\n                    button-label="display"\n                    item-label="display"\n                    tick-property="selected"\n                    orientation="horizontal"\n                    helper-elements="none reset filter"></div>\n            </div>\n            <div class="col-xs-3">\n                <button id="add-species-button" class="btn btn-default"\n                        ng-disabled="!selected.species.length || speciesMaxedOut()"\n                        ng-click="addSpeciesToFilter()"\n                        popover-placement="right" popover-popup-delay="500"\n                        popover-trigger="\'mouseenter\'" uib-popover="Add this filter to the map" popover-append-to-body="true">\n                    <i class="fa" ng-class="{\'fa-refresh fa-spin\': findingSpecies, \'fa-plus\': !findingSpecies}"></i>\n                </button>\n            </div>\n        </div>\n    </li>\n    <li ng-if="filterHasDate()" style="text-align: right;">\n        <a class="btn btn-lg btn-primary" id="filter-placebo" href ng-click="$parent.$parent.close()" ng-disabled="!filterHasSufficientCriteria()">Execute Filter <i class="fa fa-search"></i></a>\n    </li>\n</ul>\n')}]),angular.module("js/filter/filterTags.html",[]).run(["$templateCache",function(e){e.put("js/filter/filterTags.html",'<ul class="list-inline filter-tags">\n    <li ng-repeat="s in getFilter().getSpeciesArgs()"><species-filter-tag arg="s"></species-filter-tag></li>\n    <li ng-repeat="n in getFilter().getNetworkArgs()"><network-filter-tag arg="n"></network-filter-tag></li>\n    <li ng-if="(date = getFilter().getDateArg())"><date-filter-tag arg="date"></date-filter-tag></li>\n</ul>')}]),angular.module("js/filter/networkFilterTag.html",[]).run(["$templateCache",function(e){e.put("js/filter/networkFilterTag.html",'<div class="btn-group filter-tag date" ng-class="{open: status.isopen}">\n    <a class="btn btn-default" ng-click="status.isopen = !status.isopen">\n        {{arg.arg.network_name}}\n        <span class="badge"\n              popover-placement="bottom" popover-popup-delay="500" popover-append-to-body="true"\n              popover-trigger="mouseenter" uib-popover="{{badgeTooltip}}">{{arg.counts | speciesBadge:badgeFormat}}</span>\n        <span class="caret"></span>\n    </a>\n    <ul class="dropdown-menu network-dd" role="menu">\n        <li class="inline">\n            <label for="ydo-{{arg.arg.network_id}}"><input id="ydo-{{arg.arg.network_id}}" type="checkbox" ng-model="arg.ydo"/> Yes Data Only</label>\n        </li>\n    </ul>\n    <a class="btn btn-default" ng-click="removeFromFilter(arg)">\n        <i class="fa fa-times-circle-o"></i>\n    </a>\n</div>\n')}]),angular.module("js/filter/speciesFilterTag.html",[]).run(["$templateCache",function(e){e.put("js/filter/speciesFilterTag.html",'<div class="btn-group filter-tag" ng-class="{open: status.isopen}">\n    <a class="btn btn-primary" style="background-color: {{arg.color}};" ng-disabled="!arg.phenophases" ng-click="status.isopen = !status.isopen">\n        {{arg.arg | speciesTitle:titleFormat}}\n        <span class="badge"\n              popover-placement="bottom" popover-popup-delay="500" popover-append-to-body="true"\n              popover-trigger="\'mouseenter\'" uib-popover="{{badgeTooltip}}">{{arg.counts | speciesBadge:badgeFormat}}</span>\n        <span class="caret"></span>\n    </a>\n    <ul class="dropdown-menu phenophase-list" role="menu">\n        <li class="inline">\n            <label for="ydo-{{arg.arg.species_id}}"><input id="ydo-{{arg.arg.species_id}}" type="checkbox" ng-model="arg.ydo"/> Yes Data Only</label>\n        </li>\n        <li class="divider"></li>\n        <li class="inline">Select <a href ng-click="selectAll(true)">all</a> <a href ng-click="selectAll(false)">none</a></li>\n        <li class="divider"></li>\n        <li ng-repeat="phenophase in arg.phenophases | filter:hasCount">\n            <label for="{{arg.arg.species_id}}-{{phenophase.phenophase_id}}"><input id="{{arg.arg.species_id}}-{{phenophase.phenophase_id}}" type="checkbox" ng-model="phenophase.selected"> <span class="badge">{{phenophase.count}}</span> {{phenophase.phenophase_name}}</label>\n        </li>\n    </ul>\n    <a class="btn btn-primary" style="background-color: {{arg.color}};" ng-click="removeFromFilter(arg)">\n        <i class="fa fa-times-circle-o"></i>\n    </a>\n</div>\n')}]),angular.module("js/gridded/date-control.html",[]).run(["$templateCache",function(e){e.put("js/gridded/date-control.html",'<label>Date</label>\n<p class="input-group">\n  <input type="text" class="form-control"\n        uib-datepicker-popup="longDate"\n        ng-model="selection"\n        is-open="isOpen"\n        min-date="minDate"\n        max-date="maxDate"\n        close-text="Close"\n        ng-click="open()" />\n  <span class="input-group-btn">\n    <button type="button" class="btn btn-default" ng-click="open()"><i class="glyphicon glyphicon-calendar"></i></button>\n  </span>\n</p>')}]),angular.module("js/gridded/doy-control.html",[]).run(["$templateCache",function(e){e.put("js/gridded/doy-control.html",'<label>Day of Year</label>\n<div class="form-inline" style="margin-bottom: 15px;">\n    <div class="form-group">\n        <label for="selectedMonth" class="sr-only">Month</label>\n        <select id="selectedMonth" class="form-control" ng-model="selection.month"\n                ng-options="m as (m | date:\'MMMM\') for m in months"></select>\n    </div>\n    <div class="form-group" ng-if="selection.month">\n        <label for="selectedDate" class="sr-only">Day</label>\n        <select id="selectedDate" class="form-control" ng-model="selection.date"\n                ng-options="d for d in dates"></select>\n    </div>\n    <div class="form-group">\n        <input class="form-control" style="width: 50px; cursor: default;" type="text" value="{{layer.extent.current.value | number:0}}" disabled />\n    </div>\n</div>')}]),angular.module("js/gridded/gridded-control.html",[]).run(["$templateCache",function(e){e.put("js/gridded/gridded-control.html",'<p class="empty-filter-notes">Spring Index and Accumulated Growing Degree Day (AGDD) maps display spatial and temporal patterns in temperature and predicted phenology across the United States. Use the controls below to select a gridded layer to view on the map.</p>\n<p><a href="https://www.usanpn.org/data/phenology_maps" target="_blank">More Info on Phenology Maps</a></p>\n<gridded-layer-control></gridded-layer-control>')}]),angular.module("js/gridded/layer-control.html",[]).run(["$templateCache",function(e){e.put("js/gridded/layer-control.html",'<div ng-if="layers" class="gridded-layer-control">\n    <div class="form-group">\n        <a ng-if="actions.reset && selection.layer" class="reset-layer pull-right" ng-click="actions.reset()"\n            uib-popover="Reset" popover-placement="right" popover-append-to-body="true" popover-trigger="mouseenter" popover-delay="500"><i class="fa fa-times-circle"></i></a>\n        <label for="selectedCategory">Category</label>\n        <select id="selectedCategory" class="form-control" ng-model="selection.layerCategory"\n                ng-options="cat as cat.name for cat in layers.categories"></select>\n\n    </div>\n    <div class="form-group" ng-if="selection.layerCategory">\n        <label for="selectedLayer">Layer</label>\n        <select id="selectedLayer" class="form-control" ng-model="selection.layer"\n                ng-options="l as l.getTitle() for l in selection.layerCategory.layers"></select>\n    </div>\n    <div class="extent-control" ng-if="selection.layer.extent" ng-switch="selection.layer.extent.type">\n        <gridded-doy-control ng-switch-when="doy" layer="selection.layer"></gridded-doy-control>\n        <gridded-date-control ng-switch-when="date" layer="selection.layer"></gridded-date-control>\n        <gridded-year-control ng-switch-when="year" layer="selection.layer"></gridded-year-control>\n    </div>\n    <gridded-opacity-slider layer="selection.layer"></gridded-opacity-slider>\n    <gridded-range-slider layer="selection.layer"></gridded-range-slider>\n    <p ng-if="selection.layer.abstract">{{selection.layer.getAbstract()}}</p>\n    <p ng-if="selection.layer.$description" ng-bind-html="selection.layer.$description"></p>\n</div>\n')}]),angular.module("js/gridded/legend.html",[]).run(["$templateCache",function(e){e.put("js/gridded/legend.html",'<svg class="gridded-legend"></svg>')}]),angular.module("js/gridded/pest-legend.html",[]).run(["$templateCache",function(e){e.put("js/gridded/pest-legend.html",'<svg class="pest-legend"></svg>')}]),angular.module("js/gridded/year-control.html",[]).run(["$templateCache",function(e){e.put("js/gridded/year-control.html",'<div class="form-group" ng-if="layer.extent">\n    <label for="selectedExtent">Year</label>\n    <select id="selectedExtent" class="form-control" ng-model="layer.extent.current" ng-options="v as v.label for v in layer.extent.values"></select>\n</div>')}]),angular.module("js/layers/layerControl.html",[]).run(["$templateCache",function(e){e.put("js/layers/layerControl.html",'<p class="empty-filter-notes" ng-if="!hasSufficientCriteria()">\n    Before adding a boundary layer to the map you must create and execute a filter.\n    A boundary layer will allow you to filter sites based on the geographic area it defines.\n</p>\n<ul class="list-unstyled" ng-if="hasSufficientCriteria()">\n    <li><label ng-class="{\'selected-layer\': layerOnMap.layer === \'none\'}"><a href ng-click="layerOnMap.layer=\'none\'">None</a></label>\n        \x3c!--input type="radio" id="layer-none" ng-model="layerOnMap.layer" value="none"/> <label for="layer-none">None</label--\x3e\n    </li>\n    <li ng-repeat="layer in layers">\n        <label  ng-class="{\'selected-layer\': layerOnMap.layer === layer}">{{layer.label}}</label>\n        <a href ng-click="layerOnMap.layer=layer"><img ng-src="{{layer.img}}" /></a>\n        <ul class="list-inline layer-links">\n            <li ng-if="layer.link"><a href="{{layer.link}}" target="_blank">More Info</a></li>\n            <li ng-if="layer.source"><a href="{{layer.source}}" target="_blank">Source</a></li>\n        </ul>\n    </li>\n</ul>')}]),angular.module("js/map/map.html",[]).run(["$templateCache",function(e){e.put("js/map/map.html",'<a title="Reset" href id="reset-control" class="btn btn-default btn-xs" ng-click="reset()"><i class="fa fa-refresh"></i></a>\n\n<npn-working></npn-working>\n\n<ui-gmap-google-map ng-if="map" center=\'map.center\' zoom=\'map.zoom\' options="map.options" events="map.events">\n    <npn-stations ng-if="stationView"></npn-stations>\n    <npn-filter-results></npn-filter-results>\n    <bounds-manager></bounds-manager>\n</ui-gmap-google-map>\n\n<share-control></share-control>\n<export-control></export-control>\n<help-video-control></help-video-control>\n<filter-tags></filter-tags>\n<choropleth-info></choropleth-info>\n<gridded-legend-main></gridded-legend-main>\n<pest-legend-main></pest-legend-main>\n\n<toolbar>\n    <tool id="filter" icon="fa-search" title="Filter">\n        <filter-control></filter-control>\n    </tool>\n    <tool id="layers" icon="fa-bars" title="Boundary Layers">\n        <layer-control></layer-control>\n    </tool>\n    <tool id="visualizations" icon="fa-bar-chart" title="Visualizations">\n        <vis-control></vis-control>\n    </tool>\n    <tool id="settings" icon="fa-cog" title="Settings">\n        <settings-control></settings-control>\n    </tool>\n\t<tool id="gridded" icon="fa-th" title="Gridded Layers">\n\t\t<gridded-control></gridded-control>\n\t</tool>\n    <tool id="pestmaps" icon="fa-bug" title="Pheno Forecasts">\n        <pest-control></pest-control>\n    </tool>\n</toolbar>\n\n'+"<img src = 'npn-logo-white.png' class='npn-logo' />\n<img src = 'usgs-logo.png' class='usgs-logo' /> \n")}]),angular.module("js/mapvis/filter-tags.html",[]).run(["$templateCache",function(e){e.put("js/mapvis/filter-tags.html",'<ul class="filter-tags map-vis list-inline pull-right">\n\t<li ng-if="mapVisFilter.length">\n        <div class="btn-group filter-tag">\n            <a class="btn btn-default">\n                <span>Multiple Observations Reported at this Location</span>\n                <img src=\'mult-species-legend.png\' />\n            </a>\n        </div>\t\t\n\t</li>\n    <li ng-repeat="tag in mapVisFilter">\n        <div class="btn-group filter-tag">\n            <a class="btn btn-default">\n                <span>{{tag.species | speciesTitle}}, {{tag.phenophase.phenophase_name}}, {{tag.year}} </span>\n                <svg id="map-vis-marker-{{$index}}"></svg>\n            </a>\n            <a class="btn btn-default" ng-click="removeFromFilter($index)">\n                <i class="fa fa-times-circle-o"></i>\n            </a>\n        </div>\n    </li>\n</ul>')}]),angular.module("js/mapvis/in-situ-control.html",[]).run(["$templateCache",function(e){e.put("js/mapvis/in-situ-control.html",'<div class="in-situ-control" ng-if="layer && layer.supportsData()">\n    <div class="disable-curtain" ng-if="disableControl"></div>\n    <hr />\n\t<h4>Plot Observed Onset</h4>\n    <div class="form-group" ng-if="speciesList">\n        <label for="selectedSpecies">Species</label>\n        <select id="selectedSpecies" class="form-control" ng-model="selection.species"\n                ng-options="s as (s | speciesTitle) for s in speciesList"></select>\n    </div>\n    <div class="form-group" ng-if="selection.species">\n        <label for="selectedPhenophse">Phenophase</label>\n        <select id="selectedPhenophse" class="form-control" ng-model="selection.phenophase"\n                ng-options="p as p.phenophase_name for p in phenophaseList"></select>\n    </div>\n    <div class="row">\n        <div class="col-xs-9">\n            <div class="form-group" ng-if="selection.species && selection.phenophase">\n                <label for="selectedYear">Year</label>\n                <select id="selectedYear" class="form-control" ng-model="selection.year" ng-disabled="currentYearOnly"\n                        ng-options="y as y for y in years"></select>\n            </div>\n        </div>\n        <div class="col-xs-3">\n            <div class="form-group text-right">\n                <label for="addToMapVis" style="visibility: hidden; display: block;">Add</label>\n                <button id="addToMapVis" class="btn btn-default"\n                        ng-click="addSelectionToFilter()"\n                        ng-disabled="!validSelection()"\n                        popover-placement="left" popover-popup-delay="500"\n                        popover-trigger="\'mouseenter\'"\n                        uib-popover="Add this species/phenophase/year to the map"\n                        popover-append-to-body="true">\n                    <i class="fa fa-plus"></i>\n                </button>\n            </div>\n        </div>\n    </div>\n    <div class="row">\n        <div class="col-xs-12">\n            <button id="mapVisPlot" class="btn btn-default pull-right"\n                    ng-click="mapVisPlot()"\n                    ng-disabled="!mapVisFilter.length"\n                    popover-placement="left" popover-popup-delay="500"\n                    popover-trigger="\'mouseenter\'"\n                    uib-popover="Add this species/phenophase/year to the map"\n                    popover-append-to-body="true">Plot data</button>\n        </div>\n    </div>\n</div>\n<div class="in-situ-control" ng-if="layer && !layer.supportsData()">\n\t<p style=\'font-style:italic;font-size:11px\'>Note: To plot Nature’s Notebook phenology observations against phenology maps, please select one of the following Gridded Layer categories: "Spring Indices, Historical Annual", "Spring Indices, Current Year" or "Spring Indices, Daily 30-year Average".</p>\n</div>\n')}]),angular.module("js/mapvis/mapvis.html",[]).run(["$templateCache",function(e){e.put("js/mapvis/mapvis.html",'<vis-dialog title="Phenology Maps" modal="modal">\n    <div class="container-fluid">\n        <div class="row">\n            <div class="col-xs-8">\n                <div id="vis-working" ng-show="working"><i class="fa fa-circle-o-notch fa-spin fa-5x"></i></div>\n                <map-vis-filter-tags map-vis-filter="speciesSelections"></map-vis-filter-tags>\n                <ui-gmap-google-map ng-if="wms_map" center=\'wms_map.center\' zoom=\'wms_map.zoom\' options="wms_map.options" events="wms_map.events">\n                    <ui-gmap-markers models="results.markers"\n                                    idKey="\'$markerKey\'"\n                                    coords="\'self\'"\n                                    icon="\'icon\'"\n                                    options="\'markerOpts\'"\n                                    doCluster="false"\n                                    events="markerEvents"></ui-gmap-markers>\n                    <map-vis-geo-layer></map-vis-geo-layer>\n                    <map-vis-bounds-layer></map-vis-bounds-layer>\n                </ui-gmap-google-map>\n\t\t\t\t<p class = \'citation-text\'>USA National Phenology Network, www.usanpn.org</p>\n                <gridded-legend legend="legend"></gridded-legend>\n                \x3c!--map-vis-marker-info-window></map-vis-marker-info-window--\x3e\n            </div>\n            <div class="col-xs-4">\n\t\t\t\t<h4>Select Gridded Layer</h4>\n\t\t\t\t<p><a href="https://www.usanpn.org/data/phenology_maps" target="_blank">More Info on Phenology Maps</a></p>\n                <gridded-layer-control></gridded-layer-control>\n                <map-vis-in-situ-control layer="selection.layer" map-vis-filter="speciesSelections" map-vis-plot="plotMarkers()"></map-vis-in-situ-control>\n            </div>\n        </div>\n    </div>\n</vis-dialog>')}]),angular.module("js/mapvis/marker-info-window.html",[]).run(["$templateCache",function(e){e.put("js/mapvis/marker-info-window.html",'<div class="map-vis-marker-info-window" ng-if="markerModel">\n    <div class="station-info" ng-if="markerModel.station">\n        <h3>{{markerModel.station.site_name}}</h3>\n        <ul class="list-unstyled">\n            <li ng-if="markerModel.station.group_name"><label>Group:</label> {{markerModel.station.group_name}}</li>\n            <li><label>Latitude:</label> {{markerModel.station.latitude}} <label>Longitude:</label> {{markerModel.station.longitude}}</li>\n            <li ng-if="markerModel.gridded_legend_data"><label>Gridded Layer Value:</label> <div class="legend-cell" style="background-color: {{markerModel.gridded_legend_data.color}};">&nbsp;</div> {{markerModel.gridded_legend_data.point | number:0}} ({{legend.formatPointData(markerModel.gridded_legend_data.point)}})</li>\n        </ul>\n    </div>\n    <div class="gridded-data" ng-if="markerModel.gridded_legend_data">\n    </div>\n    <div ng-repeat="md in markerModel.data" ng-init="tag = speciesSelections[$index];" ng-if="md.record">\n        <h4><span>{{tag.species | speciesTitle}}, {{tag.phenophase.phenophase_name}}, {{tag.year}} </span>\n                <svg id="map-vis-iw-marker-{{$index}}" uib-tooltip="{{md.legend_data.label}}" tooltip-append-to-body="true" tooltip-placement="top"></svg></h4>\n        <ul class="list-unstyled">\n            <li><label>Observed Day of Onset:</label> {{md.record.mean_first_yes_doy | number:0}} ({{legend.formatPointData(md.record.mean_first_yes_doy)}})<span ng-if="md.record && md.record.sd_first_yes_in_days > 0"> [Standard Deviation: {{md.record.sd_first_yes_in_days | number:1}}]</span></li>\n        </ul>\n    </div>\n</div>\n')}]),angular.module("js/pest/date-control.html",[]).run(["$templateCache",function(e){e.put("js/pest/date-control.html",'<label>Date</label>\n<p class="input-group">\n  <input type="text" class="form-control"\n        uib-datepicker-popup="longDate"\n        ng-model="selection"\n        is-open="isOpen"\n        datepicker-options="options"\n        close-text="Close"\n        ng-click="open()" />\n  <span class="input-group-btn">\n    <button type="button" class="btn btn-default" ng-click="open()"><i class="glyphicon glyphicon-calendar"></i></button>\n  </span>\n</p>')}]),angular.module("js/pest/legend.html",[]).run(["$templateCache",function(e){e.put("js/pest/legend.html",'<svg class="gridded-legend"></svg>')}]),angular.module("js/pest/pest-control.html",[]).run(["$templateCache",function(e){e.put("js/pest/pest-control.html",'<p class="empty-filter-notes">Pheno forecast maps show when management actions should be taken for key pest species. These maps are updated daily and are available 6 days in the future.  Pheno forecasts are based on published growing degree day (GDD) thresholds for points in pest life cycles when management actions are most effective.</p>\n<p><a href="https://www.usanpn.org/data/forecasts" target="_blank">More Info on Pheno Forecasts</a></p>\n<pest-layer-control></pest-layer-control>')}]),angular.module("js/pest/pest-layer-control.html",[]).run(["$templateCache",function(e){e.put("js/pest/pest-layer-control.html",'<div class="gridded-layer-control">\n\n    <div class="form-group">\n        <label for="selectedLayer">Layer</label>\n        <select id="selectedLayer" class="form-control" ng-model="selection.pest"\n                ng-options="l for l in pests"></select>\n    </div>\n   \n    <div class="extent-control" ></div>\n        <pest-date-control ng-if="selection.pest" layer="selection.layer"></pest-date-control>\n    </div>\n  \n    <p ng-if="selection.pest === \'Apple Maggot\'">Apple maggot larvae cause damage to ripening fruit. If left untreated, these pests can spread across the entire tree. Apple maggots primarily affect apple trees, but can also impact plum, apricot, pear, cherry and hawthorn trees. Apple maggot can be controlled by bagging the fruit, trapping, and spraying with herbicide after adults emerge and before they lay eggs. <a href="https://www.usanpn.org/data/forecasts/Apple_maggot" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Emerald Ash Borer\'">Emerald ash borer is a beetle that causes significant harm to ash trees throughout the eastern United States.  Adults lay eggs approximately 14 days after emergence, so spraying for adults is critical in the two-week window following emergence. <a href="https://www.usanpn.org/data/forecasts/EAB" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Hemlock Woolly Adelgid\'">Hemlock woolly adelgid can be deadly to hemlock trees and, in the eastern United States, lacks enemies to keep the population in check.  Researchers are working to identify the best time of year to release predator insects or biocontrols to limit the spread and damage of this pest. <a href="https://www.usanpn.org/data/forecasts/HWA" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Lilac Borer\'">Lilac borer (also known as ash borer) is a clear-wing moth that can damage lilac, ash, and privet trees and shrubs by burrowing into the heartwood. Trunk sprays should take place preceding or coinciding with adult emergence and subsequent egg hatch to kill larvae before they enter trunks. <a href="https://www.usanpn.org/data/forecasts/Lilac_borer" target="_blank">Learn more</a></p>\n    <p ng-if="selection.pest === \'Winter Moth\'">Winter moth is a non-native insect pest that causes damage to deciduous trees, particularly maples and oaks.  This species can be controlled with a biological control or by treating caterpillars with insecticide. <a href="https://www.usanpn.org/data/forecasts/Winter_moth" target="_blank">Learn more</a></p>\n</div>\n')}]),angular.module("js/scatter/scatter.html",[]).run(["$templateCache",function(e){e.put("js/scatter/scatter.html",'<vis-dialog title="Scatter Plot" modal="modal">\n<form class="form-inline plot-criteria-form">\n    <div class="form-group">\n        <label for="speciesInput">Select up to three species phenophase combinations</label>\n        <select name="speciesInput" class="form-control" ng-model="selection.species" ng-options="(o|speciesTitle) for o in speciesList"></select>\n        <select name="phenophaseInput" class="form-control" ng-model="selection.phenophase" ng-options="o.phenophase_name for o in phenophaseList"></select>\n        <div class="btn-group" uib-dropdown is-open="selection.color_isopen">\n          <button type="button" class="btn btn-default dropdown-toggle" uib-dropdown-toggle style="background-color: {{colorRange[selection.color]}};">\n            &nbsp; <span class="caret"></span>\n          </button>\n          <ul class="dropdown-menu" role="menu">\n            <li ng-repeat="i in colors track by $index" style="background-color: {{colorRange[$index]}};"><a href ng-click="selection.color=$index;">&nbsp;</a></li>\n          </ul>\n        </div>\n    </div>\n    <button class="btn btn-default" ng-click="addToPlot()" ng-disabled="!canAddToPlot()"><i class="fa fa-plus"></i></button>\n</form>\n\n<div class="panel panel-default main-vis-panel" >\n    <div class="panel-body">\n        <center>\n        <ul class="to-plot list-inline animated-show-hide" ng-if="toPlot.length">\n            <li class="criteria" ng-repeat="tp in toPlot">{{tp|speciesTitle}}/{{tp.phenophase_name}} <i style="color: {{colorRange[tp.color]}};" class="fa fa-circle"></i>\n                <a href ng-click="removeFromPlot($index)"><i class="fa fa-times-circle-o"></i></a>\n            </li>\n            <li>\n                <select class="form-control vis-axis" ng-model="selection.axis" ng-options="o as o.label for o in axis"></select>\n            </li>\n            <li>\n                <label for="fitLinesInput">Fit Line{{toPlot.length > 1 ? \'s\' : \'\'}}</label>\n                <input type="checkbox" id="fitLinesInput" ng-model="selection.regressionLines" />\n            </li>\n            <li>\n                <label for="individualPhenometrics">Use Individual Phenometrics</label>\n                <input type="checkbox" id="individualPhenometrics" ng-model="selection.useIndividualPhenometrics" />\n            </li>\n            <li ng-if="!data"><button class="btn btn-primary" ng-click="visualize()">Visualize</button></li>\n        </ul>\n        <div id="vis-container">\n            <div id="vis-working" ng-show="working"><i class="fa fa-circle-o-notch fa-spin fa-5x"></i></div>\n            <div class="chart-container">\n                <vis-download ng-if="data"\n                              selector=".chart"\n                              filename="npn-scatter-plot.png"></vis-download>\n                <div><svg class="chart"></svg></div>\n            </div>\n            <div ng-if="filteredDisclaimer" class="filter-disclaimer">For quality assurance purposes, only onset dates that are preceded by negative records are included in the visualization.</div>\n        </div>\n        </center>\n    </div>\n</div>\n\x3c!--pre ng-if="record">{{record | json}}</pre--\x3e\n\n</vis-dialog>\n')}]),angular.module("js/settings/settingsControl.html",[]).run(["$templateCache",function(e){e.put("js/settings/settingsControl.html",'<ul class="list-unstyled">\n    <li>\n        <Label for="clusterMarkersSetting">Cluster Markers</label>\n        <ul class="list-unstyled">\n            <li ng-repeat="option in [true,false]">\n                <input type="radio" id="clusterMarkers{{option}}" ng-model="settings.clusterMarkers.value"\n                       ng-value="{{option}}" /> <label for="clusterMarkers{{option}}">{{option | yesNo}}</label>\n            </li>\n        </ul>\n    </li>\n    <li class="divider"></li>\n    <li>\n        <label>Variable Displayed</label>\n        <ul class="list-unstyled">\n            <li ng-repeat="option in settings.tagBadgeFormat.options">\n                <input type="radio"\n                       id="{{option.value}}" ng-model="settings.tagBadgeFormat.value"\n                       value="{{option.value}}"> <label for="{{option.value}}">{{option.label}}</label>\n            </li>\n        </ul>\n    </li>\n    <li class="divider"></li>\n    <li>\n        <Label for="onlyYesData">Only Show Yes Data</label>\n        <ul class="list-unstyled">\n            <li ng-repeat="option in [true,false]">\n                <input type="radio" name="onlyYesData" id="onlyYesData{{option}}" ng-model="settings.onlyYesData.value"\n                       ng-value="{{option}}" /> <label for="onlyYesData{{option}}">{{option | yesNo}}</label>\n            </li>\n        </ul>\n    </li>\n    <li class="divider"></li>\n    <li>\n        <label>Species Tag Title</label>\n        <ul class="list-unstyled">\n            <li ng-repeat="option in settings.tagSpeciesTitle.options">\n                <input type="radio"\n                       id="{{option.value}}" ng-model="settings.tagSpeciesTitle.value"\n                       value="{{option.value}}"> <label for="{{option.value}}">{{option.label}}</label>\n            </li>\n        </ul>\n    </li>\n    <li class="divider"></li>\n    <li>\n        <label for="excludeLqd">Exclude less precise data from visualizations</label>\n        <ul class="list-unstyled">\n            <li ng-repeat="option in [true,false]">\n                <input type="radio" id="filterLqdSummary{{option}}" ng-model="settings.filterLqdSummary.value"\n                       ng-value="{{option}}" /> <label for="filterLqdSummary{{option}}">{{option | yesNo}}</label>\n            </li>\n        </ul>\n        <p>Selecting <strong>Yes</strong> will exclude data points which lack a "no" record preceding the first "yes" record from certain visualizations. </p>\n    </li>\n    <li class="divider"></li>\n    <li>\n        <label for="dataPrecisionFilter">Data Precision Filter</label>\n        <select class="form-control" ng-model="settings.dataPrecisionFilter.value"\n            ng-options="days as days+\' days\' for days in settings.dataPrecisionFilter.options" />\n        <p style="margin: 15px 0px;">Less precise data is removed from the scatter plot and map visualizations by only plotting data points preceded or followed by a “no” within 30 days. This filter can be adjusted here to  7, 14, or 30 days.</p>\n    </li>\n</ul>\n')}]),angular.module("js/time/time.html",[]).run(["$templateCache",function(e){e.put("js/time/time.html",'<vis-dialog title="Daily Accumulation" modal="modal">\n    <div class="controls">\n        <div class="threshold">\n            <label>Select AGDD Threshold</label>\n            <rzslider rz-slider-model="selection.threshold.value" rz-slider-options="selection.threshold.options"></rzslider>\n        </div>\n        <div class="days-of-the-year">\n            <label>Select Days of Year</label>\n            <rzslider rz-slider-model="selection.doys.value" rz-slider-options="selection.doys.options"></rzslider>\n        </div>\n        <div class="checkbox" ng-if="selection.lastYearValid">\n            <label ng-disabled="working">\n              <input type="checkbox" ng-model="selection.showLastYear"> Show data from previous year\n            </label>\n        </div>\n    </div>\n    <div class="panel panel-default main-vis-panel" >\n        <div class="panel-body">\n            <center>\n            <div id="vis-container">\n                <div id="vis-working" ng-show="working"><i class="fa fa-circle-o-notch fa-spin fa-5x"></i></div>\n                <div class="chart-container">\n                    <vis-download ng-if="!working"\n                                  selector=".chart"\n                                  filename="time-series.png"></vis-download>\n                    <div><svg class="chart"></svg></div>\n                </div>\n            </div>\n            </center>\n        </div>\n    </div>\n</vis-dialog>\n')}]),angular.module("js/toolbar/tool.html",[]).run(["$templateCache",function(e){e.put("js/toolbar/tool.html",'<div class="tool-content {{title.toLowerCase()}}" ng-show="selected">\n    <h2>{{title}}</h2>\n    <div ng-transclude>\n    </div>\n</div>')}]),angular.module("js/toolbar/toolbar.html",[]).run(["$templateCache",function(e){e.put("js/toolbar/toolbar.html",'<div class="toolbar">\n  <ul class="tools-list">\n    <li ng-repeat="t in tools" ng-class="{open: t.selected}"\n        popover-placement="right" uib-popover="{{(t.selected) ? \'Click to Collapse Menu\' : t.title}}" popover-trigger="\'mouseenter\'" popover-popup-delay="1000" popover-append-to-body="true"\n        ng-click="select(t)">\n      <i id="toolbar-icon-{{t.id}}" class="toolbar-icon fa {{t.icon}}"></i>\n    </li>\n  </ul>\n  <div class="toolbar-content" ng-class="{open: open}" ng-transclude></div>\n</div>\n')}]),angular.module("js/vis/visControl.html",[]).run(["$templateCache",function(e){e.put("js/vis/visControl.html",'<p class="empty-filter-notes" ng-if="isFilterEmpty()">\n    Before using a visualization you must create and execute a filter.\n    Visualizations use the species, and sometimes, date ranges you\'ve identified\n    in your filter as the basis for what you want to visualize.\n</p>\n<ul class="list-unstyled">\n    <li ng-repeat="vis in visualizations">\n        <a href ng-click="open(vis)" ng-class="{disabled: isFilterEmpty()}">{{vis.title}}</a>\n        <p>{{vis.description}}</p>\n    </li>\n</ul>')}]),angular.module("js/vis/visDialog.html",[]).run(["$templateCache",function(e){e.put("js/vis/visDialog.html",'<div class="modal-header">\n    <a href class="modal-dismiss" ng-click="modal.dismiss()"><i class="fa fa-times-circle-o fa-2x"></i></a>\n    <h3 class="modal-title">{{title}}</h3>\n</div>\n<div class="modal-body vis-dialog {{title | cssClassify}}" ng-transclude>\n</div>')}]),angular.module("js/vis/visDownload.html",[]).run(["$templateCache",function(e){e.put("js/vis/visDownload.html",'<div class="vis-download">\n    <a href ng-click="download()" title="Download"><i class="fa fa-download"></i></a>\n    <canvas id="visDownloadCanvas" style="display: none;"></canvas>\n    <a id="vis-download-link" style="display: none;">download</a>\n</div>')}]),angular.module("npn-viz-tool.pest",["npn-viz-tool.gridded-services"]).service("PestControlService",["$location",function(e){var t={getLegend:function(){return t.legend},getLayer:function(){return t.layer},addSharingUrlArgs:function(e){if(t.layer){var n=t.layer.name+"/"+t.layer.extent.current.value,r=t.layer.getStyleRange();r&&(n+="/"+r[0]+"/"+r[1]),e.gl=n}},getSharingUrlArgs:function(){var t=e.search().gl;if(t)return t.split(/\//)}};return t}]).directive("pestLegendMain",["PestControlService",function(e){return{restrict:"E",template:'<div id="pestLegendMain" ng-style="{display: shared.legend ? \'inherit\' : \'none\'}"><pest-legend legend="shared.legend"></pest-legend></div>',scope:{},link:function(t){t.shared=e}}}]).directive("pestControl",["$log","$rootScope","uiGmapGoogleMapApi","uiGmapIsReady","WmsService","PestControlService","GriddedInfoWindowHandler",function(e,t,n,r,a,i,o){return{restrict:"E",templateUrl:"js/pest/pest-control.html",link:function(s){var l,c;function d(){null==s.layers&&(!0,n.then(function(t){t,r.promise(1).then(function(t){c=t[0].map,l=new o(c),c.addListener("click",function(e){l.open(e.latLng,s.selection.activeLayer,s.legend)}),a.getLayers(c).then(function(t){e.debug("layers",t),s.layers=t,console.log("setting active layer to agdd base 50");for(var n=0;n<t.categories.length;n++)if("Temperature Accumulations, Current Day"===t.categories[n].name)for(var r=0;r<t.categories[n].layers.length;r++)"gdd:agdd_50f"===t.categories[n].layers[r].name&&(console.log(t.categories[n].layers[r].name),s.selection.layer=t.categories[n].layers[r])},function(){e.error("unable to get map layers?")})})}))}function u(){l&&l.close()}s.selection={},s.actions={reset:function(){delete s.selection.layerCategory,delete s.selection.layer}},s.$on("filter-reset",s.actions.reset),i.getSharingUrlArgs()?d():s.$on("tool-open",function(e,t){"pestmaps"===t.tool.id&&d()}),s.$watch("selection.layerCategory",function(n){if(e.debug("layer category change ",n),t.$broadcast("reset-gridded-layer"),s.selection.activeLayer){e.debug("turning off layer ",s.selection.activeLayer.name);var r=s.selection.activeLayer;s.selection.activeLayer.offPest(),delete s.selection.activeLayer,delete s.legend,delete i.legend,delete i.layer,u(),t.$broadcast("gridded-layer-off",{layer:r})}}),s.$on("reset-pest-layer",function(){if(delete s.selection.pest,delete s.layers,s.selection.activeLayer){e.debug("turning off layer ",s.selection.activeLayer.name);s.selection.activeLayer;s.selection.activeLayer.offPest(),delete s.selection.activeLayer,delete s.legend,delete i.legend,delete i.layer,u()}}),s.$watch("selection.pest",function(n){if(null!=s.selection.pest&&t.$broadcast("reset-gridded-layer"),u(),s.selection.timeSeriesDate=60,s.selection.activeLayer&&(e.debug("turning off layer ",s.selection.activeLayer.name),s.selection.activeLayer.offPest()),s.layers&&s.layers.categories)for(var r=0;r<s.layers.categories.length;r++)if("Temperature Accumulations, Current Day"===s.layers.categories[r].name)for(var a=0;a<s.layers.categories[r].layers.length;a++)"Hemlock Woolly Adelgid"===n?"gdd:agdd"===s.layers.categories[r].layers[a].name&&(s.selection.layer=s.layers.categories[r].layers[a],s.selection.activeLayer=s.layers.categories[r].layers[a]):"gdd:agdd_50f"===s.layers.categories[r].layers[a].name&&(s.selection.layer=s.layers.categories[r].layers[a],s.selection.activeLayer=s.layers.categories[r].layers[a]);if(s.selection.activeLayer){s.selection.activeLayer.pest=n;var o=new Date;o.setHours(0,0,0,0),s.selection.activeLayer.extent.current.date=o,s.selection.activeLayer.extent.current.value=o.toISOString();s.selection.activeLayer.extent.current.label=o.toLocaleString("en-us",{month:"long"})+" "+o.getDate()+", "+o.getFullYear(),delete s.legend,s.selection.activeLayer.getLegend().then(function(e){e.pest=s.selection.pest,i.legend=s.legend=e})}}),s.$watch("selection.layer",function(n){n&&(u(),e.debug("selection.layer",n),s.selection.activeLayer&&(e.debug("turning off layer ",s.selection.activeLayer.name),s.selection.activeLayer.offPest()),n.pest=s.selection.pest,e.debug("fitting new layer ",n.name),i.layer=s.selection.activeLayer=n.fit().onPest(),t.$broadcast("gridded-layer-on",{layer:s.selection.activeLayer}))}),s.$watch("selection.activeLayer.extent.current.date",function(e){u(),s.selection&&s.selection.activeLayer&&setTimeout(function(){s.selection.activeLayer.bouncePest(s.selection.pest)},500)})}}}]),angular.module("npn-viz-tool.vis-scatter",["npn-viz-tool.vis","npn-viz-tool.filter","npn-viz-tool.filters","npn-viz-tool.settings","ui.bootstrap"]).controller("ScatterVisCtrl",["$scope","$uibModalInstance","$timeout","$filter","$log","FilterService","ChartService",function(e,t,n,r,a,i,o){e.modal=t;var s=i.getColorScale();e.colors=s.domain(),e.colorRange=s.range(),e.axis=[{key:"latitude",label:"Latitude",axisFmt:d3.format(".2f")},{key:"longitude",label:"Longitude",axisFmt:d3.format(".2f")},{key:"elevation_in_meters",label:"Elevation (m)"},{key:"fyy",label:"Year"},{key:"prcp_fall",label:"Precip Fall (mm)"},{key:"prcp_spring",label:"Precip Spring (mm)"},{key:"prcp_summer",label:"Precip Summer (mm)"},{key:"prcp_winter",label:"Precip Winter (mm)"},{key:"tmax_fall",label:"Tmax Fall (C°)"},{key:"tmax_spring",label:"Tmax Spring (C°)"},{key:"tmax_summer",label:"Tmax Summer (C°)"},{key:"tmax_winter",label:"Tmax Winter (C°)"},{key:"tmin_fall",label:"Tmin Fall (C°)"},{key:"tmin_spring",label:"Tmin Spring (C°)"},{key:"tmin_summer",label:"Tmin Summer (C°)"},{key:"tmin_winter",label:"Tmin Winter (C°)"},{key:"daylength",label:"Day Length (s)"},{key:"acc_prcp",label:"Accumulated Precip (mm)"},{key:"gdd",label:"AGDD"}];var l=d3.format("d");function c(t){return(e.selection.axis.axisFmt||l)(t)}function d(){return angular.extend({},e.selection.species,e.selection.phenophase,{color:e.selection.color})}function u(){e.data=p=void 0,angular.forEach(h,function(e){delete e.data})}e.selection={color:0,axis:e.axis[0],regressionLines:!1,useIndividualPhenometrics:!1},e.$watch("selection.regressionLines",function(e,t){e!==t&&F()}),e.$watch("selection.axis",function(e,t){e!==t&&F()}),e.toPlot=[],i.getFilter().getSpeciesList().then(function(t){a.debug("speciesList",t),e.speciesList=t,t.length&&(e.selection.species=t[0])}),e.$watch("selection.species",function(){if(e.phenophaseList=[],e.selection.species){for(var t=i.getFilter().getDateArg().arg.start_date,n=i.getFilter().getDateArg().arg.end_date,r=[n];n>t;)n-=1,r.push(n);i.getFilter().getPhenophasesForSpecies(e.selection.species.species_id,!0,r).then(function(t){a.debug("phenophaseList",t),e.phenophaseList=t,t.length&&(e.selection.phenophase=t[0])})}}),e.canAddToPlot=function(){if(3===e.toPlot.length||!e.selection.species||!e.selection.phenophase)return!1;if(0===e.toPlot.length)return!0;var t,n=d();for(t=0;t<e.toPlot.length;t++)if(angular.equals(e.toPlot[t],n))return!1;for(t=0;t<e.toPlot.length;t++)if(n.color===e.toPlot[t].color)return!1;return!0},e.addToPlot=function(){e.canAddToPlot()&&(e.toPlot.push(d()),e.selection.color<e.colors.length?e.selection.color++:e.selection.color=0,u())},e.removeFromPlot=function(t){e.toPlot.splice(t,1),u()};var p,g,f="getSiteLevelData",h={getSiteLevelData:{dataFunc:function(e){return e.mean_first_yes_doy},firstYesYearFunc:function(e){return e.mean_first_yes_year}},getSummarizedData:{dataFunc:function(e){return e.first_yes_doy},firstYesYearFunc:function(e){return e.first_yes_year}}},m=i.getFilter().getDateArg(),v=m.arg.start_date,y=new Date(v,0),b=(m.arg.end_date,o.getSizeInfo({top:80,left:60})),w=d3.scale.linear().range([0,b.width]).domain([0,100]),x=d3.svg.axis().scale(w).orient("bottom").tickFormat(c),k=d3.scale.linear().range([b.height,0]).domain([1,365]),_=d3.time.format("%x"),S=function(e){var t=(e-1)*o.ONE_DAY_MILLIS+y.getTime(),n=new Date(t);return _(n)},$=d3.svg.axis().scale(k).orient("left");function C(){var e=d3.select(".chart");e.selectAll(".axis path").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),e.selectAll(".axis line").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),e.selectAll("text").style("font-family","Arial"),e.selectAll(".legend rect").style("fill","white").style("stroke","black").style("opacity","0.8");var t="14px";e.selectAll(".legend text").style("font-size",t).attr("y",function(e,t){return 12*t+t}),e.selectAll("g .x.axis text").style("font-size",t),e.selectAll("g .y.axis text").style("font-size",t);e.selectAll(".legend circle").attr("r","5").attr("cx","5").attr("cy",function(e,t){return 14*t-5})}function F(){if(p){e.working=!0;var t=p.filter(function(t){return-9999!=t[e.selection.axis.key]});w.domain([d3.min(t,u)-1,d3.max(t,u)+1]),x.scale(w).tickFormat(d3.format(".2f"));var n=g.selectAll("g .x.axis");n.call(x.tickFormat(c)),n.selectAll(".axis-label").remove(),n.append("text").attr("class","axis-label").attr("x",b.width/2).attr("dy","3em").style("text-anchor","middle").style("font-size","12px").text(e.selection.axis.label);var a=g.selectAll(".circle").data(t,function(e){return e.id});a.exit().remove(),a.enter().append("circle").attr("class","circle").style("stroke","#333").style("stroke-width","1");var i=h[f].dataFunc;a.attr("cx",function(t){return w(t[e.selection.axis.key])}).attr("cy",function(e){return k(i(e))}).attr("r","5").attr("fill",function(e){return e.color}).on("click",function(t){d3.event.defaultPrevented||e.$apply(function(){e.record=t})}).append("title").text(function(e){return S(e.day_in_range)+" ["+e.latitude+","+e.longitude+"]"});var s=[],l=d3.format(".2f");angular.forEach(e.toPlot,function(n){var a=e.colorRange[n.color],c=t.filter(function(e){return e.color===a});if(c.length>0){var d=c.sort(function(t,n){return t[e.selection.axis.key]-n[e.selection.axis.key]}),u=d.map(function(t){return t[e.selection.axis.key]}).filter(angular.isNumber),p=d.map(i).filter(angular.isNumber),g=o.leastSquares(u,p),f=u[0],h=o.approxY(g,f),m=u[u.length-1],v=o.approxY(g,m);s.push({id:n.species_id+"."+n.phenophase_id,legend:r("speciesTitle")(n)+"/"+n.phenophase_name+(e.selection.regressionLines&&!isNaN(g[2])?" (R^2 = "+l(g[2])+")":""),color:a,p1:[f,h],p2:[m,v]})}});var d=g.selectAll(".regression").data(s,function(e){return e.id});d.exit().remove(),d.enter().append("line").attr("class","regression"),d.attr("data-legend",function(e){return e.legend}).attr("x1",function(e){return w(e.p1[0])}).attr("y1",function(e){return k(e.p1[1])}).attr("x2",function(e){return w(e.p2[0])}).attr("y2",function(e){return k(e.p2[1])}).attr("fill",function(e){return e.color}).attr("stroke",function(e){return e.color}).attr("stroke-width",e.selection.regressionLines?2:0),g.select(".legend").remove();g.append("g").attr("class","legend").attr("transform","translate(30,-45)").style("font-size","1em").call(d3.legend);e.selection.regressionLines&&g.selectAll(".legend text").html(function(e){return e.key.replace("R^2",'R<tspan style="baseline-shift: super; font-size: 8px;">2</tspan>')}),C(),e.working=!1}function u(t){return t[e.selection.axis.key]}}function L(t){return function(){if(p=h[f=t].data)return F();var n=h[f].dataFunc,r=h[f].firstYesYearFunc;e.working=!0,a.debug("visualize",e.selection.axis,e.toPlot);var s=i.getFilter().getDateArg(),l={climate_data:1,request_src:"npn-vis-scatter-plot",start_date:s.getStartDate(),end_date:s.getEndDate()},c=0,d={};angular.forEach(e.toPlot,function(e){d[e.species_id+"."+e.phenophase_id]=e.color,l["species_id["+c+"]"]=e.species_id,l["phenophase_id["+c+++"]"]=e.phenophase_id}),o[t](l,function(t,i){a.log("y tho"),a.log(t),e.data=p=t.filter(function(t,a){var i=!0;return t.color=e.colorRange[d[t.species_id+"."+t.phenophase_id]],t.color?(t.id=a,t.fyy=r(t),angular.forEach({daylength:"mean_daylength",acc_prcp:"mean_accum_prcp",gdd:"mean_gdd"},function(e,n){void 0===t[n]&&(t[n]=t[e])}),t.day_in_range=365*(t.fyy-v)+n(t)):i=!1,i}),e.data=h[f].data=p,e.filteredDisclaimer=i,a.debug("scatterPlot data",p),F()})}}n(function(){var e=d3.select(".chart").attr("width",b.width+b.margin.left+b.margin.right).attr("height",b.height+b.margin.top+b.margin.bottom);e.append("g").append("rect").attr("width","100%").attr("height","100%").attr("fill","#fff"),g=e.append("g").attr("transform","translate("+b.margin.left+","+b.margin.top+")");var t=i.getFilter().getDateArg();g.append("g").attr("class","chart-title").append("text").attr("y","0").attr("dy","-3em").attr("x",b.width/2).style("text-anchor","middle").style("font-size","18px").text(t.getStartYear()+" - "+t.getEndYear()),g.append("g").attr("class","x axis").attr("transform","translate(0,"+b.height+")").call(x),g.append("g").attr("class","y axis").call($).append("text").attr("transform","rotate(-90)").attr("y","0").attr("dy","-3em").attr("x",b.height/2*-1).style("text-anchor","middle").text("Onset Day of Year"),e.append("g").append("text").attr("dx",5).attr("dy",b.height+136).attr("font-size","11px").attr("font-style","italic").attr("text-anchor","right").text("USA National Phenology Network, www.usanpn.org"),C()},500);var A=L("getSiteLevelData"),M=L("getSummarizedData");e.$watch("selection.useIndividualPhenometrics",function(t){delete e.data,e.visualize=t?M:A})}]),angular.module("npn-viz-tool.settings",["npn-viz-tool.filters"]).factory("SettingsService",[function(){var e={clusterMarkers:{name:"cluster-markers",q:"cm",value:!0},tagSpeciesTitle:{name:"tag-species-title",q:"tst",value:"common-name",options:[{value:"common-name",q:"cn",label:"Common Name"},{value:"scientific-name",q:"sn",label:"Scientific Name"}]},tagBadgeFormat:{name:"tag-badge-format",q:"tbf",value:"observation-count",options:[{value:"observation-count",q:"oc",label:"Record Count"},{value:"station-count",q:"sc",label:"Site Count"}]},filterLqdSummary:{name:"filter-lqd-summary",q:"flqdf",value:!0},onlyYesData:{name:"only-yes-data",q:"oyd",value:!1},dataPrecisionFilter:{name:"filter-data-precision",q:"fdp",value:30,options:[7,14,30]}};return{getSettings:function(){return e},getSetting:function(t){return e[t]},getSettingValue:function(t){return e[t].value},getSettingValueLabel:function(t){var n,r=e[t],a=r.value;for(n=0;r.options&&n<r.options.length;n++)if(r.options[n].value===a)return r.options[n].label},getSharingUrlArgs:function(){var t,n,r,a="";for(t in e)if(n=e[t],a+=(""!==a?";":"")+n.q+"=",n.options){for(r=0;r<n.options.length;r++)if(n.value===n.options[r].value){a+=n.options[r].q;break}}else a+=n.value;return"ss="+encodeURIComponent(a)},populateFromSharingUrlArgs:function(t){t&&t.split(";").forEach(function(t){var n,r,a=t.split("="),i=a[0],o=a[1];for(n in e)if(e[n].q===i){if(e[n].options){for(r=0;r<e[n].options.length;r++)if(e[n].options[r].q===o){e[n].value=e[n].options[r].value;break}}else e[n].value="true"===o||"false"===o?"true"===o:o;break}})}}}]).directive("settingsControl",["$rootScope","$location","$log","SettingsService",function(e,t,n,r){return{restrict:"E",templateUrl:"js/settings/settingsControl.html",link:function(a){function i(t){a.$watch("settings."+t+".value",function(r,i){var o;o=t,n.debug("broadcastSettingChange",a.settings[o]),e.$broadcast("setting-update-"+o,a.settings[o])})}r.populateFromSharingUrlArgs(t.search().ss),a.settings=r.getSettings();for(var o in a.settings)i(o)}}}]),angular.module("npn-viz-tool.share",["npn-viz-tool.filter","npn-viz-tool.layers","npn-viz-tool.gridded","npn-viz-tool.settings","uiGmapgoogle-maps"]).directive("shareControl",["uiGmapIsReady","FilterService","LayerService","DateFilterArg","SpeciesFilterArg","NetworkFilterArg","GeoFilterArg","BoundsFilterArg","$location","$log","SettingsService","GriddedControlService",function(e,t,n,r,a,i,o,s,l,c,d,u){return{restrict:"E",template:'<a title="Share" href id="share-control" class="btn btn-default btn-xs" ng-disabled="!getFilter().hasSufficientCriteria() && !gridSelected()" ng-click="share()"><i class="fa fa-share"></i></a><div ng-show="url" id="share-content"><input type="text" class="form-control" ng-model="url" ng-blur="url = null" onClick="this.setSelectionRange(0, this.value.length)"/></div>',scope:{},link:function(n){t.pause(),e.promise(1).then(function(e){var o,d,u,p=e[0],g=l.search(),f=0,h=0,m=0,v=0,y=!1;function b(){y&&h===f&&m===v&&(c.debug("ready.."),o(),d(),u(),t.resume())}if(o=n.$on("layers-ready",function(e,t){c.debug("layers ready..."),y=!0,b()}),d=n.$on("species-filter-ready",function(e,t){c.debug("species filter ready...",t),h++,b()}),u=n.$on("network-filter-ready",function(e,t){c.debug("network filter ready...",t),v++,b()}),c.debug("qargs",g),g.d&&(g.s||g.n)){if(t.addToFilter(r.fromString(g.d)),g.b&&g.b.split(";").forEach(function(e){t.addToFilter(s.fromString(e,p.map))}),g.s){var w=g.s.split(";");f=w.length,w.forEach(function(e){a.fromString(e).then(t.addToFilter)})}if(g.n){var x=g.n.split(";");m=x.length,x.forEach(function(e){i.fromString(e).then(t.addToFilter)})}}else t.resume()}),n.gridSelected=function(){return u.layer},n.getFilter=t.getFilter,n.share=function(){if(n.url)n.url=null;else{var e={},r=l.absUrl(),a=r.indexOf("?");if(!t.isFilterEmpty()){var i=t.getFilter();e.d=i.getDateArg().toString(),i.getSpeciesArgs().forEach(function(t){e.s?e.s+=";"+t.toString():e.s=t.toString()}),i.getNetworkArgs().forEach(function(t){e.n?e.n+=";"+t.toString():e.n=t.toString()}),i.getGeoArgs().forEach(function(t){e.g?e.g+=";"+t.toString():e.g=t.toString()}),i.getBoundsArgs().forEach(function(t){e.b?e.b+=";"+t.toString():e.b=t.toString()})}u.addSharingUrlArgs(e),-1!=a&&(r=r.substring(0,a)),r+=-1===r.indexOf("#")?"#?":"?",Object.keys(e).forEach(function(t,n){r+=(n>0?"&":"")+t+"="+encodeURIComponent(e[t])}),r+="&"+d.getSharingUrlArgs(),c.debug("absUrl",r),n.url=r}}}}}]),angular.module("npn-viz-tool.stations",["npn-viz-tool.filter","npn-viz-tool.vis-cache","npn-viz-tool.cluster","npn-viz-tool.settings","npn-viz-tool.layers","npn-viz-tool.vis"]).factory("StationService",["$rootScope","$http","$log","$url","FilterService","ChartService",function(e,t,n,r,a,i){var o,s={click:function(s){n.debug("click",s),o&&(o.close(),o=void 0),n.debug("Fetching info for station "+s.model.station_id),t.get(r("/npn_portal/stations/getStationDetails.json"),{params:{ids:s.model.station_id}}).then(function(t){var r=t.data;function l(e,t){return t&&""!==t?"<li><label>"+e+":</label> "+t+"</li>":""}if(r&&1===r.length){var c=r[0],d='<div class="station-details">';n.debug(c),d+='<ul class="list-unstyled">',d+=l("Site Name",c.site_name),d+=l("Group",c.group_name),s.model.observationCount?d+=l("Records",s.model.observationCount):(d+=l("Individuals",c.num_individuals),d+=l("Records",c.num_records)),d+="</ul>",s.model.speciesInfo&&(d+="<label>Species Observed</label>",d+='<ul class="list-unstyled">',Object.keys(s.model.speciesInfo.titles).forEach(function(e){var t=a.getChoroplethScale(e),n=s.model.speciesInfo.counts[e];d+='<li><div class="choropleth-swatch" style="background-color: '+t(n)+';"></div>'+s.model.speciesInfo.titles[e]+" ("+n+")</li>"}),d+="</ul>"),d+="</div>";var u=$.parseHTML(d)[0];if(!a.isFilterEmpty()){i.getVisualizations();d="<div>",d+="<label>Visualize Site Data</label>",d+='<ul class="list-unstyled">',i.getVisualizations().forEach(function(e){(void 0===e.singleStation||e.singleStation)&&(d+="<li>",d+='<a id="'+e.controller+'" href="#">'+e.title+"</a>",d+="</li>")}),d+="</ul></div>";var p=$.parseHTML(d)[0];$(u).append(p),i.getVisualizations().forEach(function(t){$(u).find("#"+t.controller).click(function(){e.$apply(function(){i.openSingleStationVisualization(s.model.station_id,t)})})})}(o=new google.maps.InfoWindow({maxWidth:500,content:u})).open(s.map,s)}})}};return{getMarkerEvents:function(){return s}}}]).directive("npnStations",["$http","$log","$timeout","$url","LayerService","SettingsService","StationService","ClusterService","CacheService",function(e,t,n,r,a,i,o,s,l){return{restrict:"E",template:'<ui-gmap-markers models="regions.markers" idKey="\'name\'" coords="\'self\'" icon="\'icon\'" options="\'markerOpts\'" isLabel="true"></ui-gmap-markers><ui-gmap-markers models="stations.markers" idKey="\'station_id\'" coords="\'self\'" icon="\'icon\'" options="\'markerOpts\'" doCluster="doCluster" events="markerEvents" clusterOptions="clusterOptions"></ui-gmap-markers>',scope:{},controller:["$scope",function(c){c.doCluster=i.getSettingValue("clusterMarkers"),c.$on("setting-update-clusterMarkers",function(e,t){c.doCluster=t.value});var d=s.getDefaultClusterOptions();c.clusterOptions=angular.extend(d,{calculator:function(e,t){for(var n={text:e.length,index:1},r=0;r<d.styles.length;r++)e.length>=d.styles[r].n&&(n.index=r+1);return n}}),c.regions={markers:[]},c.stations={states:[],markers:[]},c.markerEvents=o.getMarkerEvents();var u=[],p=l.get("stations-counts-by-state");function g(i){var o=i.reduce(function(e,t){return e[t.state]=t,t.number_stations=parseInt(t.number_stations),e.$min=Math.min(e.$min,t.number_stations),e.$max=Math.max(e.$max,t.number_stations),e},{$max:0,$min:0}),s=d3.scale.linear().domain([o.$min,o.$max]).range(["#F7FBFF","#08306B"]);a.resetLayers().then(function(){a.loadLayer("primary",function(e){var n=e.getProperty("NAME"),r=-1!=c.stations.states.indexOf(n),a=o[n],i={strokeOpacity:1,strokeColor:"#ffffff",strokeWeight:1,fillOpacity:0};if(a&&!r){a.visited=!0,i.fillOpacity=.8,i.fillColor=s(a.number_stations),i.clickable=!0;var l=e.getProperty("CENTER"),d=angular.extend({name:n,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:"#000",fillOpacity:.5,scale:16,strokeColor:"#ccc",strokeWeight:1},markerOpts:{title:n+" ("+a.number_stations+" Sites)",labelClass:"station-count",labelContent:""+a.number_stations}},l);a.number_stations<10?(d.icon.scale=8,d.markerOpts.labelAnchor="4 8"):a.number_stations<100?(d.icon.scale=12,d.markerOpts.labelAnchor="8 8"):a.number_stations<1e3?(d.icon.scale=14,d.markerOpts.labelAnchor="10 8"):d.markerOpts.labelAnchor="13 8",c.$apply(function(){c.regions.markers.push(d)})}else r||t.warn("no station count for "+n);return i}).then(function(t){var a=t[0];u.push(a.data.addListener("mouseover",function(e){a.data.overrideStyle(e.feature,{strokeWeight:3})})),u.push(a.data.addListener("mouseout",function(e){a.data.revertStyle()})),u.push(a.data.addListener("click",function(t){var i=t.feature.getProperty("NAME");-1===c.stations.states.indexOf(i)&&(c.regions.markers=c.regions.markers.filter(function(e){return e.name!==i}),c.stations.states.push(i),n(function(){a.data.remove(t.feature),a.panTo(t.latLng);var o=0;6!=a.getZoom()&&(a.setZoom(6),o=500),n(function(){e.get(r("/npn_portal/stations/getAllStations.json"),{params:{state_code:i}}).then(function(e){var t=e.data;t.forEach(function(e){e.markerOpts={title:e.station_name,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:"#e6550d",fillOpacity:1,scale:8,strokeColor:"#204d74",strokeWeight:1}}});var n,r=c.stations.markers.concat(t),a=r.length>512?Math.round(r.length/2):512;for(n=d.styles.length-1;n>=0;n--)d.styles[n].n=a,a=Math.round(a/2);c.stations.markers=r})},o)},500))}))})})}p?g(p):e.get(r("/npn_portal/stations/getStationCountByState.json")).then(function(e){var t=e.data;l.put("stations-counts-by-state",t),g(t)}),c.$on("$destroy",function(){a.resetLayers(),u.forEach(function(e){e.remove()})})}]}}]),angular.module("npn-viz-tool.vis-time",["npn-viz-tool.vis","npn-viz-tool.filter","npn-viz-tool.filters","npn-viz-tool.settings","ui.bootstrap"]).controller("TimeSeriesVisCtrl",["$scope","$uibModalInstance","$log","$filter","$http","$url","$q","$timeout","layer","legend","latLng","ChartService",function(e,t,n,r,a,i,o,s,l,c,d,u){e.layer=l,e.legend=c,e.modal=t,e.latLng=d;var p,g,f="yyyy-MM-dd",h=r("date"),m=r("number"),v=(new Date).getFullYear(),y=l.extent.current&&l.extent.current.date?l.extent.current.date.getFullYear():v,b=((g=new Date).setFullYear(y),g.setMonth(0),g.setDate(1),g),w=y===v,x=(p=w?new Date(l.extent.values[l.extent.values.length-1].date.getTime()):new Date,w||(p.setFullYear(y),p.setMonth(11),p.setDate(31)),p),k={latitude:d.lat(),longitude:d.lng()},_={layer:l.name,start_date:h(b,f),end_date:h(x,f),latitude:d.lat(),longitude:d.lng()};k.layer="gdd:agdd"===_.layer?"gdd:30yr_avg_agdd":"gdd:30yr_avg_agdd_50f";var S="gdd:agdd"===_.layer?32:50;n.debug("TimeSeries.avg_params",k),n.debug("TimeSeries.params",_);var $,C,F,L=u.getSizeInfo({top:80,left:80}),A=d3.time.format("%m/%d"),M=function(e){var t=(e-1)*u.ONE_DAY_MILLIS+b.getTime(),n=new Date(t);return A(n)},D=d3.time.format("%b %-d"),T=d3.scale.linear().range([0,L.width]).domain([1,365]),E=d3.svg.axis().scale(T).orient("bottom").tickFormat(M),P=2e4,z=d3.scale.linear().range([L.height,0]).domain([0,P]),I=d3.svg.axis().scale(z).orient("left"),O=function(e){return e.point_value},j=function(e){return e.doy},Y=d3.svg.line().x(function(e,t){return T(e.doy)}).y(function(e,t){return z(e.point_value)}).interpolate("basis"),N={};function B(e,t){N[e]=t,N[e].doyMap=N[e].data.reduce(function(e,t){return e[j(t)]=O(t),e},{})}function R(){$.selectAll(".axis path").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),$.selectAll(".axis line").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),$.selectAll("text").style("font-family","Arial");$.selectAll("g .x.axis text").style("font-size","16px"),$.selectAll("g .y.axis text").style("font-size","16px")}function G(){$.select(".legend").remove();var e=$.append("g").attr("class","legend").attr("transform","translate(30,-45)").style("font-size","1em"),t=e.append("rect").style("fill","white").style("stroke","black").style("opacity","0.8").attr("width",130).attr("height",60),n=["average","selected","forecast","previous"].reduce(function(t,n,r){var a;return N[n]&&N[n].plotted&&(N[n].filtered||N[n].data).length&&((a=e.append("g").attr("class","legend-item "+n).attr("transform","translate(10,"+(14*(t+1)+4*t)+")")).append("circle").attr("r",5).attr("fill",N[n].color),a.append("text").style("font-size","14px").attr("x",10).attr("y",2.5).text(N[n].year||"30-year Average"),t++),t},0);n<3?t.attr("height",45):n>3&&t.attr("height",80)}function V(e){N[e]&&($.selectAll("path.gdd."+e).remove(),delete N[e].plotted,G())}function q(e){N[e]&&($.append("path").attr("class","gdd "+e).attr("fill","none").attr("stroke",N[e].color).attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1.5).attr("d",Y(N[e].filtered||N[e].data)),N[e].plotted=!0,G())}function U(){var t=z(e.selection.threshold.value);C.attr("y1",t).attr("y2",t)}function W(){var t,n=Object.keys(N);n.length&&(t=n.reduce(function(e,t){return e.push(d3.max(N[t].filtered||N[t].data,O)),e},[]),e.selection.threshold.options.ceil=Math.round(P=d3.max(t)),e.selection.threshold.value>e.selection.threshold.options.ceil&&(e.selection.threshold.value=e.selection.threshold.options.ceil),P*=1.05,I.scale(z.domain([0,P])),U(),E.scale(T.domain([1,e.selection.doys.value])),n.forEach(function(e){N[e].plotted&&(V(e),q(e))})),$.selectAll("g .axis").remove(),$.append("g").attr("class","y axis").call(I).append("text").attr("transform","rotate(-90)").attr("y","0").attr("dy","-3.75em").attr("x",L.height/2*-1).style("text-anchor","middle").text("Accumulated Growing Degree Days"),$.append("g").attr("class","x axis").attr("transform","translate(0,"+L.height+")").call(E).append("text").attr("y","0").attr("dy","2.5em").attr("x",L.width/2).style("text-anchor","middle").text("Date"),R()}function H(){var t=e.selection.doys.value;365===t?Object.keys(N).forEach(function(e){delete N[e].filtered}):Object.keys(N).forEach(function(e){N[e].filtered=N[e].data.filter(function(e){return j(e)<=t})}),W()}e.selection={lastYearValid:y>2016,showLastYear:!1,threshold:{value:"Hemlock Woolly Adelgid"===l.pest?1e3:"Emerald Ash Borer"===l.pest?450:"Winter Moth"===l.pest?20:"Lilac Borer"===l.pest?500:"Apple Maggot"===l.pest?900:1e3,options:{floor:0,ceil:P,step:10,translate:function(e){return m(e,0)+"°F"}}},doys:{value:function(){var e=new Date(l.extent.current.date.getTime());if(e.getMonth()>10||!l.pest)return 365;e.setMonth(e.getMonth()+1);var t=new Date(e.getFullYear(),0,0),n=e-t+60*(t.getTimezoneOffset()-e.getTimezoneOffset())*1e3;return Math.floor(n/864e5)}(),options:{floor:1,ceil:365,step:1,translate:function(e){return t=(e-1)*u.ONE_DAY_MILLIS+b.getTime(),n=new Date(t),D(n)+" ("+e+")";var t,n}}}},s(function(){e.$broadcast("rzSliderForceRender");var t=d3.select(".chart").attr("width",L.width+L.margin.left+L.margin.right).attr("height",L.height+L.margin.top+L.margin.bottom);t.append("g").append("rect").attr("width","100%").attr("height","100%").attr("fill","#fff");var r=($=t.append("g").attr("transform","translate("+L.margin.left+","+L.margin.top+")")).append("g").attr("class","chart-title");r.append("text").attr("y","0").attr("dy","-3em").attr("x",L.width/2).style("text-anchor","middle").style("font-size","18px").text("Accumulated Growing Degree Days"),r.append("text").attr("y","0").attr("dy","-1.8em").attr("x",L.width/2).style("text-anchor","middle").style("font-size","18px").text("(Lat: "+m(d.lat())+", Lon: "+m(d.lng())+") "+S+"°F Base Temp"),W(),t.append("g").append("text").attr("dx",5).attr("dy",L.height+136).attr("font-size","11px").attr("font-style","italic").attr("text-anchor","right").text("USA National Phenology Network, www.usanpn.org"),C=$.append("line").attr("class","threshold").attr("fill","none").attr("stroke","green").attr("stroke-width",1).attr("x1",T(1)).attr("y1",z(P)).attr("x2",T(365)).attr("y2",z(P));var s=t.append("g").attr("transform","translate("+L.margin.left+","+L.margin.top+")").style("display","none"),l=s.append("line").attr("class","focus").attr("fill","none").attr("stroke","green").attr("stroke-width",1).attr("x1",T(1)).attr("y1",z(0)).attr("x2",T(1)).attr("y2",z(P)),c=s.append("text").attr("class","gdd-info").attr("font-size",16).attr("y",40),u=c.append("tspan").attr("dy","1em").attr("x",15),p=(u.append("tspan").attr("class","gdd-label").text("DOY: "),u.append("tspan").attr("class","gdd-value")),g=["average","previous","selected","forecast"],f=g.reduce(function(e,t){return e[t]=c.append("tspan").attr("dy","1.2em").attr("x",15),e},{}),v=g.reduce(function(e,t){return e[t]=f[t].append("tspan").attr("class","gdd-label "+t),e},{}),y=g.reduce(function(e,t){return e[t]=f[t].append("tspan").attr("class","gdd-value"),e},{}),x=["previous","forecast","selected"].reduce(function(e,t){return e[t]=f[t].append("tspan").attr("class","gdd-diff"),e},{});t.append("rect").attr("class","overlay").attr("transform","translate("+L.margin.left+","+L.margin.top+")").style("fill","none").style("pointer-events","all").attr("x",0).attr("y",0).attr("width",T(365)).attr("height",z(0)).on("mouseover",function(){s.style("display",null)}).on("mouseout",function(){s.style("display","none")}).on("mousemove",function(){var e,t=d3.mouse(this),r=t[0],a=(t[1],Math.round(T.invert(r))),i=Object.keys(N);l.attr("transform","translate("+r+")"),e=i.reduce(function(e,t){var n;return N[t].plotted&&(void 0!==(n=N[t].doyMap[a])?(e[t]={year:N[t].year,gdd:n},N[t].focus||(N[t].focus=s.append("circle").attr("r",4.5).attr("fill","none").attr("stroke","steelblue")),N[t].focus.style("display",null).attr("transform","translate("+r+","+z(n)+")")):N[t].focus&&N[t].focus.style("display","none")),e},{}),n.debug("temps for doy "+a,e),p.text(a+" ("+M(a)+")"),Object.keys(f).forEach(function(t){var n,r,i,o,s,l;if(e[t]){if(f[t].style("display",null),v[t].text((e[t].year||"30-year Average")+": "),n=e[t].gdd,y[t].text(m(n,0)+" GDD"),x[t]){for(s=" ("+((r=n-e.average.gdd)>0?"+":"")+m(r,0)+" GDD",l=0;l<N.average.data.length;l++)if(O(N.average.data[l])>n){i=j(N.average.data[l]);break}i>0&&i<366&&(s+="/"+((o=i-a)>0?"+":"")+o+" days"),s+=")",x[t].attr("class","gdd-diff "+(r>0?"above":"below")).text(s)}}else f[t].style("display","none")})}),R(),e.$watch("selection.threshold.value",U),e.working=!0,o.all({average:a.get(i("/npn_portal/stations/getTimeSeries.json"),{params:k}),selected:a.get(i("/npn_portal/stations/getTimeSeries.json"),{params:_})}).then(function(t){if(w){var r=h(new Date,"yyyy-MM-dd"),a=t.selected.data.reduce(function(e,t){return e.forecast?e.forecast.push(t):(e.selected.push(t),t.date===r&&(e.forecast=[t])),e},{selected:[]});B("selected",{year:b.getFullYear(),color:"blue",data:a.selected}),B("forecast",{year:b.getFullYear()+" forecast",color:"red",data:a.forecast})}else B("selected",{year:b.getFullYear(),color:"blue",data:t.selected.data});B("average",{color:"black",data:t.average.data}),n.debug("draw",N),H(),W(),q("average"),q("selected"),w&&q("forecast"),R(),delete e.working})}),e.$watch("selection.doys.value",function(e,t){e!==t&&(F&&s.cancel(F),F=s(H,500))}),e.selection.lastYearValid&&e.$watch("selection.showLastYear",function(t){if(t&&!N.previous){e.working=!0;var r,o=new Date(b.getTime()),s=new Date(b.getTime());o.setFullYear(o.getFullYear()-1),s.setFullYear(o.getFullYear()),s.setMonth(11),s.setDate(31),r=angular.extend({},_,{start_date:h(o,f),end_date:h(s,f)}),n.debug("previous_params",r),a.get(i("/npn_portal/stations/getTimeSeries.json"),{params:r}).then(function(t){B("previous",{year:o.getFullYear(),color:"orange",data:t.data}),H(),W(),R(),q("previous"),delete e.working})}else N.previous&&(t?q("previous"):V("previous"))})}]).provider("$timeSeriesVis",[function(){this.$get=["ChartService",function(e){return function(t,n,r){e.openVisualization({title:"Daily Accumulation",noFilterRequired:!0,template:"js/time/time.html",controller:"TimeSeriesVisCtrl"},{layer:function(){return t},legend:function(){return n},latLng:function(){return r}})}}]}]),angular.module("npn-viz-tool.toolbar",["npn-viz-tool.help"]).directive("toolbar",["$rootScope","$timeout","HelpService",function(e,t,n){return{restrict:"E",templateUrl:"js/toolbar/toolbar.html",transclude:!0,scope:{},controller:["$scope",function(r){var a=r.tools=[];function i(n){e.$broadcast("tool-"+(n.selected?"open":"close"),{tool:n}),n.selected&&t(function(){e.$broadcast("rzSliderForceRender")},500)}r.select=function(e){e.selected=!e.selected,r.open=e.selected,n.stopLookingAtMe("#toolbar-icon-"+e.id),i(e)},this.addTool=function(e){a.push(e)},this.closeTool=function(e){r.open=e.selected=!1,i(e)}}]}}]).directive("tool",[function(){return{restrict:"E",require:"^toolbar",templateUrl:"js/toolbar/tool.html",transclude:!0,scope:{id:"@",title:"@",icon:"@"},link:function(e,t,n,r){r.addTool(e),e.close=function(){r.closeTool(e)}}}}]),angular.module("npn-viz-tool.vis",["npn-viz-tool.filter","npn-viz-tool.filters","npn-viz-tool.vis-scatter","npn-viz-tool.vis-calendar","npn-viz-tool.vis-map","npn-viz-tool.vis-time","npn-viz-tool.vis-activity","ui.bootstrap"]).factory("ChartService",["$window","$http","$log","$uibModal","$url","FilterService","SettingsService","Analytics",function(e,t,n,r,a,i,o,s){var l,c={top:20,right:30,bottom:60,left:40},d=[{title:"Scatter Plots",controller:"ScatterVisCtrl",template:"js/scatter/scatter.html",description:"This visualization plots selected geographic or seasonal climatic variables against estimated onset dates at a site to region for individuals or sites for up to three species, phenophases or years."},{title:"Calendars",controller:"CalendarVisCtrl",template:"js/calendar/calendar.html",description:"This visualization illustrates the daily timing of phenological activity for selected species and phenophases. Horizontal bars represent the annual patterns at a site to region for up to two years."},{title:"Activity Curves",controller:"ActivityCurvesVisCtrl",template:"js/activity/activity.html",description:"This visualization plots annual patterns of the timing and magnitude of phenological activity, based on proportion of “yes” records, animal abundances per hour and other metrics. Data are summarized at a weekly, biweekly or monthly scale for one or more sites,  for up to two species, phenophases, or years."},{title:"Maps",controller:"MapVisCtrl",template:"js/mapvis/mapvis.html",description:"This visualization maps ground-based observations overlaid with USA-NPN phenology maps, including Accumulated Growing Degree Days and Spring Index models.",singleStation:!1}];function u(e){var t=0===e.latitude||0===e.longitude||e.elevation_in_meters<0;return t&&n.warn("suspect station data",e),!t}function p(e){var t=e.numdays_since_prior_no>=0;return t||n.debug("filtering less precise data from summary output",e),t}function g(e){var t=e.mean_numdays_since_prior_no>=0;return t||n.debug("filtering less precise data from site level output",e),t}function f(e){if(l)e["station_id[0]"]=l;else{var t=i.getFilter();t.getGeographicArgs().length&&i.getFilteredMarkers().forEach(function(t,n){e["station_id["+n+"]"]=t.station_id}),t.getNetworkArgs().forEach(function(t,n){e["network["+n+"]"]=t.getName(),e["network_id["+n+"]"]=t.getId()})}return e}function h(e){var t,n=[];for(t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&")}function m(e){l=e}var v={ONE_DAY_MILLIS:864e5,getSizeInfo:function(t){var r=angular.extend({},c,t),a=Math.round(.9*e.innerWidth),i=Math.round(.5376*a),o={width:a-r.left-r.right,height:i-r.top-r.bottom,margin:r};return n.debug("sizing",o),o},leastSquares:function(e,t){if(0===e.length||0===t.length)return[Number.NaN,Number.NaN,Number.NaN];var n=function(e,t){return e+t},r=1*e.reduce(n)/e.length,a=1*t.reduce(n)/t.length,i=e.map(function(e){return Math.pow(e-r,2)}).reduce(n),o=t.map(function(e){return Math.pow(e-a,2)}).reduce(n),s=e.map(function(e,n){return(e-r)*(t[n]-a)}).reduce(n),l=s/i;return[l,a-r*l,Math.pow(s,2)/(i*o)]},approxY:function(e,t){return e[1]+e[0]*t},getMagnitudeData:function(e,n){t({method:"POST",url:a("/npn_portal/observations/getMagnitudeData.json"),headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:h,data:f(e)}).then(function(e){n(e.data)})},getSiteLevelData:function(e,r){e.num_days_quality_filter=o.getSettingValue("dataPrecisionFilter"),t({method:"POST",url:a("/npn_portal/observations/getSiteLevelData.json"),headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:h,data:f(e)}).then(function(e){var t=e.data,a=t.filter(u),i=a.filter(o.getSettingValue("filterLqdSummary")?g:angular.identity);n.debug("filtered out "+(t.length-a.length)+"/"+t.length+" suspect records"),n.debug("filtered out "+(a.length-i.length)+"/"+a.length+" LQD records."),r(i,a.length!==i.length)})},getSummarizedData:function(e,r){t({method:"POST",url:a("/npn_portal/observations/getSummarizedData.json"),headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:h,data:f(e)}).then(function(e){var t=e.data,a=t.filter(u),i=a.filter(o.getSettingValue("filterLqdSummary")?p:angular.identity),s=i.reduce(function(e,t){var n=t.individual_id+"/"+t.phenophase_id+"/"+t.first_yes_year;return e[n]=e[n]||[],e[n].push(t),e},{}),l=[];n.debug("filtered out "+(t.length-a.length)+"/"+t.length+" suspect records"),n.debug("filtered out "+(a.length-i.length)+"/"+a.length+" LQD records."),angular.forEach(s,function(e,t){e.length>1&&e.sort(function(e,t){return e.first_yes_doy-t.first_yes_doy}),l.push(e[0])}),n.debug("filtered out "+(i.length-l.length)+"/"+i.length+" individual records (preferring lowest first_yes_doy)"),r(l,a.length!==i.length)})},getObservationDates:function(e,n){t({method:"POST",url:a("/npn_portal/observations/getObservationDates.json"),headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:h,data:f(e)}).then(function(e){n(e.data)})},isFilterEmpty:i.isFilterEmpty,getVisualizations:function(){return d},openSingleStationVisualization:function(e,t){m(e);var n=v.openVisualization(t);n?n.result.then(m,m):m()},openVisualization:function(e,t){if(e.noFilterRequired||!i.isFilterEmpty()){var n={templateUrl:e.template,controller:e.controller,windowClass:"vis-dialog-window",backdrop:"static",keyboard:!1,size:"lg"};return t&&(n.resolve=t),s.trackEvent("visualization","open",e.title),r.open(n)}}};return v}]).directive("visDialog",[function(){return{restrict:"E",templateUrl:"js/vis/visDialog.html",transclude:!0,scope:{title:"@",modal:"="},controller:["$scope",function(e){}]}}]).directive("visControl",["ChartService",function(e){return{restrict:"E",templateUrl:"js/vis/visControl.html",scope:{},link:function(t){t.isFilterEmpty=e.isFilterEmpty,t.open=e.openVisualization,t.visualizations=e.getVisualizations()}}}]).directive("visDownload",[function(){return{restrict:"E",templateUrl:"js/vis/visDownload.html",scope:{selector:"@",filename:"@"},controller:["$scope",function(e){e.download=function(){var t=d3.select(e.selector),n=t.attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML,r=document.querySelector("#visDownloadCanvas");r.width=t.attr("width"),r.height=t.attr("height");var a=encodeURIComponent(n).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}),i="data:image/svg+xml;base64,"+window.btoa(a),o=r.getContext("2d"),s=new Image;s.onload=function(){o.drawImage(s,0,0);var t=r.toDataURL("image/png"),n=$("#vis-download-link")[0];n.download=e.filename||"visualization.png",n.href=t,n.click()},s.src=i}}]}}]);